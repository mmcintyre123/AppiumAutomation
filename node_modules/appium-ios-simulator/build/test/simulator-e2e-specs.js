require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireWildcard = require('babel-runtime/helpers/interop-require-wildcard')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _ = require('..');

var _nodeSimctl = require('node-simctl');

var simctl = _interopRequireWildcard(_nodeSimctl);

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _appiumSupport = require('appium-support');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _sampleApps = require('sample-apps');

var _sampleApps2 = _interopRequireDefault(_sampleApps);

var _asyncbox = require('asyncbox');

var LONG_TIMEOUT = 240 * 1000;

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

function runTests(deviceType) {
  describe('simulator ' + deviceType.version, function () {
    this.timeout(LONG_TIMEOUT);
    var udid = undefined;
    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.killAllSimulators)());

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    beforeEach(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(simctl.createDevice('ios-simulator testing', deviceType.device, deviceType.version, 20000));

          case 2:
            udid = context$3$0.sent;

            // just need a little more space in the logs
            console.log('\n\n'); // eslint-disable-line no-console

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
    afterEach(function callee$2$0() {
      var devicePresent;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(simctl.getDevices());

          case 2:
            context$3$0.t0 = deviceType.version;

            context$3$0.t1 = function (device) {
              return device.udid === udid;
            };

            context$3$0.t2 = context$3$0.sent[context$3$0.t0].filter(context$3$0.t1).length;
            devicePresent = context$3$0.t2 > 0;

            if (!devicePresent) {
              context$3$0.next = 11;
              break;
            }

            context$3$0.next = 9;
            return _regeneratorRuntime.awrap((0, _.killAllSimulators)());

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(simctl.deleteDevice(udid));

          case 11:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    function installApp(udid, app) {
      return _regeneratorRuntime.async(function installApp$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(simctl.installApp(udid, app));

          case 2:
            if (!process.env.TRAVIS) {
              context$3$0.next = 5;
              break;
            }

            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(5000));

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    }

    it('should detect whether a simulator has been run before', function callee$2$0() {
      var sim;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.isFresh().should.eventually.equal(true));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(sim.launchAndQuit());

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(sim.isFresh().should.eventually.equal(false));

          case 9:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should launch and shutdown a sim', function callee$2$0() {
      var sim;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.launchAndQuit());

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(sim.stat());

          case 7:
            context$3$0.sent.state.should.equal('Shutdown');

          case 8:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should launch and shutdown a sim, also starting safari', function callee$2$0() {
      var sim;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.launchAndQuit(true));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(sim.stat());

          case 7:
            context$3$0.sent.state.should.equal('Shutdown');

          case 8:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should clean a sim', function callee$2$0() {
      var sim;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.isFresh().should.eventually.equal(true));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(sim.launchAndQuit());

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(sim.isFresh().should.eventually.equal(false));

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(sim.clean());

          case 11:
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap(sim.isFresh().should.eventually.equal(true));

          case 13:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should not find any TestApp data or bundle directories on a fresh simulator', function callee$2$0() {
      var sim, dirs;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.getAppDirs('TestApp', 'io.appium.TestApp'));

          case 5:
            dirs = context$3$0.sent;

            dirs.should.have.length(0);

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should find both a data and bundle directory for TestApp', function callee$2$0() {
      var sim, dirs;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.run());

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(installApp(udid, (0, _sampleApps2['default'])('TestApp')));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(simctl.launch(udid, 'io.appium.TestApp'));

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(sim.getAppDirs('TestApp', 'io.appium.TestApp'));

          case 11:
            dirs = context$3$0.sent;

            dirs.should.have.length(2);
            dirs[0].should.contain('/Data/');
            dirs[1].should.contain('/Bundle/');

          case 15:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should be able to delete an app', function callee$2$0() {
      var sim, error;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        var _this = this;

        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.run());

          case 5:
            error = /The operation couldnâ€™t be completed/;

            if (parseInt(process.env.DEVICE, 10) >= 10) {
              error = /The request was denied by service delegate/;
            }

            // install & launch test app
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(installApp(udid, (0, _sampleApps2['default'])('TestApp')));

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(5, 1000, function callee$3$0() {
              return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                while (1) switch (context$4$0.prev = context$4$0.next) {
                  case 0:
                    context$4$0.next = 2;
                    return _regeneratorRuntime.awrap(simctl.launch(udid, 'io.appium.TestApp', 1));

                  case 2:
                  case 'end':
                    return context$4$0.stop();
                }
              }, null, _this);
            }));

          case 11:

            console.log('Application installed and launched'); // eslint-disable-line no-console

            context$3$0.next = 14;
            return _regeneratorRuntime.awrap(sim.removeApp('io.appium.TestApp'));

          case 14:
            context$3$0.next = 16;
            return _regeneratorRuntime.awrap(simctl.launch(udid, 'io.appium.TestApp', 1).should.eventually.be.rejectedWith(error));

          case 16:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should delete custom app data', function callee$2$0() {
      var sim, dirs;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        var _this2 = this;

        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.run());

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(installApp(udid, (0, _sampleApps2['default'])('TestApp')));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(5, 1000, function callee$3$0() {
              return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                while (1) switch (context$4$0.prev = context$4$0.next) {
                  case 0:
                    context$4$0.next = 2;
                    return _regeneratorRuntime.awrap(simctl.launch(udid, 'io.appium.TestApp', 1));

                  case 2:
                  case 'end':
                    return context$4$0.stop();
                }
              }, null, _this2);
            }));

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(sim.cleanCustomApp('TestApp', 'io.appium.TestApp'));

          case 11:

            // clear paths to force the simulator to get a new list of directories
            sim.appDataBundlePaths = {};

            context$3$0.next = 14;
            return _regeneratorRuntime.awrap(sim.getAppDirs('TestApp', 'io.appium.TestApp'));

          case 14:
            dirs = context$3$0.sent;

            dirs.should.have.length(0);

          case 16:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should delete a sim', function callee$2$0() {
      var numDevices, sim, numDevicesAfter;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(simctl.getDevices());

          case 2:
            context$3$0.t0 = deviceType.version;
            numDevices = context$3$0.sent[context$3$0.t0].length;

            numDevices.should.be.above(0);

            context$3$0.next = 7;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 7:
            sim = context$3$0.sent;
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap(sim['delete']());

          case 10:
            context$3$0.next = 12;
            return _regeneratorRuntime.awrap(simctl.getDevices());

          case 12:
            context$3$0.t1 = deviceType.version;
            numDevicesAfter = context$3$0.sent[context$3$0.t1].length;

            numDevicesAfter.should.equal(numDevices - 1);

          case 15:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    var itText = 'should match a bundleId to its app directory on a used sim';
    var bundleId = 'com.apple.mobilesafari';
    if (deviceType.version === '7.1') {
      itText = 'should match an app to its app directory on a used sim';
      bundleId = 'MobileSafari';
    }
    it(itText, function callee$2$0() {
      var sim, path;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.launchAndQuit());

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(sim.getAppDir(bundleId));

          case 7:
            path = context$3$0.sent;
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(path).should.eventually.be['true']);

          case 10:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    itText = 'should match a bundleId to its app directory on a fresh sim';
    bundleId = 'com.apple.mobilesafari';
    if (deviceType.version === '7.1') {
      itText = 'should match an app to its app directory on a fresh sim';
      bundleId = 'MobileSafari';
    }
    it(itText, function callee$2$0() {
      var sim, path;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.getAppDir(bundleId));

          case 5:
            path = context$3$0.sent;
            context$3$0.next = 8;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(path).should.eventually.be['true']);

          case 8:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should start a sim using the "run" method', function callee$2$0() {
      var sim, stat;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.run());

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(sim.stat());

          case 7:
            stat = context$3$0.sent;

            stat.state.should.equal('Booted');

            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(sim.shutdown());

          case 11:
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap(sim.stat());

          case 13:
            stat = context$3$0.sent;

            stat.state.should.equal('Shutdown');

          case 15:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should be able to start safari', function callee$2$0() {
      var sim;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.run());

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(sim.openUrl('http://apple.com'));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(sim.shutdown());

          case 9:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    // this test to catch errors in openUrl, that arise from bad sims or certain versions of xcode
    it('should detect if a sim is running', function callee$2$0() {
      var sim, running;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.isRunning());

          case 5:
            running = context$3$0.sent;

            running.should.be['false'];

            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(sim.run());

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(sim.isRunning());

          case 11:
            running = context$3$0.sent;

            running.should.be['true'];

            context$3$0.next = 15;
            return _regeneratorRuntime.awrap(sim.shutdown());

          case 15:
            context$3$0.next = 17;
            return _regeneratorRuntime.awrap(sim.isRunning());

          case 17:
            running = context$3$0.sent;

            running.should.be['false'];

          case 19:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should isolate sim', function callee$2$0() {
      var sim, numDevices;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 2:
            sim = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(sim.isolateSim());

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(simctl.getDevices());

          case 7:
            context$3$0.t0 = deviceType.version;
            numDevices = context$3$0.sent[context$3$0.t0].length;

            numDevices.should.equal(1);

          case 10:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
  });

  describe('reuse an already-created already-run simulator ' + deviceType.version, function () {
    this.timeout(LONG_TIMEOUT);
    var sim = undefined;
    before(function callee$2$0() {
      var udid;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.killAllSimulators)());

          case 2:
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(simctl.createDevice('ios-simulator testing', deviceType.device, deviceType.version));

          case 4:
            udid = context$3$0.sent;
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap((0, _.getSimulator)(udid));

          case 7:
            sim = context$3$0.sent;
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap(sim.run());

          case 10:
            context$3$0.next = 12;
            return _regeneratorRuntime.awrap(sim.shutdown());

          case 12:
            context$3$0.next = 14;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(4000));

          case 14:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
    after(function callee$2$0() {
      var devicePresent;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(simctl.getDevices());

          case 2:
            context$3$0.t0 = deviceType.version;

            context$3$0.t1 = function (device) {
              return device.udid === sim.udid;
            };

            context$3$0.t2 = context$3$0.sent[context$3$0.t0].filter(context$3$0.t1).length;
            devicePresent = context$3$0.t2 > 0;

            if (!devicePresent) {
              context$3$0.next = 9;
              break;
            }

            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(simctl.deleteDevice(sim.udid));

          case 9:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should start a sim using the "run" method', function callee$2$0() {
      var stat;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(sim.run());

          case 2:
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(sim.stat());

          case 4:
            stat = context$3$0.sent;

            stat.state.should.equal('Booted');

            context$3$0.next = 8;
            return _regeneratorRuntime.awrap(sim.shutdown());

          case 8:
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap(sim.stat());

          case 10:
            stat = context$3$0.sent;

            stat.state.should.equal('Shutdown');

          case 12:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
  });
}

var deviceTypes = undefined;
if (!process.env.TRAVIS && !process.env.DEVICE) {
  console.log('Not on TRAVIS, testing all versions'); // eslint-disable-line no-console
  deviceTypes = [{
    version: '9.2',
    device: 'iPhone 6s'
  }, {
    version: '9.3',
    device: 'iPhone 6s'
  }, {
    version: '9.0',
    device: 'iPhone 6s'
  }, {
    version: '9.1',
    device: 'iPhone 6s'
  }];
} else {
  // on travis, we want to just do what we specify
  // travis also cannot at the moment create 9.0 and 9.1 sims
  // so only do these if testing somewhere else
  if (process.env.DEVICE === '9.3') {
    deviceTypes = [{
      version: '9.3',
      device: 'iPhone 6s'
    }];
  } else if (process.env.DEVICE === '9.2') {
    deviceTypes = [{
      version: '9.2',
      device: 'iPhone 6s'
    }];
  } else if (process.env.DEVICE === '10' || process.env.DEVICE === '10.0') {
    deviceTypes = [{
      version: '10.0',
      device: 'iPhone 6s'
    }];
  }
}

var _iteratorNormalCompletion = true;
var _didIteratorError = false;
var _iteratorError = undefined;

try {
  for (var _iterator = _getIterator(deviceTypes), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
    var deviceType = _step.value;

    runTests(deviceType);
  }
} catch (err) {
  _didIteratorError = true;
  _iteratorError = err;
} finally {
  try {
    if (!_iteratorNormalCompletion && _iterator['return']) {
      _iterator['return']();
    }
  } finally {
    if (_didIteratorError) {
      throw _iteratorError;
    }
  }
}

// only want to get rid of the device if it is present

// install & launch test app

// this remains somewhat flakey

// should not be able to launch anymore

// install & launch test app

// this remains somewhat flakey

// delete app directories

// only want to get rid of the device if it is present
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3Qvc2ltdWxhdG9yLWUyZS1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Z0JBRWdELElBQUk7OzBCQUM1QixhQUFhOztJQUF6QixNQUFNOztvQkFDRCxNQUFNOzs7OzhCQUNJLGtCQUFrQjs7Ozs2QkFDMUIsZ0JBQWdCOzt3QkFDckIsVUFBVTs7OzswQkFDRCxhQUFhOzs7O3dCQUNOLFVBQVU7O0FBR3hDLElBQU0sWUFBWSxHQUFHLEdBQUcsR0FBQyxJQUFJLENBQUM7O0FBRTlCLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQ2Qsa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQzs7QUFFekIsU0FBUyxRQUFRLENBQUUsVUFBVSxFQUFFO0FBQzdCLFVBQVEsZ0JBQWMsVUFBVSxDQUFDLE9BQU8sRUFBSSxZQUFZO0FBQ3RELFFBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDM0IsUUFBSSxJQUFJLFlBQUEsQ0FBQztBQUNULFVBQU0sQ0FBQzs7Ozs7NkNBQ0MsMEJBQW1COzs7Ozs7O0tBQzFCLENBQUMsQ0FBQzs7QUFFSCxjQUFVLENBQUM7Ozs7OzZDQUNJLE1BQU0sQ0FBQyxZQUFZLENBQUMsdUJBQXVCLEVBQ3ZCLFVBQVUsQ0FBQyxNQUFNLEVBQ2pCLFVBQVUsQ0FBQyxPQUFPLEVBQ2xCLEtBQUssQ0FBQzs7O0FBSHZDLGdCQUFJOzs7QUFLSixtQkFBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQzs7Ozs7OztLQUNyQixDQUFDLENBQUM7QUFDSCxhQUFTLENBQUM7VUFFSixhQUFhOzs7Ozs2Q0FBVSxNQUFNLENBQUMsVUFBVSxFQUFFOzs7NkJBQUUsVUFBVSxDQUFDLE9BQU87OzZCQUN4RCxVQUFDLE1BQU0sRUFBSztBQUNsQixxQkFBTyxNQUFNLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQzthQUM3Qjs7OERBRkEsTUFBTSxpQkFFSixNQUFNO0FBSFAseUJBQWEsb0JBR0gsQ0FBQzs7aUJBQ1gsYUFB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QUFLLEVBQUU7QUFDaEMsZUFBVyxHQUFHLENBQ1o7QUFDRSxhQUFPLEVBQUUsS0FBSztBQUNkLFlBQU0sRUFBRSxXQUFXO0tBQ3BCLENBQ0YsQ0FBQztHQUNILE1BQU0sSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sS0FBSyxLQUFLLEVBQUU7QUFDdkMsZUFBVyxHQUFHLENBQ1o7QUFDRSxhQUFPLEVBQUUsS0FBSztBQUNkLFlBQU0sRUFBRSxXQUFXO0tBQ3BCLENBQ0YsQ0FBQztHQUNILE1BQU0sSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sS0FBSyxJQUFJLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEtBQUssTUFBTSxFQUFFO0FBQ3ZFLGVBQVcsR0FBRyxDQUNaO0FBQ0UsYUFBTyxFQUFFLE1BQU07QUFDZixZQUFNLEVBQUUsV0FBVztLQUNwQixDQUNGLENBQUM7R0FDSDtDQUNGOzs7Ozs7O0FBRUQsb0NBQXVCLFdBQVcsNEdBQUU7UUFBM0IsVUFBVTs7QUFDakIsWUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0dBQ3RCIiwiZmlsZSI6InRlc3Qvc2ltdWxhdG9yLWUyZS1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptb2NoYVxuXG5pbXBvcnQgeyBnZXRTaW11bGF0b3IsIGtpbGxBbGxTaW11bGF0b3JzIH0gZnJvbSAnLi4nO1xuaW1wb3J0ICogYXMgc2ltY3RsIGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgZ2V0QXBwUGF0aCBmcm9tICdzYW1wbGUtYXBwcyc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuXG5cbmNvbnN0IExPTkdfVElNRU9VVCA9IDI0MCoxMDAwO1xuXG5jaGFpLnNob3VsZCgpO1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG5mdW5jdGlvbiBydW5UZXN0cyAoZGV2aWNlVHlwZSkge1xuICBkZXNjcmliZShgc2ltdWxhdG9yICR7ZGV2aWNlVHlwZS52ZXJzaW9ufWAsIGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnRpbWVvdXQoTE9OR19USU1FT1VUKTtcbiAgICBsZXQgdWRpZDtcbiAgICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgYXdhaXQga2lsbEFsbFNpbXVsYXRvcnMoKTtcbiAgICB9KTtcblxuICAgIGJlZm9yZUVhY2goYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgdWRpZCA9IGF3YWl0IHNpbWN0bC5jcmVhdGVEZXZpY2UoJ2lvcy1zaW11bGF0b3IgdGVzdGluZycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VUeXBlLmRldmljZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZVR5cGUudmVyc2lvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIwMDAwKTtcbiAgICAgIC8vIGp1c3QgbmVlZCBhIGxpdHRsZSBtb3JlIHNwYWNlIGluIHRoZSBsb2dzXG4gICAgICBjb25zb2xlLmxvZygnXFxuXFxuJyk7ICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGVcbiAgICB9KTtcbiAgICBhZnRlckVhY2goYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgLy8gb25seSB3YW50IHRvIGdldCByaWQgb2YgdGhlIGRldmljZSBpZiBpdCBpcyBwcmVzZW50XG4gICAgICBsZXQgZGV2aWNlUHJlc2VudCA9IChhd2FpdCBzaW1jdGwuZ2V0RGV2aWNlcygpKVtkZXZpY2VUeXBlLnZlcnNpb25dXG4gICAgICAgIC5maWx0ZXIoKGRldmljZSkgPT4ge1xuICAgICAgICAgIHJldHVybiBkZXZpY2UudWRpZCA9PT0gdWRpZDtcbiAgICAgICAgfSkubGVuZ3RoID4gMDtcbiAgICAgIGlmIChkZXZpY2VQcmVzZW50KSB7XG4gICAgICAgIGF3YWl0IGtpbGxBbGxTaW11bGF0b3JzKCk7XG4gICAgICAgIGF3YWl0IHNpbWN0bC5kZWxldGVEZXZpY2UodWRpZCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBhc3luYyBmdW5jdGlvbiBpbnN0YWxsQXBwICh1ZGlkLCBhcHApIHtcbiAgICAgIGF3YWl0IHNpbWN0bC5pbnN0YWxsQXBwKHVkaWQsIGFwcCk7XG4gICAgICBpZiAocHJvY2Vzcy5lbnYuVFJBVklTKSB7XG4gICAgICAgIGF3YWl0IEIuZGVsYXkoNTAwMCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaXQoJ3Nob3VsZCBkZXRlY3Qgd2hldGhlciBhIHNpbXVsYXRvciBoYXMgYmVlbiBydW4gYmVmb3JlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHNpbSA9IGF3YWl0IGdldFNpbXVsYXRvcih1ZGlkKTtcbiAgICAgIGF3YWl0IHNpbS5pc0ZyZXNoKCkuc2hvdWxkLmV2ZW50dWFsbHkuZXF1YWwodHJ1ZSk7XG4gICAgICBhd2FpdCBzaW0ubGF1bmNoQW5kUXVpdCgpO1xuICAgICAgYXdhaXQgc2ltLmlzRnJlc2goKS5zaG91bGQuZXZlbnR1YWxseS5lcXVhbChmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGxhdW5jaCBhbmQgc2h1dGRvd24gYSBzaW0nLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgc2ltID0gYXdhaXQgZ2V0U2ltdWxhdG9yKHVkaWQpO1xuICAgICAgYXdhaXQgc2ltLmxhdW5jaEFuZFF1aXQoKTtcbiAgICAgIChhd2FpdCBzaW0uc3RhdCgpKS5zdGF0ZS5zaG91bGQuZXF1YWwoJ1NodXRkb3duJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGxhdW5jaCBhbmQgc2h1dGRvd24gYSBzaW0sIGFsc28gc3RhcnRpbmcgc2FmYXJpJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHNpbSA9IGF3YWl0IGdldFNpbXVsYXRvcih1ZGlkKTtcbiAgICAgIGF3YWl0IHNpbS5sYXVuY2hBbmRRdWl0KHRydWUpO1xuICAgICAgKGF3YWl0IHNpbS5zdGF0KCkpLnN0YXRlLnNob3VsZC5lcXVhbCgnU2h1dGRvd24nKTtcbiAgICB9KTtcblxuXG4gICAgaXQoJ3Nob3VsZCBjbGVhbiBhIHNpbScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBzaW0gPSBhd2FpdCBnZXRTaW11bGF0b3IodWRpZCk7XG4gICAgICBhd2FpdCBzaW0uaXNGcmVzaCgpLnNob3VsZC5ldmVudHVhbGx5LmVxdWFsKHRydWUpO1xuICAgICAgYXdhaXQgc2ltLmxhdW5jaEFuZFF1aXQoKTtcbiAgICAgIGF3YWl0IHNpbS5pc0ZyZXNoKCkuc2hvdWxkLmV2ZW50dWFsbHkuZXF1YWwoZmFsc2UpO1xuICAgICAgYXdhaXQgc2ltLmNsZWFuKCk7XG4gICAgICBhd2FpdCBzaW0uaXNGcmVzaCgpLnNob3VsZC5ldmVudHVhbGx5LmVxdWFsKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBub3QgZmluZCBhbnkgVGVzdEFwcCBkYXRhIG9yIGJ1bmRsZSBkaXJlY3RvcmllcyBvbiBhIGZyZXNoIHNpbXVsYXRvcicsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBzaW0gPSBhd2FpdCBnZXRTaW11bGF0b3IodWRpZCk7XG4gICAgICBsZXQgZGlycyA9IGF3YWl0IHNpbS5nZXRBcHBEaXJzKCdUZXN0QXBwJywgJ2lvLmFwcGl1bS5UZXN0QXBwJyk7XG4gICAgICBkaXJzLnNob3VsZC5oYXZlLmxlbmd0aCgwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZmluZCBib3RoIGEgZGF0YSBhbmQgYnVuZGxlIGRpcmVjdG9yeSBmb3IgVGVzdEFwcCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBzaW0gPSBhd2FpdCBnZXRTaW11bGF0b3IodWRpZCk7XG4gICAgICBhd2FpdCBzaW0ucnVuKCk7XG5cbiAgICAgIC8vIGluc3RhbGwgJiBsYXVuY2ggdGVzdCBhcHBcbiAgICAgIGF3YWl0IGluc3RhbGxBcHAodWRpZCwgZ2V0QXBwUGF0aCgnVGVzdEFwcCcpKTtcbiAgICAgIGF3YWl0IHNpbWN0bC5sYXVuY2godWRpZCwgJ2lvLmFwcGl1bS5UZXN0QXBwJyk7XG5cbiAgICAgIGxldCBkaXJzID0gYXdhaXQgc2ltLmdldEFwcERpcnMoJ1Rlc3RBcHAnLCAnaW8uYXBwaXVtLlRlc3RBcHAnKTtcbiAgICAgIGRpcnMuc2hvdWxkLmhhdmUubGVuZ3RoKDIpO1xuICAgICAgZGlyc1swXS5zaG91bGQuY29udGFpbignL0RhdGEvJyk7XG4gICAgICBkaXJzWzFdLnNob3VsZC5jb250YWluKCcvQnVuZGxlLycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBiZSBhYmxlIHRvIGRlbGV0ZSBhbiBhcHAnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgc2ltID0gYXdhaXQgZ2V0U2ltdWxhdG9yKHVkaWQpO1xuICAgICAgYXdhaXQgc2ltLnJ1bigpO1xuXG4gICAgICBsZXQgZXJyb3IgPSAvVGhlIG9wZXJhdGlvbiBjb3VsZG7igJl0IGJlIGNvbXBsZXRlZC87XG4gICAgICBpZiAocGFyc2VJbnQocHJvY2Vzcy5lbnYuREVWSUNFLCAxMCkgPj0gMTApIHtcbiAgICAgICAgZXJyb3IgPSAvVGhlIHJlcXVlc3Qgd2FzIGRlbmllZCBieSBzZXJ2aWNlIGRlbGVnYXRlLztcbiAgICAgIH1cblxuICAgICAgLy8gaW5zdGFsbCAmIGxhdW5jaCB0ZXN0IGFwcFxuICAgICAgYXdhaXQgaW5zdGFsbEFwcCh1ZGlkLCBnZXRBcHBQYXRoKCdUZXN0QXBwJykpO1xuXG4gICAgICAvLyB0aGlzIHJlbWFpbnMgc29tZXdoYXQgZmxha2V5XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKDUsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgc2ltY3RsLmxhdW5jaCh1ZGlkLCAnaW8uYXBwaXVtLlRlc3RBcHAnLCAxKTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zb2xlLmxvZygnQXBwbGljYXRpb24gaW5zdGFsbGVkIGFuZCBsYXVuY2hlZCcpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGVcblxuICAgICAgYXdhaXQgc2ltLnJlbW92ZUFwcCgnaW8uYXBwaXVtLlRlc3RBcHAnKTtcblxuICAgICAgLy8gc2hvdWxkIG5vdCBiZSBhYmxlIHRvIGxhdW5jaCBhbnltb3JlXG4gICAgICBhd2FpdCBzaW1jdGwubGF1bmNoKHVkaWQsICdpby5hcHBpdW0uVGVzdEFwcCcsIDEpXG4gICAgICAgIC5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoZXJyb3IpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBkZWxldGUgY3VzdG9tIGFwcCBkYXRhJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHNpbSA9IGF3YWl0IGdldFNpbXVsYXRvcih1ZGlkKTtcbiAgICAgIGF3YWl0IHNpbS5ydW4oKTtcblxuICAgICAgLy8gaW5zdGFsbCAmIGxhdW5jaCB0ZXN0IGFwcFxuICAgICAgYXdhaXQgaW5zdGFsbEFwcCh1ZGlkLCBnZXRBcHBQYXRoKCdUZXN0QXBwJykpO1xuXG4gICAgICAvLyB0aGlzIHJlbWFpbnMgc29tZXdoYXQgZmxha2V5XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKDUsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgc2ltY3RsLmxhdW5jaCh1ZGlkLCAnaW8uYXBwaXVtLlRlc3RBcHAnLCAxKTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBkZWxldGUgYXBwIGRpcmVjdG9yaWVzXG4gICAgICBhd2FpdCBzaW0uY2xlYW5DdXN0b21BcHAoJ1Rlc3RBcHAnLCAnaW8uYXBwaXVtLlRlc3RBcHAnKTtcblxuICAgICAgLy8gY2xlYXIgcGF0aHMgdG8gZm9yY2UgdGhlIHNpbXVsYXRvciB0byBnZXQgYSBuZXcgbGlzdCBvZiBkaXJlY3Rvcmllc1xuICAgICAgc2ltLmFwcERhdGFCdW5kbGVQYXRocyA9IHt9O1xuXG4gICAgICBsZXQgZGlycyA9IGF3YWl0IHNpbS5nZXRBcHBEaXJzKCdUZXN0QXBwJywgJ2lvLmFwcGl1bS5UZXN0QXBwJyk7XG4gICAgICBkaXJzLnNob3VsZC5oYXZlLmxlbmd0aCgwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZGVsZXRlIGEgc2ltJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IG51bURldmljZXMgPSAoYXdhaXQgc2ltY3RsLmdldERldmljZXMoKSlbZGV2aWNlVHlwZS52ZXJzaW9uXS5sZW5ndGg7XG4gICAgICBudW1EZXZpY2VzLnNob3VsZC5iZS5hYm92ZSgwKTtcblxuICAgICAgbGV0IHNpbSA9IGF3YWl0IGdldFNpbXVsYXRvcih1ZGlkKTtcbiAgICAgIGF3YWl0IHNpbS5kZWxldGUoKTtcbiAgICAgIGxldCBudW1EZXZpY2VzQWZ0ZXIgPSAoYXdhaXQgc2ltY3RsLmdldERldmljZXMoKSlbZGV2aWNlVHlwZS52ZXJzaW9uXS5sZW5ndGg7XG4gICAgICBudW1EZXZpY2VzQWZ0ZXIuc2hvdWxkLmVxdWFsKG51bURldmljZXMtMSk7XG4gICAgfSk7XG5cbiAgICBsZXQgaXRUZXh0ID0gJ3Nob3VsZCBtYXRjaCBhIGJ1bmRsZUlkIHRvIGl0cyBhcHAgZGlyZWN0b3J5IG9uIGEgdXNlZCBzaW0nO1xuICAgIGxldCBidW5kbGVJZCA9ICdjb20uYXBwbGUubW9iaWxlc2FmYXJpJztcbiAgICBpZiAoZGV2aWNlVHlwZS52ZXJzaW9uID09PSAnNy4xJykge1xuICAgICAgaXRUZXh0ID0gJ3Nob3VsZCBtYXRjaCBhbiBhcHAgdG8gaXRzIGFwcCBkaXJlY3Rvcnkgb24gYSB1c2VkIHNpbSc7XG4gICAgICBidW5kbGVJZCA9ICdNb2JpbGVTYWZhcmknO1xuICAgIH1cbiAgICBpdChpdFRleHQsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBzaW0gPSBhd2FpdCBnZXRTaW11bGF0b3IodWRpZCk7XG4gICAgICBhd2FpdCBzaW0ubGF1bmNoQW5kUXVpdCgpO1xuXG4gICAgICBsZXQgcGF0aCA9IGF3YWl0IHNpbS5nZXRBcHBEaXIoYnVuZGxlSWQpO1xuICAgICAgYXdhaXQgZnMuaGFzQWNjZXNzKHBhdGgpLnNob3VsZC5ldmVudHVhbGx5LmJlLnRydWU7XG4gICAgfSk7XG5cbiAgICBpdFRleHQgPSAnc2hvdWxkIG1hdGNoIGEgYnVuZGxlSWQgdG8gaXRzIGFwcCBkaXJlY3Rvcnkgb24gYSBmcmVzaCBzaW0nO1xuICAgIGJ1bmRsZUlkID0gJ2NvbS5hcHBsZS5tb2JpbGVzYWZhcmknO1xuICAgIGlmIChkZXZpY2VUeXBlLnZlcnNpb24gPT09ICc3LjEnKSB7XG4gICAgICBpdFRleHQgPSAnc2hvdWxkIG1hdGNoIGFuIGFwcCB0byBpdHMgYXBwIGRpcmVjdG9yeSBvbiBhIGZyZXNoIHNpbSc7XG4gICAgICBidW5kbGVJZCA9ICdNb2JpbGVTYWZhcmknO1xuICAgIH1cbiAgICBpdChpdFRleHQsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBzaW0gPSBhd2FpdCBnZXRTaW11bGF0b3IodWRpZCk7XG4gICAgICBsZXQgcGF0aCA9IGF3YWl0IHNpbS5nZXRBcHBEaXIoYnVuZGxlSWQpO1xuICAgICAgYXdhaXQgZnMuaGFzQWNjZXNzKHBhdGgpLnNob3VsZC5ldmVudHVhbGx5LmJlLnRydWU7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHN0YXJ0IGEgc2ltIHVzaW5nIHRoZSBcInJ1blwiIG1ldGhvZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBzaW0gPSBhd2FpdCBnZXRTaW11bGF0b3IodWRpZCk7XG5cbiAgICAgIGF3YWl0IHNpbS5ydW4oKTtcblxuICAgICAgbGV0IHN0YXQgPSBhd2FpdCBzaW0uc3RhdCgpO1xuICAgICAgc3RhdC5zdGF0ZS5zaG91bGQuZXF1YWwoJ0Jvb3RlZCcpO1xuXG4gICAgICBhd2FpdCBzaW0uc2h1dGRvd24oKTtcbiAgICAgIHN0YXQgPSBhd2FpdCBzaW0uc3RhdCgpO1xuICAgICAgc3RhdC5zdGF0ZS5zaG91bGQuZXF1YWwoJ1NodXRkb3duJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gc3RhcnQgc2FmYXJpJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHNpbSA9IGF3YWl0IGdldFNpbXVsYXRvcih1ZGlkKTtcblxuICAgICAgYXdhaXQgc2ltLnJ1bigpO1xuICAgICAgYXdhaXQgc2ltLm9wZW5VcmwoJ2h0dHA6Ly9hcHBsZS5jb20nKTtcbiAgICAgIGF3YWl0IHNpbS5zaHV0ZG93bigpO1xuXG4gICAgICAvLyB0aGlzIHRlc3QgdG8gY2F0Y2ggZXJyb3JzIGluIG9wZW5VcmwsIHRoYXQgYXJpc2UgZnJvbSBiYWQgc2ltcyBvciBjZXJ0YWluIHZlcnNpb25zIG9mIHhjb2RlXG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGRldGVjdCBpZiBhIHNpbSBpcyBydW5uaW5nJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHNpbSA9IGF3YWl0IGdldFNpbXVsYXRvcih1ZGlkKTtcbiAgICAgIGxldCBydW5uaW5nID0gYXdhaXQgc2ltLmlzUnVubmluZygpO1xuICAgICAgcnVubmluZy5zaG91bGQuYmUuZmFsc2U7XG5cbiAgICAgIGF3YWl0IHNpbS5ydW4oKTtcbiAgICAgIHJ1bm5pbmcgPSBhd2FpdCBzaW0uaXNSdW5uaW5nKCk7XG4gICAgICBydW5uaW5nLnNob3VsZC5iZS50cnVlO1xuXG4gICAgICBhd2FpdCBzaW0uc2h1dGRvd24oKTtcbiAgICAgIHJ1bm5pbmcgPSBhd2FpdCBzaW0uaXNSdW5uaW5nKCk7XG4gICAgICBydW5uaW5nLnNob3VsZC5iZS5mYWxzZTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaXNvbGF0ZSBzaW0nLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgc2ltID0gYXdhaXQgZ2V0U2ltdWxhdG9yKHVkaWQpO1xuICAgICAgYXdhaXQgc2ltLmlzb2xhdGVTaW0oKTtcblxuICAgICAgbGV0IG51bURldmljZXMgPSAoYXdhaXQgc2ltY3RsLmdldERldmljZXMoKSlbZGV2aWNlVHlwZS52ZXJzaW9uXS5sZW5ndGg7XG5cbiAgICAgIG51bURldmljZXMuc2hvdWxkLmVxdWFsKDEpO1xuICAgIH0pO1xuXG4gIH0pO1xuXG4gIGRlc2NyaWJlKGByZXVzZSBhbiBhbHJlYWR5LWNyZWF0ZWQgYWxyZWFkeS1ydW4gc2ltdWxhdG9yICR7ZGV2aWNlVHlwZS52ZXJzaW9ufWAsIGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnRpbWVvdXQoTE9OR19USU1FT1VUKTtcbiAgICBsZXQgc2ltO1xuICAgIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBhd2FpdCBraWxsQWxsU2ltdWxhdG9ycygpO1xuICAgICAgbGV0IHVkaWQgPSBhd2FpdCBzaW1jdGwuY3JlYXRlRGV2aWNlKCdpb3Mtc2ltdWxhdG9yIHRlc3RpbmcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlVHlwZS5kZXZpY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VUeXBlLnZlcnNpb24pO1xuICAgICAgc2ltID0gYXdhaXQgZ2V0U2ltdWxhdG9yKHVkaWQpO1xuICAgICAgYXdhaXQgc2ltLnJ1bigpO1xuICAgICAgYXdhaXQgc2ltLnNodXRkb3duKCk7XG4gICAgICBhd2FpdCBCLmRlbGF5KDQwMDApO1xuICAgIH0pO1xuICAgIGFmdGVyKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vIG9ubHkgd2FudCB0byBnZXQgcmlkIG9mIHRoZSBkZXZpY2UgaWYgaXQgaXMgcHJlc2VudFxuICAgICAgbGV0IGRldmljZVByZXNlbnQgPSAoYXdhaXQgc2ltY3RsLmdldERldmljZXMoKSlbZGV2aWNlVHlwZS52ZXJzaW9uXVxuICAgICAgICAuZmlsdGVyKChkZXZpY2UpID0+IHtcbiAgICAgICAgICByZXR1cm4gZGV2aWNlLnVkaWQgPT09IHNpbS51ZGlkO1xuICAgICAgICB9KS5sZW5ndGggPiAwO1xuICAgICAgaWYgKGRldmljZVByZXNlbnQpIHtcbiAgICAgICAgYXdhaXQgc2ltY3RsLmRlbGV0ZURldmljZShzaW0udWRpZCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHN0YXJ0IGEgc2ltIHVzaW5nIHRoZSBcInJ1blwiIG1ldGhvZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGF3YWl0IHNpbS5ydW4oKTtcblxuICAgICAgbGV0IHN0YXQgPSBhd2FpdCBzaW0uc3RhdCgpO1xuICAgICAgc3RhdC5zdGF0ZS5zaG91bGQuZXF1YWwoJ0Jvb3RlZCcpO1xuXG4gICAgICBhd2FpdCBzaW0uc2h1dGRvd24oKTtcbiAgICAgIHN0YXQgPSBhd2FpdCBzaW0uc3RhdCgpO1xuICAgICAgc3RhdC5zdGF0ZS5zaG91bGQuZXF1YWwoJ1NodXRkb3duJyk7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5cbmxldCBkZXZpY2VUeXBlcztcbmlmICghcHJvY2Vzcy5lbnYuVFJBVklTICYmICFwcm9jZXNzLmVudi5ERVZJQ0UpIHtcbiAgY29uc29sZS5sb2coJ05vdCBvbiBUUkFWSVMsIHRlc3RpbmcgYWxsIHZlcnNpb25zJyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxuICBkZXZpY2VUeXBlcyA9IFtcbiAgICB7XG4gICAgICB2ZXJzaW9uOiAnOS4yJyxcbiAgICAgIGRldmljZTogJ2lQaG9uZSA2cydcbiAgICB9LFxuICAgIHtcbiAgICAgIHZlcnNpb246ICc5LjMnLFxuICAgICAgZGV2aWNlOiAnaVBob25lIDZzJ1xuICAgIH0sXG4gICAge1xuICAgICAgdmVyc2lvbjogJzkuMCcsXG4gICAgICBkZXZpY2U6ICdpUGhvbmUgNnMnXG4gICAgfSxcbiAgICB7XG4gICAgICB2ZXJzaW9uOiAnOS4xJyxcbiAgICAgIGRldmljZTogJ2lQaG9uZSA2cydcbiAgICB9XG4gIF07XG59IGVsc2Uge1xuICAvLyBvbiB0cmF2aXMsIHdlIHdhbnQgdG8ganVzdCBkbyB3aGF0IHdlIHNwZWNpZnlcbiAgLy8gdHJhdmlzIGFsc28gY2Fubm90IGF0IHRoZSBtb21lbnQgY3JlYXRlIDkuMCBhbmQgOS4xIHNpbXNcbiAgLy8gc28gb25seSBkbyB0aGVzZSBpZiB0ZXN0aW5nIHNvbWV3aGVyZSBlbHNlXG4gIGlmIChwcm9jZXNzLmVudi5ERVZJQ0UgPT09ICc5LjMnKSB7XG4gICAgZGV2aWNlVHlwZXMgPSBbXG4gICAgICB7XG4gICAgICAgIHZlcnNpb246ICc5LjMnLFxuICAgICAgICBkZXZpY2U6ICdpUGhvbmUgNnMnXG4gICAgICB9XG4gICAgXTtcbiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5ERVZJQ0UgPT09ICc5LjInKSB7XG4gICAgZGV2aWNlVHlwZXMgPSBbXG4gICAgICB7XG4gICAgICAgIHZlcnNpb246ICc5LjInLFxuICAgICAgICBkZXZpY2U6ICdpUGhvbmUgNnMnXG4gICAgICB9XG4gICAgXTtcbiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5ERVZJQ0UgPT09ICcxMCcgfHwgcHJvY2Vzcy5lbnYuREVWSUNFID09PSAnMTAuMCcpIHtcbiAgICBkZXZpY2VUeXBlcyA9IFtcbiAgICAgIHtcbiAgICAgICAgdmVyc2lvbjogJzEwLjAnLFxuICAgICAgICBkZXZpY2U6ICdpUGhvbmUgNnMnXG4gICAgICB9XG4gICAgXTtcbiAgfVxufVxuXG5mb3IgKGxldCBkZXZpY2VUeXBlIG9mIGRldmljZVR5cGVzKSB7XG4gIHJ1blRlc3RzKGRldmljZVR5cGUpO1xufVxuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9

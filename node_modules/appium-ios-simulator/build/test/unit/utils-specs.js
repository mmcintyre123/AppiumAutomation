require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _interopRequireWildcard = require('babel-runtime/helpers/interop-require-wildcard')['default'];

var _this = this;

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _teen_process = require('teen_process');

var TeenProcess = _interopRequireWildcard(_teen_process);

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _nodeSimctl = require('node-simctl');

var nodeSimctl = _interopRequireWildcard(_nodeSimctl);

var _ = require('../..');

var _assetsDeviceList = require('../assets/deviceList');

var _libSimulatorXcode6 = require('../../lib/simulator-xcode-6');

var _libSimulatorXcode62 = _interopRequireDefault(_libSimulatorXcode6);

var _appiumSupport = require('appium-support');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);
var expect = _chai2['default'].expect;

var XCODE_VERSION_7 = {
  versionString: '7.1.1',
  versionFloat: 7.1,
  major: 7,
  minor: 1,
  patch: 1
};
var XCODE_VERSION_6 = {
  versionString: '6.1.1',
  versionFloat: 6.1,
  major: 6,
  minor: 1,
  patch: 1
};

var assetsDir = process.cwd() + '/test/assets';

describe('util', function () {
  var execStub = undefined;
  var xcodeMock = undefined;
  var getDevicesStub = undefined;

  beforeEach(function () {
    execStub = _sinon2['default'].stub(TeenProcess, 'exec');
    xcodeMock = _sinon2['default'].mock(_appiumXcode2['default']);
    getDevicesStub = _sinon2['default'].stub(nodeSimctl, 'getDevices');
    getDevicesStub.returns(_bluebird2['default'].resolve(_assetsDeviceList.devices));
  });
  afterEach(function () {
    execStub.restore();
    xcodeMock.restore();
    nodeSimctl.getDevices.restore();
  });

  describe('killAllSimulators', function () {
    it('should call exec with Simulator for Xcode 7', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            xcodeMock.expects('getVersion').withArgs(true).returns(_bluebird2['default'].resolve(XCODE_VERSION_7));
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((0, _.killAllSimulators)());

          case 3:
            execStub.calledOnce.should.be['true'];

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should call exec with iOS Simulator for Xcode 6', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            xcodeMock.expects('getVersion').withArgs(true).returns(_bluebird2['default'].resolve(XCODE_VERSION_6));
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((0, _.killAllSimulators)());

          case 3:
            execStub.calledOnce.should.be['true'];

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should continue if application is not running error gets thrown', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            xcodeMock.expects('getVersion').withArgs(true).returns(_bluebird2['default'].resolve(XCODE_VERSION_7));
            execStub.throws('{"stdout":"","stderr":"0:24: execution error: iOS Simulator got an error: Application isnâ€™t running. (-600)\n","code":1}');
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap((0, _.killAllSimulators)());

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });

  describe('endAllSimulatorDaemons', function () {
    it('should call exec five times to stop and remove each service', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _.endAllSimulatorDaemons)());

          case 2:
            execStub.callCount.should.equal(5);

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should ignore all errors', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            execStub.throws();
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((0, _.endAllSimulatorDaemons)().should.not.be.rejected);

          case 3:
            execStub.callCount.should.equal(5);
            execStub.threw().should.be['true'];

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });

  describe('simExists', function () {
    it('returns true if device is found', function callee$2$0() {
      var existence, results, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, result;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            existence = [(0, _.simExists)('C09B34E5-7DCB-442E-B79C-AB6BC0357417'), (0, _.simExists)('FA5C971D-4E05-4AA3-B48B-C9619C7453BE'), (0, _.simExists)('E46EFA59-E2B4-4FF9-B290-B61F3CFECC65'), (0, _.simExists)('F33783B2-9EE9-4A99-866E-E126ADBAD410')];
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(_bluebird2['default'].all(existence));

          case 3:
            results = context$3$0.sent;
            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            context$3$0.prev = 7;

            for (_iterator = _getIterator(results); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
              result = _step.value;

              result.should.be['true'];
            }
            context$3$0.next = 15;
            break;

          case 11:
            context$3$0.prev = 11;
            context$3$0.t0 = context$3$0['catch'](7);
            _didIteratorError = true;
            _iteratorError = context$3$0.t0;

          case 15:
            context$3$0.prev = 15;
            context$3$0.prev = 16;

            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }

          case 18:
            context$3$0.prev = 18;

            if (!_didIteratorError) {
              context$3$0.next = 21;
              break;
            }

            throw _iteratorError;

          case 21:
            return context$3$0.finish(18);

          case 22:
            return context$3$0.finish(15);

          case 23:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this, [[7, 11, 15, 23], [16,, 18, 22]]);
    });

    it('returns false if device is not found', function callee$2$0() {
      var existence, results, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, result;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            existence = [];

            existence.push((0, _.simExists)('A94E4CD7-D412-4198-BCD4-26799672975E'));
            existence.push((0, _.simExists)('asdf'));
            existence.push((0, _.simExists)(4));

            context$3$0.next = 6;
            return _regeneratorRuntime.awrap(_bluebird2['default'].all(existence));

          case 6:
            results = context$3$0.sent;
            _iteratorNormalCompletion2 = true;
            _didIteratorError2 = false;
            _iteratorError2 = undefined;
            context$3$0.prev = 10;

            for (_iterator2 = _getIterator(results); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              result = _step2.value;

              result.should.be['false'];
            }
            context$3$0.next = 18;
            break;

          case 14:
            context$3$0.prev = 14;
            context$3$0.t0 = context$3$0['catch'](10);
            _didIteratorError2 = true;
            _iteratorError2 = context$3$0.t0;

          case 18:
            context$3$0.prev = 18;
            context$3$0.prev = 19;

            if (!_iteratorNormalCompletion2 && _iterator2['return']) {
              _iterator2['return']();
            }

          case 21:
            context$3$0.prev = 21;

            if (!_didIteratorError2) {
              context$3$0.next = 24;
              break;
            }

            throw _iteratorError2;

          case 24:
            return context$3$0.finish(21);

          case 25:
            return context$3$0.finish(18);

          case 26:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this, [[10, 14, 18, 26], [19,, 21, 25]]);
    });
  });
});

describe('installSSLCert and uninstallSSLCert', function () {

  it('should install and uninstall certs in keychain directories', function callee$1$0() {
    var simulatorGetDirStub, testPem, certificate, certExistsInAssetsDir;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          simulatorGetDirStub = _sinon2['default'].stub(_libSimulatorXcode62['default'].prototype, 'getDir', function () {
            return _path2['default'].resolve(assetsDir);
          });
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(_path2['default'].resolve(assetsDir, 'test-pem.pem')));

        case 3:
          testPem = context$2$0.sent;
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap((0, _.installSSLCert)(testPem, 'using mock, udid doesn\'t matter'));

        case 6:
          certificate = context$2$0.sent;
          context$2$0.next = 9;
          return _regeneratorRuntime.awrap(certificate.has(assetsDir));

        case 9:
          certExistsInAssetsDir = context$2$0.sent;

          expect(certExistsInAssetsDir).to.be['true'];
          context$2$0.next = 13;
          return _regeneratorRuntime.awrap((0, _.uninstallSSLCert)(testPem, 'using mock, udid doesn\'t matter'));

        case 13:
          context$2$0.next = 15;
          return _regeneratorRuntime.awrap(certificate.has(assetsDir));

        case 15:
          certExistsInAssetsDir = context$2$0.sent;

          expect(certExistsInAssetsDir).to.be['false'];
          simulatorGetDirStub.restore();

        case 18:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('should throw exception if openssl is unavailable', function callee$1$0() {
    var whichStub;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          whichStub = _sinon2['default'].stub(_appiumSupport.fs, 'which', function () {
            throw 'no openssl';
          });
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap((0, _.installSSLCert)('doesn\'t matter', 'doesn\'t matter').should.be.rejected);

        case 3:
          whichStub.calledOnce.should.be['true'];
          whichStub.restore();

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('should throw exception on installSSLCert if udid is invalid', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _.installSSLCert)('pem dummy text', 'invalid UDID').should.be.rejected);

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('should throw exception on uninstallSSLCert if udid is invalid', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _.uninstallSSLCert)('pem dummy text', 'invalid UDID').should.be.rejected);

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC91dGlscy1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztvQkFFaUIsTUFBTTs7Ozs4QkFDSSxrQkFBa0I7Ozs7cUJBQzNCLE9BQU87Ozs7d0JBQ1gsVUFBVTs7Ozs0QkFDSyxjQUFjOztJQUEvQixXQUFXOzsyQkFDTCxjQUFjOzs7OzBCQUNKLGFBQWE7O0lBQTdCLFVBQVU7O2dCQUNpRixPQUFPOztnQ0FDdEYsc0JBQXNCOztrQ0FDeEIsNkJBQTZCOzs7OzZCQUNoQyxnQkFBZ0I7O29CQUNsQixNQUFNOzs7O0FBRXZCLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQ2Qsa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQztBQUN6QixJQUFNLE1BQU0sR0FBRyxrQkFBSyxNQUFNLENBQUM7O0FBRTNCLElBQU0sZUFBZSxHQUFHO0FBQ3RCLGVBQWEsRUFBRSxPQUFPO0FBQ3RCLGNBQVksRUFBRSxHQUFHO0FBQ2pCLE9BQUssRUFBRSxDQUFDO0FBQ1IsT0FBSyxFQUFFLENBQUM7QUFDUixPQUFLLEVBQUUsQ0FBQztDQUNULENBQUM7QUFDRixJQUFNLGVBQWUsR0FBRztBQUN0QixlQUFhLEVBQUUsT0FBTztBQUN0QixjQUFZLEVBQUUsR0FBRztBQUNqQixPQUFLLEVBQUUsQ0FBQztBQUNSLE9BQUssRUFBRSxDQUFDO0FBQ1IsT0FBSyxFQUFFLENBQUM7Q0FDVCxDQUFDOztBQUdGLElBQUksU0FBUyxHQUFNLE9BQU8sQ0FBQyxHQUFHLEVBQUUsaUJBQWMsQ0FBQzs7QUFFL0MsUUFBUSxDQUFDLE1BQU0sRUFBRSxZQUFNO0FBQ3JCLE1BQUksUUFBUSxZQUFBLENBQUM7QUFDYixNQUFJLFNBQVMsWUFBQSxDQUFDO0FBQ2QsTUFBSSxjQUFjLFlBQUEsQ0FBQzs7QUFFbkIsWUFBVSxDQUFDLFlBQU07QUFDZixZQUFRLEdBQUcsbUJBQU0sSUFBSSxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUMzQyxhQUFTLEdBQUcs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LEdBQUcsQ0FBQyxTQUFTLENBQUM7OztBQUF4RCwrQkFBcUI7O0FBQ3pCLGdCQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxRQUFLLENBQUM7OzJDQUNuQyx3QkFBaUIsT0FBTyxxQ0FBb0M7Ozs7MkNBQ3BDLFdBQVcsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDOzs7QUFBeEQsK0JBQXFCOztBQUNyQixnQkFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsU0FBTSxDQUFDO0FBQzFDLDZCQUFtQixDQUFDLE9BQU8sRUFBRSxDQUFDOzs7Ozs7O0dBQy9CLENBQUMsQ0FBQzs7QUFFSCxJQUFFLENBQUMsa0RBQWtELEVBQUU7UUFDakQsU0FBUzs7OztBQUFULG1CQUFTLEdBQUcsbUJBQU0sSUFBSSxvQkFBSyxPQUFPLEVBQUUsWUFBTTtBQUM1QyxrQkFBTSxZQUFZLENBQUM7V0FDcEIsQ0FBQzs7MkNBQ0ksMkRBQWtELENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxRQUFROzs7QUFDM0UsbUJBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEVBQUUsUUFBSyxDQUFDO0FBQ3BDLG1CQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7Ozs7Ozs7R0FDckIsQ0FBQyxDQUFDOztBQUVILElBQUUsQ0FBQyw2REFBNkQsRUFBRTs7Ozs7MkNBQzFELHNCQUFlLGdCQUFnQixFQUFFLGNBQWMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsUUFBUTs7Ozs7OztHQUMxRSxDQUFDLENBQUM7O0FBRUgsSUFBRSxDQUFDLCtEQUErRCxFQUFFOzs7OzsyQ0FDNUQsd0JBQWlCLGdCQUFnQixFQUFFLGNBQWMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsUUFBUTs7Ozs7OztHQUM1RSxDQUFDLENBQUM7Q0FFSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC91bml0L3V0aWxzLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlOm1vY2hhXG5cbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IHNpbm9uIGZyb20gJ3Npbm9uJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCAqIGFzIFRlZW5Qcm9jZXNzIGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCAqIGFzIG5vZGVTaW1jdGwgZnJvbSAnbm9kZS1zaW1jdGwnO1xuaW1wb3J0IHsga2lsbEFsbFNpbXVsYXRvcnMsIGVuZEFsbFNpbXVsYXRvckRhZW1vbnMsIHNpbUV4aXN0cywgaW5zdGFsbFNTTENlcnQsIHVuaW5zdGFsbFNTTENlcnQgfSBmcm9tICcuLi8uLic7XG5pbXBvcnQgeyBkZXZpY2VzIH0gZnJvbSAnLi4vYXNzZXRzL2RldmljZUxpc3QnO1xuaW1wb3J0IFNpbXVsYXRvciBmcm9tICcuLi8uLi9saWIvc2ltdWxhdG9yLXhjb2RlLTYnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuY2hhaS5zaG91bGQoKTtcbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcbmNvbnN0IGV4cGVjdCA9IGNoYWkuZXhwZWN0O1xuXG5jb25zdCBYQ09ERV9WRVJTSU9OXzcgPSB7XG4gIHZlcnNpb25TdHJpbmc6ICc3LjEuMScsXG4gIHZlcnNpb25GbG9hdDogNy4xLFxuICBtYWpvcjogNyxcbiAgbWlub3I6IDEsXG4gIHBhdGNoOiAxXG59O1xuY29uc3QgWENPREVfVkVSU0lPTl82ID0ge1xuICB2ZXJzaW9uU3RyaW5nOiAnNi4xLjEnLFxuICB2ZXJzaW9uRmxvYXQ6IDYuMSxcbiAgbWFqb3I6IDYsXG4gIG1pbm9yOiAxLFxuICBwYXRjaDogMVxufTtcblxuXG5sZXQgYXNzZXRzRGlyID0gYCR7cHJvY2Vzcy5jd2QoKX0vdGVzdC9hc3NldHNgO1xuXG5kZXNjcmliZSgndXRpbCcsICgpID0+IHtcbiAgbGV0IGV4ZWNTdHViO1xuICBsZXQgeGNvZGVNb2NrO1xuICBsZXQgZ2V0RGV2aWNlc1N0dWI7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgZXhlY1N0dWIgPSBzaW5vbi5zdHViKFRlZW5Qcm9jZXNzLCAnZXhlYycpO1xuICAgIHhjb2RlTW9jayA9IHNpbm9uLm1vY2soeGNvZGUpO1xuICAgIGdldERldmljZXNTdHViID0gc2lub24uc3R1Yihub2RlU2ltY3RsLCAnZ2V0RGV2aWNlcycpO1xuICAgIGdldERldmljZXNTdHViLnJldHVybnMoQi5yZXNvbHZlKGRldmljZXMpKTtcbiAgfSk7XG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgZXhlY1N0dWIucmVzdG9yZSgpO1xuICAgIHhjb2RlTW9jay5yZXN0b3JlKCk7XG4gICAgbm9kZVNpbWN0bC5nZXREZXZpY2VzLnJlc3RvcmUoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2tpbGxBbGxTaW11bGF0b3JzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY2FsbCBleGVjIHdpdGggU2ltdWxhdG9yIGZvciBYY29kZSA3JywgYXN5bmMgKCkgPT4ge1xuICAgICAgeGNvZGVNb2NrLmV4cGVjdHMoJ2dldFZlcnNpb24nKS53aXRoQXJncyh0cnVlKS5yZXR1cm5zKEIucmVzb2x2ZShYQ09ERV9WRVJTSU9OXzcpKTtcbiAgICAgIGF3YWl0IGtpbGxBbGxTaW11bGF0b3JzKCk7XG4gICAgICBleGVjU3R1Yi5jYWxsZWRPbmNlLnNob3VsZC5iZS50cnVlO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgY2FsbCBleGVjIHdpdGggaU9TIFNpbXVsYXRvciBmb3IgWGNvZGUgNicsIGFzeW5jICgpID0+IHtcbiAgICAgIHhjb2RlTW9jay5leHBlY3RzKCdnZXRWZXJzaW9uJykud2l0aEFyZ3ModHJ1ZSkucmV0dXJucyhCLnJlc29sdmUoWENPREVfVkVSU0lPTl82KSk7XG4gICAgICBhd2FpdCBraWxsQWxsU2ltdWxhdG9ycygpO1xuICAgICAgZXhlY1N0dWIuY2FsbGVkT25jZS5zaG91bGQuYmUudHJ1ZTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGNvbnRpbnVlIGlmIGFwcGxpY2F0aW9uIGlzIG5vdCBydW5uaW5nIGVycm9yIGdldHMgdGhyb3duJywgYXN5bmMgKCkgPT4ge1xuICAgICAgeGNvZGVNb2NrLmV4cGVjdHMoJ2dldFZlcnNpb24nKS53aXRoQXJncyh0cnVlKS5yZXR1cm5zKEIucmVzb2x2ZShYQ09ERV9WRVJTSU9OXzcpKTtcbiAgICAgIGV4ZWNTdHViLnRocm93cygne1wic3Rkb3V0XCI6XCJcIixcInN0ZGVyclwiOlwiMDoyNDogZXhlY3V0aW9uIGVycm9yOiBpT1MgU2ltdWxhdG9yIGdvdCBhbiBlcnJvcjogQXBwbGljYXRpb24gaXNu4oCZdCBydW5uaW5nLiAoLTYwMClcXG5cIixcImNvZGVcIjoxfScpO1xuICAgICAgYXdhaXQga2lsbEFsbFNpbXVsYXRvcnMoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2VuZEFsbFNpbXVsYXRvckRhZW1vbnMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjYWxsIGV4ZWMgZml2ZSB0aW1lcyB0byBzdG9wIGFuZCByZW1vdmUgZWFjaCBzZXJ2aWNlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgZW5kQWxsU2ltdWxhdG9yRGFlbW9ucygpO1xuICAgICAgZXhlY1N0dWIuY2FsbENvdW50LnNob3VsZC5lcXVhbCg1KTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGlnbm9yZSBhbGwgZXJyb3JzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgZXhlY1N0dWIudGhyb3dzKCk7XG4gICAgICBhd2FpdCBlbmRBbGxTaW11bGF0b3JEYWVtb25zKCkuc2hvdWxkLm5vdC5iZS5yZWplY3RlZDtcbiAgICAgIGV4ZWNTdHViLmNhbGxDb3VudC5zaG91bGQuZXF1YWwoNSk7XG4gICAgICBleGVjU3R1Yi50aHJldygpLnNob3VsZC5iZS50cnVlO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnc2ltRXhpc3RzJywgKCkgPT4ge1xuICAgIGl0KCdyZXR1cm5zIHRydWUgaWYgZGV2aWNlIGlzIGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGV4aXN0ZW5jZSA9IFtcbiAgICAgICAgc2ltRXhpc3RzKCdDMDlCMzRFNS03RENCLTQ0MkUtQjc5Qy1BQjZCQzAzNTc0MTcnKSxcbiAgICAgICAgc2ltRXhpc3RzKCdGQTVDOTcxRC00RTA1LTRBQTMtQjQ4Qi1DOTYxOUM3NDUzQkUnKSxcbiAgICAgICAgc2ltRXhpc3RzKCdFNDZFRkE1OS1FMkI0LTRGRjktQjI5MC1CNjFGM0NGRUNDNjUnKSxcbiAgICAgICAgc2ltRXhpc3RzKCdGMzM3ODNCMi05RUU5LTRBOTktODY2RS1FMTI2QURCQUQ0MTAnKVxuICAgICAgXTtcblxuICAgICAgbGV0IHJlc3VsdHMgPSBhd2FpdCBCLmFsbChleGlzdGVuY2UpO1xuXG4gICAgICBmb3IgKGxldCByZXN1bHQgb2YgcmVzdWx0cykge1xuICAgICAgICByZXN1bHQuc2hvdWxkLmJlLnRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpdCgncmV0dXJucyBmYWxzZSBpZiBkZXZpY2UgaXMgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGV4aXN0ZW5jZSA9IFtdO1xuICAgICAgZXhpc3RlbmNlLnB1c2goc2ltRXhpc3RzKCdBOTRFNENENy1ENDEyLTQxOTgtQkNENC0yNjc5OTY3Mjk3NUUnKSk7XG4gICAgICBleGlzdGVuY2UucHVzaChzaW1FeGlzdHMoJ2FzZGYnKSk7XG4gICAgICBleGlzdGVuY2UucHVzaChzaW1FeGlzdHMoNCkpO1xuXG4gICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IEIuYWxsKGV4aXN0ZW5jZSk7XG5cbiAgICAgIGZvciAobGV0IHJlc3VsdCBvZiByZXN1bHRzKSB7XG4gICAgICAgIHJlc3VsdC5zaG91bGQuYmUuZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG59KTtcblxuZGVzY3JpYmUoJ2luc3RhbGxTU0xDZXJ0IGFuZCB1bmluc3RhbGxTU0xDZXJ0JywgKCkgPT4ge1xuXG4gIGl0KCdzaG91bGQgaW5zdGFsbCBhbmQgdW5pbnN0YWxsIGNlcnRzIGluIGtleWNoYWluIGRpcmVjdG9yaWVzJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBzaW11bGF0b3JHZXREaXJTdHViID0gc2lub24uc3R1YihTaW11bGF0b3IucHJvdG90eXBlLCAnZ2V0RGlyJywgZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIHBhdGgucmVzb2x2ZShhc3NldHNEaXIpO1xuICAgIH0pO1xuICAgIGxldCB0ZXN0UGVtID0gYXdhaXQgZnMucmVhZEZpbGUocGF0aC5yZXNvbHZlKGFzc2V0c0RpciwgJ3Rlc3QtcGVtLnBlbScpKTtcbiAgICBsZXQgY2VydGlmaWNhdGUgPSBhd2FpdCBpbnN0YWxsU1NMQ2VydCh0ZXN0UGVtLCBgdXNpbmcgbW9jaywgdWRpZCBkb2Vzbid0IG1hdHRlcmApO1xuICAgIGxldCBjZXJ0RXhpc3RzSW5Bc3NldHNEaXIgPSBhd2FpdCBjZXJ0aWZpY2F0ZS5oYXMoYXNzZXRzRGlyKTtcbiAgICBleHBlY3QoY2VydEV4aXN0c0luQXNzZXRzRGlyKS50by5iZS50cnVlO1xuICAgIGF3YWl0IHVuaW5zdGFsbFNTTENlcnQodGVzdFBlbSwgYHVzaW5nIG1vY2ssIHVkaWQgZG9lc24ndCBtYXR0ZXJgKTtcbiAgICBjZXJ0RXhpc3RzSW5Bc3NldHNEaXIgPSBhd2FpdCBjZXJ0aWZpY2F0ZS5oYXMoYXNzZXRzRGlyKTtcbiAgICBleHBlY3QoY2VydEV4aXN0c0luQXNzZXRzRGlyKS50by5iZS5mYWxzZTtcbiAgICBzaW11bGF0b3JHZXREaXJTdHViLnJlc3RvcmUoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCB0aHJvdyBleGNlcHRpb24gaWYgb3BlbnNzbCBpcyB1bmF2YWlsYWJsZScsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgd2hpY2hTdHViID0gc2lub24uc3R1YihmcywgJ3doaWNoJywgKCkgPT4ge1xuICAgICAgdGhyb3cgJ25vIG9wZW5zc2wnO1xuICAgIH0pO1xuICAgIGF3YWl0IGluc3RhbGxTU0xDZXJ0KGBkb2Vzbid0IG1hdHRlcmAsIGBkb2Vzbid0IG1hdHRlcmApLnNob3VsZC5iZS5yZWplY3RlZDtcbiAgICB3aGljaFN0dWIuY2FsbGVkT25jZS5zaG91bGQuYmUudHJ1ZTtcbiAgICB3aGljaFN0dWIucmVzdG9yZSgpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHRocm93IGV4Y2VwdGlvbiBvbiBpbnN0YWxsU1NMQ2VydCBpZiB1ZGlkIGlzIGludmFsaWQnLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgaW5zdGFsbFNTTENlcnQoJ3BlbSBkdW1teSB0ZXh0JywgJ2ludmFsaWQgVURJRCcpLnNob3VsZC5iZS5yZWplY3RlZDtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCB0aHJvdyBleGNlcHRpb24gb24gdW5pbnN0YWxsU1NMQ2VydCBpZiB1ZGlkIGlzIGludmFsaWQnLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgdW5pbnN0YWxsU1NMQ2VydCgncGVtIGR1bW15IHRleHQnLCAnaW52YWxpZCBVRElEJykuc2hvdWxkLmJlLnJlamVjdGVkO1xuICB9KTtcblxufSk7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=

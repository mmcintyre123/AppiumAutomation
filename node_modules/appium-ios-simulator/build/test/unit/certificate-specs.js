require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _libCertificate = require('../../lib/certificate');

var _appiumSupport = require('appium-support');

var _fsExtra = require('fs-extra');

var _uuid = require('uuid');

var _uuid2 = _interopRequireDefault(_uuid);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);
var expect = _chai2['default'].expect;

var cwd = process.cwd();
var assetsDir = cwd + '/test/assets';
var keychainsDir = assetsDir + '/Library/Keychains';
var keychainsDirOriginal = undefined;
var certificate = undefined;
var trustStore = undefined;
var testUUID = undefined;
var tempDirectory = undefined;

describe('when using TrustStore class', function () {

  beforeEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          keychainsDirOriginal = assetsDir + '/Library/Keychains-Original';
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(keychainsDir));

        case 3:
          (0, _fsExtra.copySync)(keychainsDirOriginal, keychainsDir);
          trustStore = new _libCertificate.TrustStore(assetsDir);
          testUUID = _uuid2['default'].v4();

        case 6:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can add a record to the TrustStore tsettings', function callee$1$0() {
    var tsettings;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(trustStore.getRecords(testUUID));

        case 2:
          tsettings = context$2$0.sent;

          expect(tsettings).to.have.length.of(0);
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(trustStore.addRecord(_uuid2['default'].v4(), 'tset', testUUID, 'data'));

        case 6:
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(trustStore.getRecords(testUUID));

        case 8:
          tsettings = context$2$0.sent;

          expect(tsettings).to.have.length.above(0);
          tsettings[0].subj.should.equal(testUUID);

        case 11:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can add and remove records to in TrustStore tsettings', function callee$1$0() {
    var tsettings;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(trustStore.addRecord(_uuid2['default'].v4(), 'tset', testUUID, 'data'));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(trustStore.getRecords(testUUID));

        case 4:
          tsettings = context$2$0.sent;

          expect(tsettings).to.have.length.above(0);
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(trustStore.removeRecord(testUUID));

        case 8:
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap(trustStore.getRecords(testUUID));

        case 10:
          tsettings = context$2$0.sent;

          expect(tsettings).to.have.length(0);

        case 12:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can update a record in the TrustStore tsettings', function callee$1$0() {
    var tsettings;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(trustStore.addRecord(_uuid2['default'].v4(), 'tset', testUUID, 'data1'));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(trustStore.getRecords(testUUID));

        case 4:
          tsettings = context$2$0.sent;

          expect(tsettings[0].data).to.equal('data1');
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(trustStore.addRecord(_uuid2['default'].v4(), 'tset', testUUID, 'data2'));

        case 8:
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap(trustStore.getRecords(testUUID));

        case 10:
          tsettings = context$2$0.sent;

          expect(tsettings[0].data).to.equal('data2');

        case 12:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});

describe('when using TrustStore class when the keychains directory doesn\'t exist', function () {
  beforeEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          tempDirectory = assetsDir + '/temp';
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(tempDirectory));

        case 3:
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(tempDirectory));

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  afterEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(tempDirectory));

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('will create a new keychains directory with a SQLite DB', function callee$1$0() {
    var newTrustStore, tsettings;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          newTrustStore = new _libCertificate.TrustStore(tempDirectory);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(newTrustStore.addRecord('test', 'test', 'test', 'test'));

        case 3:
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(newTrustStore.getRecords('test'));

        case 5:
          tsettings = context$2$0.sent;

          expect(tsettings).to.have.length(1);

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});

describe('when using Certificate class', function () {

  beforeEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(new _libCertificate.Certificate(assetsDir + '/test-pem.pem'));

        case 2:
          certificate = context$2$0.sent;

        case 3:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can translate PEM certificate to DER format', function callee$1$0() {
    var derData, testData;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(certificate.getDerData());

        case 2:
          derData = context$2$0.sent;
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(assetsDir + '/Library/certificates/test-data.txt'));

        case 5:
          testData = context$2$0.sent;

          expect(testData.equals(derData));

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can get a fingerprint from a PEM certificate', function callee$1$0() {
    var fingerprint, testFingerprint;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(certificate.getFingerPrint());

        case 2:
          fingerprint = context$2$0.sent;
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(assetsDir + '/Library/certificates/test-fingerprint.txt'));

        case 5:
          testFingerprint = context$2$0.sent;

          expect(fingerprint.equals(testFingerprint));

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can get a subject from a PEM certificate', function callee$1$0() {
    var subject, testSubject;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(certificate.getSubject(assetsDir + '/test-pem.pem'));

        case 2:
          subject = context$2$0.sent;
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(assetsDir + '/Library/certificates/test-subj.txt', 'utf-8'));

        case 5:
          testSubject = context$2$0.sent;

          expect(subject).to.equal(testSubject);

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can add a certificate to a sqlite store', function callee$1$0() {
    var hasCert;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(certificate.add(assetsDir));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(certificate.has(assetsDir));

        case 4:
          hasCert = context$2$0.sent;

          expect(hasCert);

        case 6:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can add and remove a certificate to a sqlite store', function callee$1$0() {
    var hasCert;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(certificate.add(assetsDir));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(certificate.has(assetsDir));

        case 4:
          hasCert = context$2$0.sent;

          expect(hasCert);
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(certificate.remove(assetsDir));

        case 8:
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap(certificate.has(assetsDir));

        case 10:
          hasCert = context$2$0.sent;

          expect(!hasCert);

        case 12:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  it('can add a certificate and then remove the same certificate later', function callee$1$0() {
    var hasCert;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(certificate.add(assetsDir));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(certificate.has(assetsDir));

        case 4:
          hasCert = context$2$0.sent;

          expect(hasCert);

          certificate = new _libCertificate.Certificate(assetsDir + '/test-pem.pem');
          context$2$0.next = 9;
          return _regeneratorRuntime.awrap(certificate.remove(assetsDir));

        case 9:
          context$2$0.next = 11;
          return _regeneratorRuntime.awrap(certificate.has(assetsDir));

        case 11:
          hasCert = context$2$0.sent;

          expect(!hasCert);

        case 13:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9jZXJ0aWZpY2F0ZS1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O29CQUVpQixNQUFNOzs7OzhCQUNJLGtCQUFrQjs7Ozs4QkFDTCx1QkFBdUI7OzZCQUM1QyxnQkFBZ0I7O3VCQUNWLFVBQVU7O29CQUNsQixNQUFNOzs7O0FBRXZCLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQ2Qsa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQztBQUN6QixJQUFJLE1BQU0sR0FBRyxrQkFBSyxNQUFNLENBQUM7O0FBRXpCLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUN4QixJQUFJLFNBQVMsR0FBTSxHQUFHLGlCQUFjLENBQUM7QUFDckMsSUFBSSxZQUFZLEdBQU0sU0FBUyx1QkFBb0IsQ0FBQztBQUNwRCxJQUFJLG9CQUFvQixZQUFBLENBQUM7QUFDekIsSUFBSSxXQUFXLFlBQUEsQ0FBQztBQUNoQixJQUFJLFVBQVUsWUFBQSxDQUFDO0FBQ2YsSUFBSSxRQUFRLFlBQUEsQ0FBQztBQUNiLElBQUksYUFBYSxZQUFBLENBQUM7O0FBRWxCLFFBQVEsQ0FBQyw2QkFBNkIsRUFBRSxZQUFNOztBQUU1QyxZQUFVLENBQUM7Ozs7QUFDVCw4QkFBb0IsR0FBTSxTQUFTLGdDQUE2QixDQUFDOzsyQ0FDM0Qsa0JBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQzs7O0FBQzdCLGlDQUFTLG9CQUFvQixFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQzdDLG9CQUFVLEdBQUcsK0JBQWUsU0FBUyxDQUFDLENBQUM7QUFDdkMsa0JBQVEsR0FBRyxrQkFBSyxFQUFFLEVBQUUsQ0FBQzs7Ozs7OztHQUN0QixDQUFDLENBQUM7O0FBRUgsSUFBRSxDQUFDLDhDQUE4QyxFQUFFO1FBQzdDLFNBQVM7Ozs7OzJDQUFTLFVBQVUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDOzs7QUFBakQsbUJBQVM7O0FBQ2IsZ0JBQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7OzJDQUNqQyxVQUFVLENBQUMsU0FBUyxDQUFDLGtCQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDOzs7OzJDQUM3QyxVQUFVLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQzs7O0FBQWpELG1CQUFTOztBQUNULGdCQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzFDLG1CQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7Ozs7Ozs7R0FDMUMsQ0FBQyxDQUFDOztBQUVILElBQUUsQ0FBQyx1REFBdUQsRUFBRTtRQUV0RCxTQUFTOzs7OzsyQ0FEUCxVQUFVLENBQUMsU0FBUyxDQUFDLGtCQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDOzs7OzJDQUN6QyxVQUFVLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQzs7O0FBQWpELG1CQUFTOztBQUNiLGdCQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDOzsyQ0FDcEMsVUFBVSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUM7Ozs7MkNBQ3JCLFVBQVUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDOzs7QUFBakQsbUJBQVM7O0FBQ1QsZ0JBQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQzs7Ozs7OztHQUNyQyxDQUFDLENBQUM7O0FBRUgsSUFBRSxDQUFDLGlEQUFpRCxFQUFFO1FBRWhELFNBQVM7Ozs7OzJDQURQLFVBQVUsQ0FBQyxTQUFTLENBQUMsa0JBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUM7Ozs7MkNBQzFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDOzs7QUFBakQsbUJBQVM7O0FBQ2IsZ0JBQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQzs7MkNBQ3RDLFVBQVUsQ0FBQyxTQUFTLENBQUMsa0JBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUM7Ozs7MkNBQzlDLFVBQVUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDOzs7QUFBakQsbUJBQVM7O0FBQ1QsZ0JBQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQzs7Ozs7OztHQUM3QyxDQUFDLENBQUM7Q0FDSixDQUFDLENBQUM7O0FBRUgsUUFBUSxDQUFDLHlFQUF5RSxFQUFFLFlBQU07QUFDeEYsWUFBVSxDQUFDOzs7O0FBQ1QsdUJBQWEsR0FBTSxTQUFTLFVBQU8sQ0FBQzs7MkNBQzlCLGtCQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUM7Ozs7MkNBQ3hCLGtCQUFHLEtBQUssQ0FBQyxhQUFhLENBQUM7Ozs7Ozs7R0FDOUIsQ0FBQyxDQUFDOztBQUVILFdBQVMsQ0FBQzs7Ozs7MkNBQ0Ysa0JBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQzs7Ozs7OztHQUMvQixDQUFDLENBQUM7O0FBRUgsSUFBRSxDQUFDLHdEQUF3RCxFQUFFO1FBQ3ZELGFBQWEsRUFFYixTQUFTOzs7O0FBRlQsdUJBQWEsR0FBRywrQkFBZSxhQUFhLENBQUM7OzJDQUMzQyxhQUFhLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQzs7OzsyQ0FDdkMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUM7OztBQUFsRCxtQkFBUzs7QUFDYixnQkFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDOzs7Ozs7O0dBQ3JDLENBQUMsQ0FBQztDQUNKLENBQUMsQ0FBQzs7QUFFSCxRQUFRLENBQUMsOEJBQThCLEVBQUUsWUFBTTs7QUFFN0MsWUFBVSxDQUFDOzs7OzsyQ0FDVyxnQ0FBbUIsU0FBUyxtQkFBZ0I7OztBQUFoRSxxQkFBVzs7Ozs7OztHQUNaLENBQUMsQ0FBQzs7QUFFSCxJQUFFLENBQUMsNkNBQTZDLEVBQUU7UUFDNUMsT0FBTyxFQUNQLFFBQVE7Ozs7OzJDQURRLFdBQVcsQ0FBQyxVQUFVLEVBQUU7OztBQUF4QyxpQkFBTzs7MkNBQ1Usa0JBQUcsUUFBUSxDQUFJLFNBQVMseUNBQXNDOzs7QUFBL0Usa0JBQVE7O0FBQ1osZ0JBQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7Ozs7Ozs7R0FDbEMsQ0FBQyxDQUFDOztBQUVILElBQUUsQ0FBQyw4Q0FBOEMsRUFBRTtRQUM3QyxXQUFXLEVBQ1gsZUFBZTs7Ozs7MkNBREssV0FBVyxDQUFDLGNBQWMsRUFBRTs7O0FBQWhELHFCQUFXOzsyQ0FDYSxrQkFBRyxRQUFRLENBQUksU0FBUyxnREFBNkM7OztBQUE3Rix5QkFBZTs7QUFDbkIsZ0JBQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7Ozs7Ozs7R0FDN0MsQ0FBQyxDQUFDOztBQUVILElBQUUsQ0FBQywwQ0FBMEMsRUFBRTtRQUN6QyxPQUFPLEVBQ1AsV0FBVzs7Ozs7MkNBREssV0FBVyxDQUFDLFVBQVUsQ0FBSSxTQUFTLG1CQUFnQjs7O0FBQW5FLGlCQUFPOzsyQ0FDYSxrQkFBRyxRQUFRLENBQUksU0FBUywwQ0FBdUMsT0FBTyxDQUFDOzs7QUFBM0YscUJBQVc7O0FBQ2YsZ0JBQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDOzs7Ozs7O0dBQ3ZDLENBQUMsQ0FBQzs7QUFFSCxJQUFFLENBQUMseUNBQXlDLEVBQUU7UUFFeEMsT0FBTzs7Ozs7MkNBREwsV0FBVyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUM7Ozs7MkNBQ1osV0FBVyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUM7OztBQUExQyxpQkFBTzs7QUFDWCxnQkFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDOzs7Ozs7O0dBQ2pCLENBQUMsQ0FBQzs7QUFFSCxJQUFFLENBQUMsb0RBQW9ELEVBQUU7UUFFbkQsT0FBTzs7Ozs7MkNBREwsV0FBVyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUM7Ozs7MkNBQ1osV0FBVyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUM7OztBQUExQyxpQkFBTzs7QUFDWCxnQkFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDOzsyQ0FDVixXQUFXLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQzs7OzsyQ0FDbkIsV0FBVyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUM7OztBQUExQyxpQkFBTzs7QUFDUCxnQkFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7Ozs7Ozs7R0FDbEIsQ0FBQyxDQUFDOztBQUVILElBQUUsQ0FBQyxrRUFBa0UsRUFBRTtRQUVqRSxPQUFPOzs7OzsyQ0FETCxXQUFXLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQzs7OzsyQ0FDWixXQUFXLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQzs7O0FBQTFDLGlCQUFPOztBQUNYLGdCQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7O0FBRWhCLHFCQUFXLEdBQUcsZ0NBQW1CLFNBQVMsbUJBQWdCLENBQUM7OzJDQUNyRCxXQUFXLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQzs7OzsyQ0FDbkIsV0FBVyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUM7OztBQUExQyxpQkFBTzs7QUFDUCxnQkFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7Ozs7Ozs7R0FDbEIsQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6InRlc3QvdW5pdC9jZXJ0aWZpY2F0ZS1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptb2NoYVxuXG5pbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCB7IENlcnRpZmljYXRlLCBUcnVzdFN0b3JlIH0gZnJvbSAnLi4vLi4vbGliL2NlcnRpZmljYXRlJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgY29weVN5bmMgfSBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgdXVpZCBmcm9tICd1dWlkJztcblxuY2hhaS5zaG91bGQoKTtcbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcbmxldCBleHBlY3QgPSBjaGFpLmV4cGVjdDtcblxubGV0IGN3ZCA9IHByb2Nlc3MuY3dkKCk7XG5sZXQgYXNzZXRzRGlyID0gYCR7Y3dkfS90ZXN0L2Fzc2V0c2A7XG5sZXQga2V5Y2hhaW5zRGlyID0gYCR7YXNzZXRzRGlyfS9MaWJyYXJ5L0tleWNoYWluc2A7XG5sZXQga2V5Y2hhaW5zRGlyT3JpZ2luYWw7XG5sZXQgY2VydGlmaWNhdGU7XG5sZXQgdHJ1c3RTdG9yZTtcbmxldCB0ZXN0VVVJRDtcbmxldCB0ZW1wRGlyZWN0b3J5O1xuXG5kZXNjcmliZSgnd2hlbiB1c2luZyBUcnVzdFN0b3JlIGNsYXNzJywgKCkgPT4ge1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGtleWNoYWluc0Rpck9yaWdpbmFsID0gYCR7YXNzZXRzRGlyfS9MaWJyYXJ5L0tleWNoYWlucy1PcmlnaW5hbGA7XG4gICAgYXdhaXQgZnMucmltcmFmKGtleWNoYWluc0Rpcik7XG4gICAgY29weVN5bmMoa2V5Y2hhaW5zRGlyT3JpZ2luYWwsIGtleWNoYWluc0Rpcik7XG4gICAgdHJ1c3RTdG9yZSA9IG5ldyBUcnVzdFN0b3JlKGFzc2V0c0Rpcik7XG4gICAgdGVzdFVVSUQgPSB1dWlkLnY0KCk7XG4gIH0pO1xuXG4gIGl0KCdjYW4gYWRkIGEgcmVjb3JkIHRvIHRoZSBUcnVzdFN0b3JlIHRzZXR0aW5ncycsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgdHNldHRpbmdzID0gYXdhaXQgdHJ1c3RTdG9yZS5nZXRSZWNvcmRzKHRlc3RVVUlEKTtcbiAgICBleHBlY3QodHNldHRpbmdzKS50by5oYXZlLmxlbmd0aC5vZigwKTtcbiAgICBhd2FpdCB0cnVzdFN0b3JlLmFkZFJlY29yZCh1dWlkLnY0KCksICd0c2V0JywgdGVzdFVVSUQsICdkYXRhJyk7XG4gICAgdHNldHRpbmdzID0gYXdhaXQgdHJ1c3RTdG9yZS5nZXRSZWNvcmRzKHRlc3RVVUlEKTtcbiAgICBleHBlY3QodHNldHRpbmdzKS50by5oYXZlLmxlbmd0aC5hYm92ZSgwKTtcbiAgICB0c2V0dGluZ3NbMF0uc3Viai5zaG91bGQuZXF1YWwodGVzdFVVSUQpO1xuICB9KTtcblxuICBpdCgnY2FuIGFkZCBhbmQgcmVtb3ZlIHJlY29yZHMgdG8gaW4gVHJ1c3RTdG9yZSB0c2V0dGluZ3MnLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgdHJ1c3RTdG9yZS5hZGRSZWNvcmQodXVpZC52NCgpLCAndHNldCcsIHRlc3RVVUlELCAnZGF0YScpO1xuICAgIGxldCB0c2V0dGluZ3MgPSBhd2FpdCB0cnVzdFN0b3JlLmdldFJlY29yZHModGVzdFVVSUQpO1xuICAgIGV4cGVjdCh0c2V0dGluZ3MpLnRvLmhhdmUubGVuZ3RoLmFib3ZlKDApO1xuICAgIGF3YWl0IHRydXN0U3RvcmUucmVtb3ZlUmVjb3JkKHRlc3RVVUlEKTtcbiAgICB0c2V0dGluZ3MgPSBhd2FpdCB0cnVzdFN0b3JlLmdldFJlY29yZHModGVzdFVVSUQpO1xuICAgIGV4cGVjdCh0c2V0dGluZ3MpLnRvLmhhdmUubGVuZ3RoKDApO1xuICB9KTtcblxuICBpdCgnY2FuIHVwZGF0ZSBhIHJlY29yZCBpbiB0aGUgVHJ1c3RTdG9yZSB0c2V0dGluZ3MnLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgdHJ1c3RTdG9yZS5hZGRSZWNvcmQodXVpZC52NCgpLCAndHNldCcsIHRlc3RVVUlELCAnZGF0YTEnKTtcbiAgICBsZXQgdHNldHRpbmdzID0gYXdhaXQgdHJ1c3RTdG9yZS5nZXRSZWNvcmRzKHRlc3RVVUlEKTtcbiAgICBleHBlY3QodHNldHRpbmdzWzBdLmRhdGEpLnRvLmVxdWFsKCdkYXRhMScpO1xuICAgIGF3YWl0IHRydXN0U3RvcmUuYWRkUmVjb3JkKHV1aWQudjQoKSwgJ3RzZXQnLCB0ZXN0VVVJRCwgJ2RhdGEyJyk7XG4gICAgdHNldHRpbmdzID0gYXdhaXQgdHJ1c3RTdG9yZS5nZXRSZWNvcmRzKHRlc3RVVUlEKTtcbiAgICBleHBlY3QodHNldHRpbmdzWzBdLmRhdGEpLnRvLmVxdWFsKCdkYXRhMicpO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnd2hlbiB1c2luZyBUcnVzdFN0b3JlIGNsYXNzIHdoZW4gdGhlIGtleWNoYWlucyBkaXJlY3RvcnkgZG9lc25cXCd0IGV4aXN0JywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICB0ZW1wRGlyZWN0b3J5ID0gYCR7YXNzZXRzRGlyfS90ZW1wYDtcbiAgICBhd2FpdCBmcy5yaW1yYWYodGVtcERpcmVjdG9yeSk7XG4gICAgYXdhaXQgZnMubWtkaXIodGVtcERpcmVjdG9yeSk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgZnMucmltcmFmKHRlbXBEaXJlY3RvcnkpO1xuICB9KTtcblxuICBpdCgnd2lsbCBjcmVhdGUgYSBuZXcga2V5Y2hhaW5zIGRpcmVjdG9yeSB3aXRoIGEgU1FMaXRlIERCJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBuZXdUcnVzdFN0b3JlID0gbmV3IFRydXN0U3RvcmUodGVtcERpcmVjdG9yeSk7XG4gICAgYXdhaXQgbmV3VHJ1c3RTdG9yZS5hZGRSZWNvcmQoJ3Rlc3QnLCAndGVzdCcsICd0ZXN0JywgJ3Rlc3QnKTtcbiAgICBsZXQgdHNldHRpbmdzID0gYXdhaXQgbmV3VHJ1c3RTdG9yZS5nZXRSZWNvcmRzKCd0ZXN0Jyk7XG4gICAgZXhwZWN0KHRzZXR0aW5ncykudG8uaGF2ZS5sZW5ndGgoMSk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKCd3aGVuIHVzaW5nIENlcnRpZmljYXRlIGNsYXNzJywgKCkgPT4ge1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGNlcnRpZmljYXRlID0gYXdhaXQgbmV3IENlcnRpZmljYXRlKGAke2Fzc2V0c0Rpcn0vdGVzdC1wZW0ucGVtYCk7XG4gIH0pO1xuXG4gIGl0KCdjYW4gdHJhbnNsYXRlIFBFTSBjZXJ0aWZpY2F0ZSB0byBERVIgZm9ybWF0JywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBkZXJEYXRhID0gYXdhaXQgY2VydGlmaWNhdGUuZ2V0RGVyRGF0YSgpO1xuICAgIGxldCB0ZXN0RGF0YSA9IGF3YWl0IGZzLnJlYWRGaWxlKGAke2Fzc2V0c0Rpcn0vTGlicmFyeS9jZXJ0aWZpY2F0ZXMvdGVzdC1kYXRhLnR4dGApO1xuICAgIGV4cGVjdCh0ZXN0RGF0YS5lcXVhbHMoZGVyRGF0YSkpO1xuICB9KTtcblxuICBpdCgnY2FuIGdldCBhIGZpbmdlcnByaW50IGZyb20gYSBQRU0gY2VydGlmaWNhdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGZpbmdlcnByaW50ID0gYXdhaXQgY2VydGlmaWNhdGUuZ2V0RmluZ2VyUHJpbnQoKTtcbiAgICBsZXQgdGVzdEZpbmdlcnByaW50ID0gYXdhaXQgZnMucmVhZEZpbGUoYCR7YXNzZXRzRGlyfS9MaWJyYXJ5L2NlcnRpZmljYXRlcy90ZXN0LWZpbmdlcnByaW50LnR4dGApO1xuICAgIGV4cGVjdChmaW5nZXJwcmludC5lcXVhbHModGVzdEZpbmdlcnByaW50KSk7XG4gIH0pO1xuXG4gIGl0KCdjYW4gZ2V0IGEgc3ViamVjdCBmcm9tIGEgUEVNIGNlcnRpZmljYXRlJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBzdWJqZWN0ID0gYXdhaXQgY2VydGlmaWNhdGUuZ2V0U3ViamVjdChgJHthc3NldHNEaXJ9L3Rlc3QtcGVtLnBlbWApO1xuICAgIGxldCB0ZXN0U3ViamVjdCA9IGF3YWl0IGZzLnJlYWRGaWxlKGAke2Fzc2V0c0Rpcn0vTGlicmFyeS9jZXJ0aWZpY2F0ZXMvdGVzdC1zdWJqLnR4dGAsICd1dGYtOCcpO1xuICAgIGV4cGVjdChzdWJqZWN0KS50by5lcXVhbCh0ZXN0U3ViamVjdCk7XG4gIH0pO1xuXG4gIGl0KCdjYW4gYWRkIGEgY2VydGlmaWNhdGUgdG8gYSBzcWxpdGUgc3RvcmUnLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgY2VydGlmaWNhdGUuYWRkKGFzc2V0c0Rpcik7XG4gICAgbGV0IGhhc0NlcnQgPSBhd2FpdCBjZXJ0aWZpY2F0ZS5oYXMoYXNzZXRzRGlyKTtcbiAgICBleHBlY3QoaGFzQ2VydCk7XG4gIH0pO1xuXG4gIGl0KCdjYW4gYWRkIGFuZCByZW1vdmUgYSBjZXJ0aWZpY2F0ZSB0byBhIHNxbGl0ZSBzdG9yZScsIGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBjZXJ0aWZpY2F0ZS5hZGQoYXNzZXRzRGlyKTtcbiAgICBsZXQgaGFzQ2VydCA9IGF3YWl0IGNlcnRpZmljYXRlLmhhcyhhc3NldHNEaXIpO1xuICAgIGV4cGVjdChoYXNDZXJ0KTtcbiAgICBhd2FpdCBjZXJ0aWZpY2F0ZS5yZW1vdmUoYXNzZXRzRGlyKTtcbiAgICBoYXNDZXJ0ID0gYXdhaXQgY2VydGlmaWNhdGUuaGFzKGFzc2V0c0Rpcik7XG4gICAgZXhwZWN0KCFoYXNDZXJ0KTtcbiAgfSk7XG5cbiAgaXQoJ2NhbiBhZGQgYSBjZXJ0aWZpY2F0ZSBhbmQgdGhlbiByZW1vdmUgdGhlIHNhbWUgY2VydGlmaWNhdGUgbGF0ZXInLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgY2VydGlmaWNhdGUuYWRkKGFzc2V0c0Rpcik7XG4gICAgbGV0IGhhc0NlcnQgPSBhd2FpdCBjZXJ0aWZpY2F0ZS5oYXMoYXNzZXRzRGlyKTtcbiAgICBleHBlY3QoaGFzQ2VydCk7XG5cbiAgICBjZXJ0aWZpY2F0ZSA9IG5ldyBDZXJ0aWZpY2F0ZShgJHthc3NldHNEaXJ9L3Rlc3QtcGVtLnBlbWApO1xuICAgIGF3YWl0IGNlcnRpZmljYXRlLnJlbW92ZShhc3NldHNEaXIpO1xuICAgIGhhc0NlcnQgPSBhd2FpdCBjZXJ0aWZpY2F0ZS5oYXMoYXNzZXRzRGlyKTtcbiAgICBleHBlY3QoIWhhc0NlcnQpO1xuICB9KTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9

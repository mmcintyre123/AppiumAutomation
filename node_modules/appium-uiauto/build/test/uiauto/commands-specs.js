require('source-map-support').install();

/* globals $ */

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _base = require('./base');

var _appiumXcode = require('appium-xcode');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

describe('commands', function () {
  var _this = this;

  (0, _base.globalInit)(this, { bootstrap: 'basic' });
  var numCommands = 100;
  before(function callee$1$0() {
    var xcodeVersion;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _appiumXcode.getVersion)());

        case 2:
          xcodeVersion = context$2$0.sent;

          if (xcodeVersion[0] >= 7) {
            numCommands = 50;
          }

        case 4:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  describe('simple sequences', function () {
    var _this2 = this;

    var ctx = undefined;
    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _base.instrumentsInstanceInit)());

          case 2:
            ctx = context$3$0.sent;

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this2);
    });
    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _base.killAll)(ctx));

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this2);
    });

    it('should send one valid command returning a value', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(ctx.sendCommand("'123'"));

          case 2:
            context$3$0.sent.should.equal('123');

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this2);
    });

    it('should send one valid command returning empty value', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(ctx.sendCommand("$.warn('starting')"));

          case 2:
            context$3$0.sent.should.equal('');

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this2);
    });

    it('should respond to invalid command and not die', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(ctx.sendCommand('i_am_invalid()').should.be.rejectedWith(/Can't find variable: i_am_invalid/));

          case 2:
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(ctx.sendCommand("$.warn('still alive')"));

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this2);
    });

    it('should repond to 10 commands in a row', function callee$2$0() {
      var seq;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        var _this4 = this;

        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            seq = [];

            _lodash2['default'].times(10, function (i) {
              var _this3 = this;

              seq.push(function callee$4$0() {
                return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
                  while (1) switch (context$5$0.prev = context$5$0.next) {
                    case 0:
                      context$5$0.next = 2;
                      return _regeneratorRuntime.awrap(ctx.sendCommand('(function () { return ' + i + '})()'));

                    case 2:
                      context$5$0.t0 = i;
                      context$5$0.sent.should.equal(context$5$0.t0);

                    case 4:
                    case 'end':
                      return context$5$0.stop();
                  }
                }, null, _this3);
              });
            });
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(_bluebird2['default'].reduce(seq, function callee$3$0(res, task) {
              return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                while (1) switch (context$4$0.prev = context$4$0.next) {
                  case 0:
                    context$4$0.next = 2;
                    return _regeneratorRuntime.awrap(res);

                  case 2:
                    return context$4$0.abrupt('return', task());

                  case 3:
                  case 'end':
                    return context$4$0.stop();
                }
              }, null, _this4);
            }, null));

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this2);
    });
  });

  describe('sending ' + numCommands + ' valid commands', function () {
    var ctx = undefined;
    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _base.instrumentsInstanceInit)());

          case 2:
            ctx = context$3$0.sent;

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _base.killAll)(ctx));

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should work', function callee$2$0() {
      var seq;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        var _this5 = this;

        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            seq = [];

            _lodash2['default'].times(numCommands, function (i) {
              seq.push(function callee$4$0() {
                return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
                  while (1) switch (context$5$0.prev = context$5$0.next) {
                    case 0:
                      context$5$0.next = 2;
                      return _regeneratorRuntime.awrap(ctx.sendCommand('(function () { return "' + i + '"})()'));

                    case 2:
                      context$5$0.t0 = i.toString();
                      context$5$0.sent.should.equal(context$5$0.t0);

                    case 4:
                    case 'end':
                      return context$5$0.stop();
                  }
                }, null, _this5);
              });
            });
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(_bluebird2['default'].reduce(seq, function callee$3$0(res, task) {
              return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                while (1) switch (context$4$0.prev = context$4$0.next) {
                  case 0:
                    context$4$0.next = 2;
                    return _regeneratorRuntime.awrap(res);

                  case 2:
                    return context$4$0.abrupt('return', task());

                  case 3:
                  case 'end':
                    return context$4$0.stop();
                }
              }, null, _this5);
            }, null));

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });

  describe('sending ' + numCommands + ' alternating valid and invalid', function () {
    var ctx = undefined;
    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _base.instrumentsInstanceInit)());

          case 2:
            ctx = context$3$0.sent;

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _base.killAll)(ctx));

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should work', function callee$2$0() {
      var seq;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        var _this6 = this;

        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            seq = [];

            _lodash2['default'].times(numCommands, function (i) {
              if (i % 2 === 0) seq.push(function callee$4$0() {
                return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
                  while (1) switch (context$5$0.prev = context$5$0.next) {
                    case 0:
                      context$5$0.next = 2;
                      return _regeneratorRuntime.awrap(ctx.sendCommand('(function () { return "' + i + '"})()'));

                    case 2:
                      context$5$0.t0 = i.toString();
                      context$5$0.sent.should.equal(context$5$0.t0);

                    case 4:
                    case 'end':
                      return context$5$0.stop();
                  }
                }, null, _this6);
              });else
                // if ((i+1)%10 === 0) console.log('sent:', (i+1));
                seq.push(function callee$4$0() {
                  return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
                    while (1) switch (context$5$0.prev = context$5$0.next) {
                      case 0:
                        context$5$0.next = 2;
                        return _regeneratorRuntime.awrap(ctx.sendCommand('(ffffunction () { return "' + i + '"})()').should.be.rejectedWith(/Unexpected token/));

                      case 2:
                      case 'end':
                        return context$5$0.stop();
                    }
                  }, null, _this6);
                });
            });
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(_bluebird2['default'].reduce(seq, function callee$3$0(res, task) {
              return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                while (1) switch (context$4$0.prev = context$4$0.next) {
                  case 0:
                    context$4$0.next = 2;
                    return _regeneratorRuntime.awrap(res);

                  case 2:
                    return context$4$0.abrupt('return', task());

                  case 3:
                  case 'end':
                    return context$4$0.stop();
                }
              }, null, _this6);
            }, null));

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });

  describe('command with big result', function () {
    var ctx = undefined;
    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _base.instrumentsInstanceInit)());

          case 2:
            ctx = context$3$0.sent;

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _base.killAll)(ctx));

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    // UIAuto code
    var configureUIAuto = function configureUIAuto() {
      $.extend($, {
        oneMamaLongString: function oneMamaLongString(n, mapping) {
          var i;
          if (!mapping) {
            mapping = [];
            for (i = 0; i < n; i++) {
              mapping.push(i);
            }
          }
          var main = "";
          for (i = 0; i < n; i++) {
            main += mapping[i % 10];
          }
          return main;
        },

        oneMamaHugeTree: function oneMamaHugeTree(n, d) {
          function addChildren(root, depth) {
            if (depth === d) return;
            root.children = {};
            var i;
            for (i = 0; i < n; i++) {
              root.children['c' + i] = { name: 'child ' + i };
              addChildren(root.children['c' + i], depth + 1);
            }
          }
          var root = { name: 'root' };
          addChildren(root, 0);
          return root;
        }

      });
    };

    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(ctx.execFunc(configureUIAuto));

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    var testN = function testN(n) {
      var s;
      return _regeneratorRuntime.async(function testN$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(ctx.sendCommand('$.oneMamaLongString(' + n + ')'));

          case 2:
            s = context$3$0.sent;

            s.should.have.length(n);
            _lodash2['default'].times(n, function (i) {
              parseInt(s[i], 10).should.equal(i % 10);
            });

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    };

    it('should work a small string', function () {
      return testN(1000);
    });

    it('should work a medium string', function () {
      return testN(100000);
    });

    it('should work a big string', function () {
      return testN(1000000);
    });

    var testNWithSpaces = function testNWithSpaces(n) {
      var s;
      return _regeneratorRuntime.async(function testNWithSpaces$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(ctx.sendCommand('$.oneMamaLongString(' + n + ', [0,1,2,3,4,\' \',6,7,8,9])'));

          case 2:
            s = context$3$0.sent;

            s.should.have.length(n);
            _lodash2['default'].times(n, function (i) {
              if (i % 10 === 5) {
                s[i].should.equal(' ');
              } else {
                parseInt(s[i], 10).should.equal(i % 10);
              }
            });

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    };

    it('should work with a big string with spaces', function () {
      return testNWithSpaces(200000);
    });

    var getHugeTree = function getHugeTree(n, d) {
      return _regeneratorRuntime.async(function getHugeTree$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            return context$3$0.abrupt('return', ctx.sendCommand('$.oneMamaHugeTree(' + n + ', ' + d + ')'));

          case 1:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    };

    it('should work with a medium tree', function callee$2$0() {
      var res;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(getHugeTree(5, 3));

          case 2:
            res = context$3$0.sent;

            res.name.should.equal('root');
            res.children.c1.children.c2.children.c3.name.should.equal('child 3');
            JSON.stringify(res).length.should.be.above(4000);

          case 6:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should work with a huge tree', function callee$2$0() {
      var res;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(getHugeTree(5, 7));

          case 2:
            res = context$3$0.sent;

            res.name.should.equal('root');
            res.children.c1.children.c2.children.c3.children.c2.name.should.equal('child 2');
            JSON.stringify(res).length.should.be.above(2000000);

          case 6:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });
});

// xcode 7 is a bit slow.

// if ((i+1)%10 === 0) console.log('sent:', (i+1));

// if ((i+1)%10 === 0) console.log('sent:', (i+1));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdWlhdXRvL2NvbW1hbmRzLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztvQkFHNkQsUUFBUTs7MkJBQzFDLGNBQWM7O3NCQUMzQixRQUFROzs7O3dCQUNSLFVBQVU7Ozs7QUFHeEIsUUFBUSxDQUFDLFVBQVUsRUFBRSxZQUFZOzs7QUFDL0Isd0JBQVcsSUFBSSxFQUFFLEVBQUMsU0FBUyxFQUFFLE9BQU8sRUFBQyxDQUFDLENBQUM7QUFDdkMsTUFBSSxXQUFXLEdBQUcsR0FBRyxDQUFDO0FBQ3RCLFFBQU0sQ0FBQztRQUVELFlBQVk7Ozs7OzJDQUFTLDhCQUFZOzs7QUFBakMsc0JBQVk7O0FBQ2hCLGNBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRTtBQUN4Qix1QkFBVyxHQUFHLEVBQUUsQ0FBQztXQUNsQjs7Ozs7OztHQUNGLENBQUMsQ0FBQzs7QUFFSCxVQUFRLENBQUMsa0JBQWtCLEVBQUUsWUFBWTs7O0FBQ3ZDLFFBQUksR0FBRyxZQUFBLENBQUM7QUFDUixVQUFNLENBQUM7Ozs7OzZDQUNPLG9DQUF5Qjs7O0FBQXJDLGVBQUc7Ozs7Ozs7S0FDSixDQUFDLENBQUM7QUFDSCxTQUFLLENBQUM7Ozs7OzZDQUNFLG1CQUFRLEdBQUcsQ0FBQzs7Ozs7OztLQUNuQixDQUFDLENBQUM7O0FBRUgsTUFBRSxDQUFDLGlEQUFpRCxFQUFFOzs7Ozs2Q0FDN0MsR0FBRyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUM7Ozs2QkFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUs7Ozs7Ozs7S0FDcEQsQ0FBQyxDQUFDOztBQUVILE1BQUUsQ0FBQyxxREFBcUQsRUFBRTs7Ozs7NkNBQ2pELEdBQUcsQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUM7Ozs2QkFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUU7Ozs7Ozs7S0FDOUQsQ0FBQyxDQUFDOztBQUVILE1BQUUsQ0FBQywrQ0FBK0MsRUFBRTs7Ozs7NkNBQzVD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QyIsImZpbGUiOiJ0ZXN0L3VpYXV0by9jb21tYW5kcy1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptb2NoYVxuLyogZ2xvYmFscyAkICovXG5cbmltcG9ydCB7IGluc3RydW1lbnRzSW5zdGFuY2VJbml0LCBnbG9iYWxJbml0LCBraWxsQWxsIH0gZnJvbSAnLi9iYXNlJztcbmltcG9ydCB7IGdldFZlcnNpb24gfSBmcm9tICdhcHBpdW0teGNvZGUnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuXG5kZXNjcmliZSgnY29tbWFuZHMnLCBmdW5jdGlvbiAoKSB7XG4gIGdsb2JhbEluaXQodGhpcywge2Jvb3RzdHJhcDogJ2Jhc2ljJ30pO1xuICBsZXQgbnVtQ29tbWFuZHMgPSAxMDA7XG4gIGJlZm9yZShhc3luYyAoKSA9PiB7XG4gICAgLy8geGNvZGUgNyBpcyBhIGJpdCBzbG93LlxuICAgIGxldCB4Y29kZVZlcnNpb24gPSBhd2FpdCBnZXRWZXJzaW9uKCk7XG4gICAgaWYgKHhjb2RlVmVyc2lvblswXSA+PSA3KSB7XG4gICAgICBudW1Db21tYW5kcyA9IDUwO1xuICAgIH1cbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3NpbXBsZSBzZXF1ZW5jZXMnLCBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IGN0eDtcbiAgICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgICAgY3R4ID0gYXdhaXQgaW5zdHJ1bWVudHNJbnN0YW5jZUluaXQoKTtcbiAgICB9KTtcbiAgICBhZnRlcihhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBraWxsQWxsKGN0eCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNlbmQgb25lIHZhbGlkIGNvbW1hbmQgcmV0dXJuaW5nIGEgdmFsdWUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAoYXdhaXQgY3R4LnNlbmRDb21tYW5kKFwiJzEyMydcIikpLnNob3VsZC5lcXVhbCgnMTIzJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNlbmQgb25lIHZhbGlkIGNvbW1hbmQgcmV0dXJuaW5nIGVtcHR5IHZhbHVlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgKGF3YWl0IGN0eC5zZW5kQ29tbWFuZChcIiQud2Fybignc3RhcnRpbmcnKVwiKSkuc2hvdWxkLmVxdWFsKCcnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmVzcG9uZCB0byBpbnZhbGlkIGNvbW1hbmQgYW5kIG5vdCBkaWUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBjdHguc2VuZENvbW1hbmQoJ2lfYW1faW52YWxpZCgpJykuc2hvdWxkLmJlLnJlamVjdGVkV2l0aCgvQ2FuJ3QgZmluZCB2YXJpYWJsZTogaV9hbV9pbnZhbGlkLyk7XG4gICAgICBhd2FpdCBjdHguc2VuZENvbW1hbmQoXCIkLndhcm4oJ3N0aWxsIGFsaXZlJylcIik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlcG9uZCB0byAxMCBjb21tYW5kcyBpbiBhIHJvdycsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBzZXEgPSBbXTtcbiAgICAgIF8udGltZXMoMTAsIGZ1bmN0aW9uIChpKSB7XG4gICAgICAgIHNlcS5wdXNoKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAoYXdhaXQgY3R4LnNlbmRDb21tYW5kKGAoZnVuY3Rpb24gKCkgeyByZXR1cm4gJHtpfX0pKClgKSkuc2hvdWxkLmVxdWFsKGkpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgQi5yZWR1Y2Uoc2VxLCBhc3luYyAocmVzLCB0YXNrKSA9PiB7XG4gICAgICAgIGF3YWl0IHJlcztcbiAgICAgICAgcmV0dXJuIHRhc2soKTtcbiAgICAgIH0sIG51bGwpO1xuICAgIH0pO1xuXG4gIH0pO1xuXG4gIGRlc2NyaWJlKGBzZW5kaW5nICR7bnVtQ29tbWFuZHN9IHZhbGlkIGNvbW1hbmRzYCwgKCkgPT4ge1xuICAgIGxldCBjdHg7XG4gICAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICAgIGN0eCA9IGF3YWl0IGluc3RydW1lbnRzSW5zdGFuY2VJbml0KCk7XG4gICAgfSk7XG4gICAgYWZ0ZXIoYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQga2lsbEFsbChjdHgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB3b3JrJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHNlcSA9IFtdO1xuICAgICAgXy50aW1lcyhudW1Db21tYW5kcywgKGkpID0+IHtcbiAgICAgICAgc2VxLnB1c2goYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIChhd2FpdCBjdHguc2VuZENvbW1hbmQoYChmdW5jdGlvbiAoKSB7IHJldHVybiBcIiR7aX1cIn0pKClgKSkuc2hvdWxkLmVxdWFsKGkudG9TdHJpbmcoKSk7XG4gICAgICAgICAgLy8gaWYgKChpKzEpJTEwID09PSAwKSBjb25zb2xlLmxvZygnc2VudDonLCAoaSsxKSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgICBhd2FpdCBCLnJlZHVjZShzZXEsIGFzeW5jIChyZXMsIHRhc2spID0+IHtcbiAgICAgICAgYXdhaXQgcmVzO1xuICAgICAgICByZXR1cm4gdGFzaygpO1xuICAgICAgfSwgbnVsbCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKGBzZW5kaW5nICR7bnVtQ29tbWFuZHN9IGFsdGVybmF0aW5nIHZhbGlkIGFuZCBpbnZhbGlkYCwgKCkgPT4ge1xuICAgIGxldCBjdHg7XG4gICAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICAgIGN0eCA9IGF3YWl0IGluc3RydW1lbnRzSW5zdGFuY2VJbml0KCk7XG4gICAgfSk7XG4gICAgYWZ0ZXIoYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQga2lsbEFsbChjdHgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB3b3JrJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHNlcSA9IFtdO1xuICAgICAgXy50aW1lcyhudW1Db21tYW5kcywgKGkpID0+IHtcbiAgICAgICAgaWYgKGklMiA9PT0gMClcbiAgICAgICAgICBzZXEucHVzaChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAoYXdhaXQgY3R4LnNlbmRDb21tYW5kKGAoZnVuY3Rpb24gKCkgeyByZXR1cm4gXCIke2l9XCJ9KSgpYCkpLnNob3VsZC5lcXVhbChpLnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgLy8gaWYgKChpKzEpJTEwID09PSAwKSBjb25zb2xlLmxvZygnc2VudDonLCAoaSsxKSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICBzZXEucHVzaChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBhd2FpdCBjdHguc2VuZENvbW1hbmQoJyhmZmZmdW5jdGlvbiAoKSB7IHJldHVybiBcIicgKyBpICsgJ1wifSkoKScpXG4gICAgICAgICAgICAgIC5zaG91bGQuYmUucmVqZWN0ZWRXaXRoKC9VbmV4cGVjdGVkIHRva2VuLyk7XG4gICAgICAgICAgICAvLyBpZiAoKGkrMSklMTAgPT09IDApIGNvbnNvbGUubG9nKCdzZW50OicsIChpKzEpKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgQi5yZWR1Y2Uoc2VxLCBhc3luYyAocmVzLCB0YXNrKSA9PiB7XG4gICAgICAgIGF3YWl0IHJlcztcbiAgICAgICAgcmV0dXJuIHRhc2soKTtcbiAgICAgIH0sIG51bGwpO1xuICAgIH0pO1xuXG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjb21tYW5kIHdpdGggYmlnIHJlc3VsdCcsICgpID0+IHtcbiAgICBsZXQgY3R4O1xuICAgIGJlZm9yZShhc3luYyAoKSA9PiB7XG4gICAgICBjdHggPSBhd2FpdCBpbnN0cnVtZW50c0luc3RhbmNlSW5pdCgpO1xuICAgIH0pO1xuICAgIGFmdGVyKGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGtpbGxBbGwoY3R4KTtcbiAgICB9KTtcblxuICAgIC8vIFVJQXV0byBjb2RlXG4gICAgbGV0IGNvbmZpZ3VyZVVJQXV0byA9ICgpID0+IHtcbiAgICAgICQuZXh0ZW5kKCQsIHtcbiAgICAgICAgb25lTWFtYUxvbmdTdHJpbmc6IGZ1bmN0aW9uIChuLCBtYXBwaW5nKSB7XG4gICAgICAgICAgdmFyIGk7XG4gICAgICAgICAgaWYgKCFtYXBwaW5nKSB7XG4gICAgICAgICAgICBtYXBwaW5nID0gW107XG4gICAgICAgICAgICBmb3IgKGk9MDsgaTxuOyBpKyspe1xuICAgICAgICAgICAgICBtYXBwaW5nLnB1c2goaSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHZhciBtYWluID0gXCJcIjtcbiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbjsgaSsrKSB7XG4gICAgICAgICAgICBtYWluICs9IG1hcHBpbmdbaSAlIDEwXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIG1haW47XG4gICAgICAgIH0sXG5cbiAgICAgICAgb25lTWFtYUh1Z2VUcmVlOiBmdW5jdGlvbiAobiwgZCkge1xuICAgICAgICAgIGZ1bmN0aW9uIGFkZENoaWxkcmVuKHJvb3QsIGRlcHRoKSB7XG4gICAgICAgICAgICBpZiAoZGVwdGggPT09IGQpIHJldHVybjtcbiAgICAgICAgICAgIHJvb3QuY2hpbGRyZW4gPSB7fTtcbiAgICAgICAgICAgIHZhciBpO1xuICAgICAgICAgICAgZm9yIChpPTA7IGk8bjsgaSsrKXtcbiAgICAgICAgICAgICAgcm9vdC5jaGlsZHJlblsnYycgKyBpXSA9IHsgbmFtZTogJ2NoaWxkICcgKyBpIH07XG4gICAgICAgICAgICAgIGFkZENoaWxkcmVuKHJvb3QuY2hpbGRyZW5bJ2MnICsgaV0sIGRlcHRoICsxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgdmFyIHJvb3QgPSB7bmFtZTogJ3Jvb3QnfTtcbiAgICAgICAgICBhZGRDaGlsZHJlbihyb290LCAwKTtcbiAgICAgICAgICByZXR1cm4gcm9vdDtcbiAgICAgICAgfSxcblxuICAgICAgfSk7XG4gICAgfTtcblxuICAgIGJlZm9yZShhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBjdHguZXhlY0Z1bmMoY29uZmlndXJlVUlBdXRvKTtcbiAgICB9KTtcblxuICAgIGxldCB0ZXN0TiA9IGFzeW5jIChuKSA9PiB7XG4gICAgICBsZXQgcyA9IGF3YWl0IGN0eC5zZW5kQ29tbWFuZChgJC5vbmVNYW1hTG9uZ1N0cmluZygke259KWApO1xuICAgICAgcy5zaG91bGQuaGF2ZS5sZW5ndGgobik7XG4gICAgICBfLnRpbWVzKG4sIGZ1bmN0aW9uIChpKSB7XG4gICAgICAgIHBhcnNlSW50KHNbaV0gLCAxMCkuc2hvdWxkLmVxdWFsKGklMTApO1xuICAgICAgfSk7XG4gICAgfTtcblxuICAgIGl0KCdzaG91bGQgd29yayBhIHNtYWxsIHN0cmluZycsICgpID0+IHtcbiAgICAgIHJldHVybiB0ZXN0TigxMDAwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgd29yayBhIG1lZGl1bSBzdHJpbmcnLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gdGVzdE4oMTAwMDAwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgd29yayBhIGJpZyBzdHJpbmcnLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gdGVzdE4oMTAwMDAwMCk7XG4gICAgfSk7XG5cbiAgICBsZXQgdGVzdE5XaXRoU3BhY2VzID0gYXN5bmMgKG4pID0+IHtcbiAgICAgIGxldCBzID0gYXdhaXQgY3R4LnNlbmRDb21tYW5kKGAkLm9uZU1hbWFMb25nU3RyaW5nKCR7bn0sIFswLDEsMiwzLDQsJyAnLDYsNyw4LDldKWApO1xuICAgICAgcy5zaG91bGQuaGF2ZS5sZW5ndGgobik7XG4gICAgICBfLnRpbWVzKG4sIGZ1bmN0aW9uIChpKSB7XG4gICAgICAgIGlmIChpJTEwID09PSA1KXtcbiAgICAgICAgICBzW2ldLnNob3VsZC5lcXVhbCgnICcpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHBhcnNlSW50KHNbaV0gLCAxMCkuc2hvdWxkLmVxdWFsKGklMTApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9O1xuXG4gICAgaXQoJ3Nob3VsZCB3b3JrIHdpdGggYSBiaWcgc3RyaW5nIHdpdGggc3BhY2VzJywgZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIHRlc3ROV2l0aFNwYWNlcygyMDAwMDApO1xuICAgIH0pO1xuXG4gICAgbGV0IGdldEh1Z2VUcmVlID0gYXN5bmMgKG4sIGQpID0+IHtcbiAgICAgIHJldHVybiBjdHguc2VuZENvbW1hbmQoYCQub25lTWFtYUh1Z2VUcmVlKCR7bn0sICR7ZH0pYCk7XG4gICAgfTtcblxuICAgIGl0KCdzaG91bGQgd29yayB3aXRoIGEgbWVkaXVtIHRyZWUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgcmVzID0gYXdhaXQgZ2V0SHVnZVRyZWUoNSwgMyk7XG4gICAgICByZXMubmFtZS5zaG91bGQuZXF1YWwoJ3Jvb3QnKTtcbiAgICAgIHJlcy5jaGlsZHJlbi5jMS5jaGlsZHJlbi5jMi5jaGlsZHJlblxuICAgICAgICAuYzMubmFtZS5zaG91bGQuZXF1YWwoJ2NoaWxkIDMnKTtcbiAgICAgIEpTT04uc3RyaW5naWZ5KHJlcykubGVuZ3RoLnNob3VsZC5iZS5hYm92ZSg0MDAwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgd29yayB3aXRoIGEgaHVnZSB0cmVlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHJlcyA9IGF3YWl0IGdldEh1Z2VUcmVlKDUsIDcpO1xuICAgICAgcmVzLm5hbWUuc2hvdWxkLmVxdWFsKCdyb290Jyk7XG4gICAgICByZXMuY2hpbGRyZW4uYzEuY2hpbGRyZW4uYzIuY2hpbGRyZW5cbiAgICAgICAgLmMzLmNoaWxkcmVuLmMyLm5hbWUuc2hvdWxkLmVxdWFsKCdjaGlsZCAyJyk7XG4gICAgICBKU09OLnN0cmluZ2lmeShyZXMpLmxlbmd0aC5zaG91bGQuYmUuYWJvdmUoMjAwMDAwMCk7XG4gICAgfSk7XG4gIH0pO1xuXG59KTtcbiJdfQ==
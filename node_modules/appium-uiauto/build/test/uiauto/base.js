'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _2 = require('../..');

var _appiumInstruments = require('appium-instruments');

var _libDynamicBootstrap = require('../../lib/dynamic-bootstrap');

var _libLogger = require('../../lib/logger');

var _libLogger2 = _interopRequireDefault(_libLogger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _appiumXcode = require('appium-xcode');

_chai2['default'].use(_chaiAsPromised2['default']);
_chai2['default'].should();

process.env.APPIUM_BOOTSTRAP_DIR = '/tmp/appium-uiauto/test/functional/bootstrap';

var rootDir = _path2['default'].resolve(__dirname, '..', '..', '..');
if (!__dirname.match(/build\/test\/uiauto$/)) {
  // we are not running tests in the `build` directory
  rootDir = _path2['default'].resolve(__dirname, '..', '..');
}

function localPrepareBootstrap(opts) {
  var env, postImports, code, vars, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, key, value;

  return _regeneratorRuntime.async(function localPrepareBootstrap$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        opts = opts || {};
        // let rootDir = path.resolve(__dirname, '..', '..', '..');

        if (!(opts.bootstrap === 'basic')) {
          context$1$0.next = 34;
          break;
        }

        env = (0, _libDynamicBootstrap.getEnv)();
        postImports = [];

        if (opts.imports && opts.imports.post) {
          postImports = opts.imports.post;
        }
        postImports = postImports.map(function (item) {
          return '#import "' + _path2['default'].resolve(rootDir, item) + '"';
        });
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(_path2['default'].resolve(rootDir, 'test', 'assets', 'base-bootstrap.js'), 'utf8'));

      case 8:
        code = context$1$0.sent;
        vars = {
          '<ROOT_DIR>': rootDir,
          '"<POST_IMPORTS>"': postImports.join('\n'),
          '<commandProxyClientPath>': env.commandProxyClientPath,
          '<nodePath>': env.nodePath,
          '<instrumentsSock>': env.instrumentsSock
        };
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 13;

        for (_iterator = _getIterator(_lodash2['default'].toPairs(vars)); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          _step$value = _slicedToArray(_step.value, 2);
          key = _step$value[0];
          value = _step$value[1];

          code = code.replace(new RegExp(key, 'g'), value);
        }
        context$1$0.next = 21;
        break;

      case 17:
        context$1$0.prev = 17;
        context$1$0.t0 = context$1$0['catch'](13);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 21:
        context$1$0.prev = 21;
        context$1$0.prev = 22;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 24:
        context$1$0.prev = 24;

        if (!_didIteratorError) {
          context$1$0.next = 27;
          break;
        }

        throw _iteratorError;

      case 27:
        return context$1$0.finish(24);

      case 28:
        return context$1$0.finish(21);

      case 29:
        context$1$0.next = 31;
        return _regeneratorRuntime.awrap((0, _2.prepareBootstrap)({
          code: code,
          isVerbose: true
        }));

      case 31:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 34:
        opts = _lodash2['default'].clone(opts);
        if (opts.chai) {
          opts.imports = {
            pre: [_path2['default'].resolve(rootDir, 'node_modules/chai/chai.js')]
          };
        }
        delete opts.chai;
        context$1$0.next = 39;
        return _regeneratorRuntime.awrap((0, _2.prepareBootstrap)(opts));

      case 39:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 40:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[13, 17, 21, 29], [22,, 24, 28]]);
}

function newInstruments(bootstrapFile) {
  var simulatorSdkAndDevice, withoutDelay, xcodeVersion;
  return _regeneratorRuntime.async(function newInstruments$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        simulatorSdkAndDevice = 'iPhone 6 (8.1 Simulator)';
        withoutDelay = true;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _appiumXcode.getVersion)(true));

      case 4:
        xcodeVersion = context$1$0.sent;

        if (xcodeVersion.versionFloat >= 7) {
          simulatorSdkAndDevice = 'iPhone 6 (8.4)';
          withoutDelay = false;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_appiumInstruments.utils.quickInstruments({
          app: _path2['default'].resolve(rootDir, 'test', 'assets', 'UICatalog.app'),
          bootstrap: bootstrapFile,
          simulatorSdkAndDevice: simulatorSdkAndDevice,
          launchTries: 2,
          withoutDelay: withoutDelay
        }));

      case 8:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function init(bootstrapFile, sock) {
  var proxy, instruments;
  return _regeneratorRuntime.async(function init$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        proxy = new _2.UIAutoClient(sock);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(newInstruments(bootstrapFile));

      case 3:
        instruments = context$1$0.sent;

        instruments.onShutdown.then(function () {
          // expected shutdown, nothing to do
        })['catch'](function callee$1$0(err) {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                _libLogger2['default'].error(err);
                context$2$0.next = 3;
                return _regeneratorRuntime.awrap(proxy.safeShutdown());

              case 3:
                throw new Error('Unexpected shutdown of instruments');

              case 4:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        }).done();
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_bluebird2['default'].all([proxy.start().then(function () {
          // everything looks good, notify instruments.
          instruments.registerLaunch();
        }), instruments.launch()]));

      case 7:
        return context$1$0.abrupt('return', { proxy: proxy, instruments: instruments });

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function killAll(ctx) {
  return _regeneratorRuntime.async(function killAll$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(ctx.instruments.shutdown());

      case 3:
        context$1$0.next = 8;
        break;

      case 5:
        context$1$0.prev = 5;
        context$1$0.t0 = context$1$0['catch'](0);

        // pass
        _libLogger2['default'].error(context$1$0.t0);

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumInstruments.utils.killAllInstruments());

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(ctx.proxy.safeShutdown());

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 5]]);
}

var bootstrapFile = undefined;

function globalInit(ctx, opts) {
  return _regeneratorRuntime.async(function globalInit$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        ctx.timeout(60000);
        before(function callee$1$0() {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(localPrepareBootstrap(opts));

              case 2:
                bootstrapFile = context$2$0.sent;

              case 3:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this2);
        });

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function instrumentsInstanceInit() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
  var ctx, cmd;
  return _regeneratorRuntime.async(function instrumentsInstanceInit$(context$1$0) {
    var _this3 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(init(bootstrapFile, opts.sock));

      case 2:
        ctx = context$1$0.sent;

        ctx.sendCommand = function callee$1$0(cmd) {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                return context$2$0.abrupt('return', ctx.proxy.sendCommand(cmd));

              case 1:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this3);
        };
        ctx.exec = ctx.sendCommand;

        ctx.execFunc = function callee$1$0(func, params) {
          var script;
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                params = params || [];
                script = '(function (){\n' + ('  var params = JSON.parse(\'' + JSON.stringify(params) + '\');\n') + ('  return (' + func.toString() + ').apply(null, params);\n') + '})();';
                return context$2$0.abrupt('return', ctx.exec(script));

              case 3:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this3);
        };

        cmd = '$.isVerbose = ' + (process.env.VERBOSE ? true : false) + ';\n';
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(ctx.exec(cmd));

      case 9:
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(ctx.execFunc(function () {
          /* global rootPage:true */
          rootPage = {};
          // click item in root page menu
          rootPage.clickMenuItem = function (partialText) {
            $.each($('tableview').children(), function (idx, child) {
              if (child.name().indexOf(partialText) >= 0) {
                $(child).tap();
                return false;
              }
            });
          };
        }));

      case 11:
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(ctx.execFunc(function () {
          /* global $ */
          $.delay(500);
          while (!$('tableview').isVisible()) {
            $.warn('waiting for page to load');
            $.delay(500);
          }
        }));

      case 13:
        return context$1$0.abrupt('return', ctx);

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.instrumentsInstanceInit = instrumentsInstanceInit;
exports.globalInit = globalInit;
exports.killAll = killAll;

// starting tests differs on Xcode 7 vs. 6

// some uiauto helpers
//# sourceMappingURL=data:application/json;base64,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R0FBRzs7Ozs7OztDQUNYOztRQUVRLHVCQUF1QixHQUF2Qix1QkFBdUI7UUFBRSxVQUFVLEdBQVYsVUFBVTtRQUFFLE9BQU8sR0FBUCxPQUFPIiwiZmlsZSI6InRlc3QvdWlhdXRvL2Jhc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IFVJQXV0b0NsaWVudCwgcHJlcGFyZUJvb3RzdHJhcCB9IGZyb20gJy4uLy4uJztcbmltcG9ydCB7IHV0aWxzIGFzIGluc3RydW1lbnRzVXRpbHMgfSBmcm9tICdhcHBpdW0taW5zdHJ1bWVudHMnO1xuaW1wb3J0IHsgZ2V0RW52IH0gZnJvbSAnLi4vLi4vbGliL2R5bmFtaWMtYm9vdHN0cmFwJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vLi4vbGliL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGdldFZlcnNpb24gfSBmcm9tICdhcHBpdW0teGNvZGUnO1xuXG5cbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcbmNoYWkuc2hvdWxkKCk7XG5cbnByb2Nlc3MuZW52LkFQUElVTV9CT09UU1RSQVBfRElSID0gJy90bXAvYXBwaXVtLXVpYXV0by90ZXN0L2Z1bmN0aW9uYWwvYm9vdHN0cmFwJztcblxubGV0IHJvb3REaXIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnLi4nKTtcbmlmICghX19kaXJuYW1lLm1hdGNoKC9idWlsZFxcL3Rlc3RcXC91aWF1dG8kLykpIHtcbiAgLy8gd2UgYXJlIG5vdCBydW5uaW5nIHRlc3RzIGluIHRoZSBgYnVpbGRgIGRpcmVjdG9yeVxuICByb290RGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvY2FsUHJlcGFyZUJvb3RzdHJhcCAob3B0cykge1xuICBvcHRzID0gb3B0cyB8fCB7fTtcbiAgLy8gbGV0IHJvb3REaXIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnLi4nKTtcbiAgaWYgKG9wdHMuYm9vdHN0cmFwID09PSAnYmFzaWMnKSB7XG4gICAgbGV0IGVudiA9IGdldEVudigpO1xuICAgIGxldCBwb3N0SW1wb3J0cyA9IFtdO1xuICAgIGlmIChvcHRzLmltcG9ydHMgJiYgb3B0cy5pbXBvcnRzLnBvc3QpIHtcbiAgICAgIHBvc3RJbXBvcnRzID0gb3B0cy5pbXBvcnRzLnBvc3Q7XG4gICAgfVxuICAgIHBvc3RJbXBvcnRzID0gcG9zdEltcG9ydHMubWFwKChpdGVtKSA9PiB7XG4gICAgICByZXR1cm4gYCNpbXBvcnQgXCIke3BhdGgucmVzb2x2ZShyb290RGlyICwgaXRlbSl9XCJgO1xuICAgIH0pO1xuICAgIGxldCBjb2RlID0gYXdhaXQgZnMucmVhZEZpbGUocGF0aC5yZXNvbHZlKFxuICAgICAgcm9vdERpciwgJ3Rlc3QnLCAnYXNzZXRzJywgJ2Jhc2UtYm9vdHN0cmFwLmpzJyksICd1dGY4Jyk7XG4gICAgbGV0IHZhcnMgPSB7XG4gICAgICAnPFJPT1RfRElSPic6IHJvb3REaXIsXG4gICAgICAnXCI8UE9TVF9JTVBPUlRTPlwiJzogcG9zdEltcG9ydHMuam9pbignXFxuJyksXG4gICAgICAnPGNvbW1hbmRQcm94eUNsaWVudFBhdGg+JzogZW52LmNvbW1hbmRQcm94eUNsaWVudFBhdGgsXG4gICAgICAnPG5vZGVQYXRoPic6IGVudi5ub2RlUGF0aCxcbiAgICAgICc8aW5zdHJ1bWVudHNTb2NrPic6IGVudi5pbnN0cnVtZW50c1NvY2tcbiAgICB9O1xuICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBfLnRvUGFpcnModmFycykpIHtcbiAgICAgIGNvZGUgPSBjb2RlLnJlcGxhY2UobmV3IFJlZ0V4cChrZXksICdnJyksIHZhbHVlKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHByZXBhcmVCb290c3RyYXAoe1xuICAgICAgY29kZTogY29kZSxcbiAgICAgIGlzVmVyYm9zZTogdHJ1ZVxuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIG9wdHMgPSBfLmNsb25lKG9wdHMpO1xuICAgIGlmIChvcHRzLmNoYWkpIHtcbiAgICAgIG9wdHMuaW1wb3J0cyA9IHtcbiAgICAgICAgcHJlOiBbcGF0aC5yZXNvbHZlKHJvb3REaXIsICdub2RlX21vZHVsZXMvY2hhaS9jaGFpLmpzJyldXG4gICAgICB9O1xuICAgIH1cbiAgICBkZWxldGUgb3B0cy5jaGFpO1xuICAgIHJldHVybiBhd2FpdCBwcmVwYXJlQm9vdHN0cmFwKG9wdHMpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIG5ld0luc3RydW1lbnRzIChib290c3RyYXBGaWxlKSB7XG4gIC8vIHN0YXJ0aW5nIHRlc3RzIGRpZmZlcnMgb24gWGNvZGUgNyB2cy4gNlxuICBsZXQgc2ltdWxhdG9yU2RrQW5kRGV2aWNlID0gJ2lQaG9uZSA2ICg4LjEgU2ltdWxhdG9yKSc7XG4gIGxldCB3aXRob3V0RGVsYXkgPSB0cnVlO1xuICBsZXQgeGNvZGVWZXJzaW9uID0gYXdhaXQgZ2V0VmVyc2lvbih0cnVlKTtcbiAgaWYgKHhjb2RlVmVyc2lvbi52ZXJzaW9uRmxvYXQgPj0gNykge1xuICAgIHNpbXVsYXRvclNka0FuZERldmljZSA9ICdpUGhvbmUgNiAoOC40KSc7XG4gICAgd2l0aG91dERlbGF5ID0gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgaW5zdHJ1bWVudHNVdGlscy5xdWlja0luc3RydW1lbnRzKHtcbiAgICBhcHA6IHBhdGgucmVzb2x2ZShyb290RGlyLCAndGVzdCcsICdhc3NldHMnLCAnVUlDYXRhbG9nLmFwcCcpLFxuICAgIGJvb3RzdHJhcDogYm9vdHN0cmFwRmlsZSxcbiAgICBzaW11bGF0b3JTZGtBbmREZXZpY2UsXG4gICAgbGF1bmNoVHJpZXM6IDIsXG4gICAgd2l0aG91dERlbGF5XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbml0IChib290c3RyYXBGaWxlLCBzb2NrKSB7XG4gIGxldCBwcm94eSA9IG5ldyBVSUF1dG9DbGllbnQoc29jayk7XG4gIGxldCBpbnN0cnVtZW50cyA9IGF3YWl0IG5ld0luc3RydW1lbnRzKGJvb3RzdHJhcEZpbGUpO1xuICBpbnN0cnVtZW50cy5vblNodXRkb3duXG4gICAgLnRoZW4oKCkgPT4ge1xuICAgICAgLy8gZXhwZWN0ZWQgc2h1dGRvd24sIG5vdGhpbmcgdG8gZG9cbiAgICB9KS5jYXRjaChhc3luYyAoZXJyKSA9PiB7XG4gICAgICBsb2cuZXJyb3IoZXJyKTtcbiAgICAgIGF3YWl0IHByb3h5LnNhZmVTaHV0ZG93bigpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmV4cGVjdGVkIHNodXRkb3duIG9mIGluc3RydW1lbnRzJyk7XG4gICAgfSkuZG9uZSgpO1xuICBhd2FpdCBCLmFsbChbXG4gICAgcHJveHkuc3RhcnQoKS50aGVuKCgpID0+IHtcbiAgICAgIC8vIGV2ZXJ5dGhpbmcgbG9va3MgZ29vZCwgbm90aWZ5IGluc3RydW1lbnRzLlxuICAgICAgaW5zdHJ1bWVudHMucmVnaXN0ZXJMYXVuY2goKTtcbiAgICB9KSxcbiAgICBpbnN0cnVtZW50cy5sYXVuY2goKVxuICBdKTtcbiAgcmV0dXJuIHtwcm94eSwgaW5zdHJ1bWVudHN9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBraWxsQWxsIChjdHgpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBjdHguaW5zdHJ1bWVudHMuc2h1dGRvd24oKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIHBhc3NcbiAgICBsb2cuZXJyb3IoZSk7XG4gIH1cbiAgYXdhaXQgaW5zdHJ1bWVudHNVdGlscy5raWxsQWxsSW5zdHJ1bWVudHMoKTtcbiAgYXdhaXQgY3R4LnByb3h5LnNhZmVTaHV0ZG93bigpO1xufVxuXG5sZXQgYm9vdHN0cmFwRmlsZTtcblxuYXN5bmMgZnVuY3Rpb24gZ2xvYmFsSW5pdCAoY3R4LCBvcHRzKSB7XG4gIGN0eC50aW1lb3V0KDYwMDAwKTtcbiAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICBib290c3RyYXBGaWxlID0gYXdhaXQgbG9jYWxQcmVwYXJlQm9vdHN0cmFwKG9wdHMpO1xuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdHJ1bWVudHNJbnN0YW5jZUluaXQgKG9wdHMgPSB7fSkge1xuICBsZXQgY3R4ID0gYXdhaXQgaW5pdChib290c3RyYXBGaWxlLCBvcHRzLnNvY2spO1xuICBjdHguc2VuZENvbW1hbmQgPSBhc3luYyAoY21kKSA9PiB7XG4gICAgcmV0dXJuIGN0eC5wcm94eS5zZW5kQ29tbWFuZChjbWQpO1xuICB9O1xuICBjdHguZXhlYyA9IGN0eC5zZW5kQ29tbWFuZDtcblxuICBjdHguZXhlY0Z1bmMgPSBhc3luYyAoZnVuYywgcGFyYW1zKSA9PiB7XG4gICAgcGFyYW1zID0gcGFyYW1zIHx8IFtdO1xuICAgIGxldCBzY3JpcHQgPVxuICAgICAgYChmdW5jdGlvbiAoKXtcXG5gICtcbiAgICAgIGAgIHZhciBwYXJhbXMgPSBKU09OLnBhcnNlKCcke0pTT04uc3RyaW5naWZ5KHBhcmFtcyl9Jyk7XFxuYCArXG4gICAgICBgICByZXR1cm4gKCR7ZnVuYy50b1N0cmluZygpfSkuYXBwbHkobnVsbCwgcGFyYW1zKTtcXG5gICtcbiAgICAgIGB9KSgpO2A7XG4gICAgcmV0dXJuIGN0eC5leGVjKHNjcmlwdCk7XG4gIH07XG5cbiAgbGV0IGNtZCA9IGAkLmlzVmVyYm9zZSA9ICR7cHJvY2Vzcy5lbnYuVkVSQk9TRSA/IHRydWUgOiBmYWxzZX07XFxuYDtcbiAgYXdhaXQgY3R4LmV4ZWMoY21kKTtcblxuICAvLyBzb21lIHVpYXV0byBoZWxwZXJzXG4gIGF3YWl0IGN0eC5leGVjRnVuYyhmdW5jdGlvbiAoKSB7XG4gICAgLyogZ2xvYmFsIHJvb3RQYWdlOnRydWUgKi9cbiAgICByb290UGFnZSA9IHt9O1xuICAgIC8vIGNsaWNrIGl0ZW0gaW4gcm9vdCBwYWdlIG1lbnVcbiAgICByb290UGFnZS5jbGlja01lbnVJdGVtID0gZnVuY3Rpb24gKHBhcnRpYWxUZXh0KSB7XG4gICAgICAkLmVhY2goJCgndGFibGV2aWV3JykuY2hpbGRyZW4oKSwgZnVuY3Rpb24gKGlkeCwgY2hpbGQpIHtcbiAgICAgICAgaWYgKGNoaWxkLm5hbWUoKS5pbmRleE9mKHBhcnRpYWxUZXh0KSA+PSAwICl7XG4gICAgICAgICAgJChjaGlsZCkudGFwKCk7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9O1xuICB9KTtcblxuICBhd2FpdCBjdHguZXhlY0Z1bmMoZnVuY3Rpb24gKCkge1xuICAgIC8qIGdsb2JhbCAkICovXG4gICAgJC5kZWxheSg1MDApO1xuICAgIHdoaWxlICghJCgndGFibGV2aWV3JykuaXNWaXNpYmxlKCkpIHtcbiAgICAgICQud2Fybignd2FpdGluZyBmb3IgcGFnZSB0byBsb2FkJyk7XG4gICAgICAkLmRlbGF5KDUwMCk7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gY3R4O1xufVxuXG5leHBvcnQgeyBpbnN0cnVtZW50c0luc3RhbmNlSW5pdCwgZ2xvYmFsSW5pdCwga2lsbEFsbCB9O1xuIl19
// The Command Proxy relays UIAuto message to and from Appium. It is also the
// UIAuto facade for Appium.
//
// The message route is the following:
// Appium <--> Command Proxy <--> Instruments
// The medium between Instruments and Command Proxy is the command-proxy-client
// script.
//
// Command Proxy --> Instruments message format: {cmd:"<CMD>"}
//
// Instruments --> Command Proxy message format:
// <one char message type>,<stringified json data>
// <stringified json data> format:
// {status:<status>, value:<result>}

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _uiautoResponse = require('./uiauto-response');

var _uiautoResponse2 = _interopRequireDefault(_uiautoResponse);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _through = require('through');

var _through2 = _interopRequireDefault(_through);

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _appiumSupport = require('appium-support');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumBaseDriver = require('appium-base-driver');

var MORE_COMMAND = '#more';
var DEFAULT_INSTRUMENTS_SOCKET = '/tmp/instruments_sock';

var UIAutoClient = (function () {
  function UIAutoClient() {
    var sock = arguments.length <= 0 || arguments[0] === undefined ? '/tmp/instruments_sock' : arguments[0];

    _classCallCheck(this, UIAutoClient);

    this.curCommand = null;
    this.onReceiveCommand = null;
    this.commandQueue = [];
    this.sock = sock;
    this.socketServer = null;
    this.hasConnected = false;
    this.currentSocket = null;
  }

  _createClass(UIAutoClient, [{
    key: 'sendCommand',
    value: function sendCommand(cmd) {
      var cmdPromise;
      return _regeneratorRuntime.async(function sendCommand$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmdPromise = new _bluebird2['default'](function (resolve, reject) {
              var cb = function cb(result) {
                // get back a JSONWP object, so decode and
                // just return the value
                if (result.status === 0) {
                  resolve(result.value);
                } else if (result.status) {
                  var jsonwpError = (0, _appiumBaseDriver.errorFromCode)(result.status, result.value);
                  reject(jsonwpError);
                } else {
                  reject(new Error(result.value));
                }
              };
              _this.commandQueue.push({ cmd: cmd, cb: cb });
              if (_lodash2['default'].isFunction(_this.onReceiveCommand)) {
                _this.onReceiveCommand();
              }
            });
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(cmdPromise);

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /*
     * Returns true if the resulting connecting is the first
     * socket connection for this proxy session
     */
  }, {
    key: 'start',
    value: function start() {
      var connectedPromise;
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            connectedPromise = new _bluebird2['default'](function (resolve) {
              var response = new _uiautoResponse2['default']();
              _this2.socketServer = _net2['default'].createServer({ allowHalfOpen: true }, function (conn) {
                if (!_this2.hasConnected) {
                  _this2.hasConnected = true;
                  _logger2['default'].info('Instruments is ready to receive commands');
                  resolve(true);
                }
                // up with strings! down with buffers!
                conn.setEncoding('utf8');

                // keep track of this so that we can destroy the socket
                // when shutting down
                _this2.currentSocket = conn;

                conn.on('close', function () {
                  _this2.currentSocket = null;
                });

                // all data goes into buffer
                conn.pipe((0, _through2['default'])(function (data) {
                  _logger2['default'].debug('Socket data received (' + data.length + ' bytes)');
                  response.addData(data);
                }));

                // when all data is in, deal with it
                conn.on('end', function () {
                  // if we are midway through handling a command
                  // we want to try out the data, getting more if necessary
                  if (_this2.curCommand) {
                    var result = response.getResult();
                    if (result && !result.needsMoreData) {
                      // if we're done altogether, call the callback associated with the command
                      _this2.curCommand.cb(result);
                      _this2.curCommand = null;
                    } else {
                      if (result) {
                        _logger2['default'].debug('Not the last chunk, trying to get more');
                      } else {
                        _logger2['default'].debug('No result received. Continuing to try to get more');
                      }
                      // add a command to the queue, to request more data
                      _this2.commandQueue.unshift({ cmd: MORE_COMMAND, cb: _this2.curCommand.cb });
                    }
                  } else {
                    _logger2['default'].debug('Got a result when we were not expecting one! Ignoring it');
                    response.resetBuffer();
                  }

                  // set up a callback to handle the next command
                  var onReceiveCommand = function onReceiveCommand() {
                    _this2.onReceiveCommand = null;
                    _this2.curCommand = _this2.commandQueue.shift();
                    _logger2['default'].debug('Sending command to instruments: ' + _this2.curCommand.cmd);
                    conn.write(JSON.stringify({ cmd: _this2.curCommand.cmd }));
                    conn.end();
                  };
                  if (_this2.commandQueue.length) {
                    onReceiveCommand();
                  } else {
                    _this2.onReceiveCommand = onReceiveCommand;
                  }
                });
              });

              _this2.socketServer.on('close', function () {
                _logger2['default'].debug('Instruments socket server was closed');
              });
            });
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(this.sock));

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(_path2['default'].dirname(this.sock)));

          case 5:

            this.socketServer.listen(this.sock);
            _logger2['default'].debug('Instruments socket server started at ' + this.sock);

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(connectedPromise);

          case 9:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'shutdown',
    value: function shutdown() {
      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // make sure clear out command cbs so we can't have any lingering cbs
            // if a socket request makes it through after exit somehow
            this.curCommand = null;
            this.onReceiveCommand = null;

            if (this.currentSocket) {
              _logger2['default'].debug('Destroying instruments client socket.');
              this.currentSocket.end();
              this.currentSocket.destroy();
              this.currentSocket = null;
            }

            if (!this.socketServer) {
              context$2$0.next = 8;
              break;
            }

            _logger2['default'].debug('Closing socket server.');
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(_bluebird2['default'].promisify(this.socketServer.close, this.socketServer)());

          case 7:
            this.socketServer = null;

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'safeShutdown',
    value: function safeShutdown() {
      return _regeneratorRuntime.async(function safeShutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Shutting down command proxy and ignoring any errors');
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.shutdown());

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].debug('Ignoring error: ' + context$2$0.t0);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }]);

  return UIAutoClient;
})();

exports.UIAutoClient = UIAutoClient;
exports.DEFAULT_INSTRUMENTS_SOCKET = DEFAULT_INSTRUMENTS_SOCKET;
exports['default'] = UIAutoClient;

// only resolve the promise when the server that is created actually connects

// remove socket file if it currently exists

// create the new socket file
//# sourceMappingURL=data:application/json;base64,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QUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO2FBQzNCOztpQkFDRyxJQUFJLENBQUMsWUFBWTs7Ozs7QUFDbkIsZ0NBQUksS0FBSyxDQUFDLHdCQUF3QixDQUFDLENBQUM7OzZDQUM5QixBQUFDLHNCQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUc7OztBQUNqRSxnQkFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7Ozs7Ozs7S0FFNUI7OztXQUVrQjs7OztBQUNqQixnQ0FBSSxLQUFLLENBQUMscURBQXFELENBQUMsQ0FBQzs7OzZDQUV6RCxJQUFJLENBQUMsUUFBUSxFQUFFOzs7Ozs7Ozs7O0FBRXJCLGdDQUFJLEtBQUsscUNBQTBCLENBQUM7Ozs7Ozs7S0FFdkM7OztTQW5KRyxZQUFZOzs7UUFzSlQsWUFBWSxHQUFaLFlBQVk7UUFBRSwwQkFBMEIsR0FBMUIsMEJBQTBCO3FCQUNsQyxZQUFZIiwiZmlsZSI6ImxpYi91aWF1dG8tY2xpZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVGhlIENvbW1hbmQgUHJveHkgcmVsYXlzIFVJQXV0byBtZXNzYWdlIHRvIGFuZCBmcm9tIEFwcGl1bS4gSXQgaXMgYWxzbyB0aGVcbi8vIFVJQXV0byBmYWNhZGUgZm9yIEFwcGl1bS5cbi8vXG4vLyBUaGUgbWVzc2FnZSByb3V0ZSBpcyB0aGUgZm9sbG93aW5nOlxuLy8gQXBwaXVtIDwtLT4gQ29tbWFuZCBQcm94eSA8LS0+IEluc3RydW1lbnRzXG4vLyBUaGUgbWVkaXVtIGJldHdlZW4gSW5zdHJ1bWVudHMgYW5kIENvbW1hbmQgUHJveHkgaXMgdGhlIGNvbW1hbmQtcHJveHktY2xpZW50XG4vLyBzY3JpcHQuXG4vL1xuLy8gQ29tbWFuZCBQcm94eSAtLT4gSW5zdHJ1bWVudHMgbWVzc2FnZSBmb3JtYXQ6IHtjbWQ6XCI8Q01EPlwifVxuLy9cbi8vIEluc3RydW1lbnRzIC0tPiBDb21tYW5kIFByb3h5IG1lc3NhZ2UgZm9ybWF0OlxuLy8gPG9uZSBjaGFyIG1lc3NhZ2UgdHlwZT4sPHN0cmluZ2lmaWVkIGpzb24gZGF0YT5cbi8vIDxzdHJpbmdpZmllZCBqc29uIGRhdGE+IGZvcm1hdDpcbi8vIHtzdGF0dXM6PHN0YXR1cz4sIHZhbHVlOjxyZXN1bHQ+fVxuXG5pbXBvcnQgVUlBdXRvUmVzcG9uc2UgZnJvbSAnLi91aWF1dG8tcmVzcG9uc2UnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgdGhyb3VnaCBmcm9tICd0aHJvdWdoJztcbmltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCB7IG1rZGlycCwgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvckZyb21Db2RlIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcblxuXG5jb25zdCBNT1JFX0NPTU1BTkQgPSAnI21vcmUnO1xuY29uc3QgREVGQVVMVF9JTlNUUlVNRU5UU19TT0NLRVQgPSAnL3RtcC9pbnN0cnVtZW50c19zb2NrJztcblxuY2xhc3MgVUlBdXRvQ2xpZW50IHtcbiAgY29uc3RydWN0b3IgKHNvY2sgPSAnL3RtcC9pbnN0cnVtZW50c19zb2NrJykge1xuICAgIHRoaXMuY3VyQ29tbWFuZCA9IG51bGw7XG4gICAgdGhpcy5vblJlY2VpdmVDb21tYW5kID0gbnVsbDtcbiAgICB0aGlzLmNvbW1hbmRRdWV1ZSA9IFtdO1xuICAgIHRoaXMuc29jayA9IHNvY2s7XG4gICAgdGhpcy5zb2NrZXRTZXJ2ZXIgPSBudWxsO1xuICAgIHRoaXMuaGFzQ29ubmVjdGVkID0gZmFsc2U7XG4gICAgdGhpcy5jdXJyZW50U29ja2V0ID0gbnVsbDtcbiAgfVxuXG4gIGFzeW5jIHNlbmRDb21tYW5kIChjbWQpIHtcbiAgICBsZXQgY21kUHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxldCBjYiA9IChyZXN1bHQpID0+IHtcbiAgICAgICAgLy8gZ2V0IGJhY2sgYSBKU09OV1Agb2JqZWN0LCBzbyBkZWNvZGUgYW5kXG4gICAgICAgIC8vIGp1c3QgcmV0dXJuIHRoZSB2YWx1ZVxuICAgICAgICBpZiAocmVzdWx0LnN0YXR1cyA9PT0gMCkge1xuICAgICAgICAgIHJlc29sdmUocmVzdWx0LnZhbHVlKTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQuc3RhdHVzKSB7XG4gICAgICAgICAgbGV0IGpzb253cEVycm9yID0gZXJyb3JGcm9tQ29kZShyZXN1bHQuc3RhdHVzLCByZXN1bHQudmFsdWUpO1xuICAgICAgICAgIHJlamVjdChqc29ud3BFcnJvcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihyZXN1bHQudmFsdWUpKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIHRoaXMuY29tbWFuZFF1ZXVlLnB1c2goe2NtZCwgY2J9KTtcbiAgICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5vblJlY2VpdmVDb21tYW5kKSkge1xuICAgICAgICB0aGlzLm9uUmVjZWl2ZUNvbW1hbmQoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gYXdhaXQgY21kUHJvbWlzZTtcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgcmVzdWx0aW5nIGNvbm5lY3RpbmcgaXMgdGhlIGZpcnN0XG4gICAqIHNvY2tldCBjb25uZWN0aW9uIGZvciB0aGlzIHByb3h5IHNlc3Npb25cbiAgICovXG4gIGFzeW5jIHN0YXJ0ICgpIHtcbiAgICAvLyBvbmx5IHJlc29sdmUgdGhlIHByb21pc2Ugd2hlbiB0aGUgc2VydmVyIHRoYXQgaXMgY3JlYXRlZCBhY3R1YWxseSBjb25uZWN0c1xuICAgIGxldCBjb25uZWN0ZWRQcm9taXNlID0gbmV3IEIoKHJlc29sdmUpID0+IHtcbiAgICAgIGxldCByZXNwb25zZSA9IG5ldyBVSUF1dG9SZXNwb25zZSgpO1xuICAgICAgdGhpcy5zb2NrZXRTZXJ2ZXIgPSBuZXQuY3JlYXRlU2VydmVyKHthbGxvd0hhbGZPcGVuOiB0cnVlfSwgKGNvbm4pID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLmhhc0Nvbm5lY3RlZCkge1xuICAgICAgICAgIHRoaXMuaGFzQ29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICBsb2cuaW5mbygnSW5zdHJ1bWVudHMgaXMgcmVhZHkgdG8gcmVjZWl2ZSBjb21tYW5kcycpO1xuICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gdXAgd2l0aCBzdHJpbmdzISBkb3duIHdpdGggYnVmZmVycyFcbiAgICAgICAgY29ubi5zZXRFbmNvZGluZygndXRmOCcpO1xuXG4gICAgICAgIC8vIGtlZXAgdHJhY2sgb2YgdGhpcyBzbyB0aGF0IHdlIGNhbiBkZXN0cm95IHRoZSBzb2NrZXRcbiAgICAgICAgLy8gd2hlbiBzaHV0dGluZyBkb3duXG4gICAgICAgIHRoaXMuY3VycmVudFNvY2tldCA9IGNvbm47XG5cbiAgICAgICAgY29ubi5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5jdXJyZW50U29ja2V0ID0gbnVsbDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gYWxsIGRhdGEgZ29lcyBpbnRvIGJ1ZmZlclxuICAgICAgICBjb25uLnBpcGUodGhyb3VnaCgoZGF0YSkgPT4ge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgU29ja2V0IGRhdGEgcmVjZWl2ZWQgKCR7ZGF0YS5sZW5ndGh9IGJ5dGVzKWApO1xuICAgICAgICAgIHJlc3BvbnNlLmFkZERhdGEoZGF0YSk7XG4gICAgICAgIH0pKTtcblxuICAgICAgICAvLyB3aGVuIGFsbCBkYXRhIGlzIGluLCBkZWFsIHdpdGggaXRcbiAgICAgICAgY29ubi5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgIC8vIGlmIHdlIGFyZSBtaWR3YXkgdGhyb3VnaCBoYW5kbGluZyBhIGNvbW1hbmRcbiAgICAgICAgICAvLyB3ZSB3YW50IHRvIHRyeSBvdXQgdGhlIGRhdGEsIGdldHRpbmcgbW9yZSBpZiBuZWNlc3NhcnlcbiAgICAgICAgICBpZiAodGhpcy5jdXJDb21tYW5kKSB7XG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gcmVzcG9uc2UuZ2V0UmVzdWx0KCk7XG4gICAgICAgICAgICBpZiAocmVzdWx0ICYmICFyZXN1bHQubmVlZHNNb3JlRGF0YSkge1xuICAgICAgICAgICAgICAvLyBpZiB3ZSdyZSBkb25lIGFsdG9nZXRoZXIsIGNhbGwgdGhlIGNhbGxiYWNrIGFzc29jaWF0ZWQgd2l0aCB0aGUgY29tbWFuZFxuICAgICAgICAgICAgICB0aGlzLmN1ckNvbW1hbmQuY2IocmVzdWx0KTtcbiAgICAgICAgICAgICAgdGhpcy5jdXJDb21tYW5kID0gbnVsbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICBsb2cuZGVidWcoJ05vdCB0aGUgbGFzdCBjaHVuaywgdHJ5aW5nIHRvIGdldCBtb3JlJyk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKCdObyByZXN1bHQgcmVjZWl2ZWQuIENvbnRpbnVpbmcgdG8gdHJ5IHRvIGdldCBtb3JlJyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgLy8gYWRkIGEgY29tbWFuZCB0byB0aGUgcXVldWUsIHRvIHJlcXVlc3QgbW9yZSBkYXRhXG4gICAgICAgICAgICAgIHRoaXMuY29tbWFuZFF1ZXVlLnVuc2hpZnQoe2NtZDogTU9SRV9DT01NQU5ELCBjYjogdGhpcy5jdXJDb21tYW5kLmNifSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnR290IGEgcmVzdWx0IHdoZW4gd2Ugd2VyZSBub3QgZXhwZWN0aW5nIG9uZSEgSWdub3JpbmcgaXQnKTtcbiAgICAgICAgICAgIHJlc3BvbnNlLnJlc2V0QnVmZmVyKCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gc2V0IHVwIGEgY2FsbGJhY2sgdG8gaGFuZGxlIHRoZSBuZXh0IGNvbW1hbmRcbiAgICAgICAgICBsZXQgb25SZWNlaXZlQ29tbWFuZCA9ICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMub25SZWNlaXZlQ29tbWFuZCA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLmN1ckNvbW1hbmQgPSB0aGlzLmNvbW1hbmRRdWV1ZS5zaGlmdCgpO1xuICAgICAgICAgICAgbG9nLmRlYnVnKGBTZW5kaW5nIGNvbW1hbmQgdG8gaW5zdHJ1bWVudHM6ICR7dGhpcy5jdXJDb21tYW5kLmNtZH1gKTtcbiAgICAgICAgICAgIGNvbm4ud3JpdGUoSlNPTi5zdHJpbmdpZnkoe2NtZDogdGhpcy5jdXJDb21tYW5kLmNtZH0pKTtcbiAgICAgICAgICAgIGNvbm4uZW5kKCk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICBpZiAodGhpcy5jb21tYW5kUXVldWUubGVuZ3RoKSB7XG4gICAgICAgICAgICBvblJlY2VpdmVDb21tYW5kKCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMub25SZWNlaXZlQ29tbWFuZCA9IG9uUmVjZWl2ZUNvbW1hbmQ7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLnNvY2tldFNlcnZlci5vbignY2xvc2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnSW5zdHJ1bWVudHMgc29ja2V0IHNlcnZlciB3YXMgY2xvc2VkJyk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIC8vIHJlbW92ZSBzb2NrZXQgZmlsZSBpZiBpdCBjdXJyZW50bHkgZXhpc3RzXG4gICAgYXdhaXQgZnMucmltcmFmKHRoaXMuc29jayk7XG5cbiAgICAvLyBjcmVhdGUgdGhlIG5ldyBzb2NrZXQgZmlsZVxuICAgIGF3YWl0IG1rZGlycChwYXRoLmRpcm5hbWUodGhpcy5zb2NrKSk7XG5cbiAgICB0aGlzLnNvY2tldFNlcnZlci5saXN0ZW4odGhpcy5zb2NrKTtcbiAgICBsb2cuZGVidWcoYEluc3RydW1lbnRzIHNvY2tldCBzZXJ2ZXIgc3RhcnRlZCBhdCAke3RoaXMuc29ja31gKTtcblxuICAgIHJldHVybiBhd2FpdCBjb25uZWN0ZWRQcm9taXNlO1xuICB9XG5cbiAgYXN5bmMgc2h1dGRvd24gKCkge1xuICAgIC8vIG1ha2Ugc3VyZSBjbGVhciBvdXQgY29tbWFuZCBjYnMgc28gd2UgY2FuJ3QgaGF2ZSBhbnkgbGluZ2VyaW5nIGNic1xuICAgIC8vIGlmIGEgc29ja2V0IHJlcXVlc3QgbWFrZXMgaXQgdGhyb3VnaCBhZnRlciBleGl0IHNvbWVob3dcbiAgICB0aGlzLmN1ckNvbW1hbmQgPSBudWxsO1xuICAgIHRoaXMub25SZWNlaXZlQ29tbWFuZCA9IG51bGw7XG5cbiAgICBpZiAodGhpcy5jdXJyZW50U29ja2V0KSB7XG4gICAgICBsb2cuZGVidWcoJ0Rlc3Ryb3lpbmcgaW5zdHJ1bWVudHMgY2xpZW50IHNvY2tldC4nKTtcbiAgICAgIHRoaXMuY3VycmVudFNvY2tldC5lbmQoKTtcbiAgICAgIHRoaXMuY3VycmVudFNvY2tldC5kZXN0cm95KCk7XG4gICAgICB0aGlzLmN1cnJlbnRTb2NrZXQgPSBudWxsO1xuICAgIH1cbiAgICBpZiAodGhpcy5zb2NrZXRTZXJ2ZXIpIHtcbiAgICAgIGxvZy5kZWJ1ZygnQ2xvc2luZyBzb2NrZXQgc2VydmVyLicpO1xuICAgICAgYXdhaXQgKEIucHJvbWlzaWZ5KHRoaXMuc29ja2V0U2VydmVyLmNsb3NlLCB0aGlzLnNvY2tldFNlcnZlcikpKCk7XG4gICAgICB0aGlzLnNvY2tldFNlcnZlciA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2FmZVNodXRkb3duICgpIHtcbiAgICBsb2cuZGVidWcoJ1NodXR0aW5nIGRvd24gY29tbWFuZCBwcm94eSBhbmQgaWdub3JpbmcgYW55IGVycm9ycycpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnNodXRkb3duKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZGVidWcoYElnbm9yaW5nIGVycm9yOiAke2Vycn1gKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgVUlBdXRvQ2xpZW50LCBERUZBVUxUX0lOU1RSVU1FTlRTX1NPQ0tFVCB9O1xuZXhwb3J0IGRlZmF1bHQgVUlBdXRvQ2xpZW50O1xuIl19
'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _teen_process = require('teen_process');

var _appiumSupport = require('appium-support');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _instruments = require('./instruments');

var _instruments2 = _interopRequireDefault(_instruments);

var rootDir = _path2['default'].resolve(__dirname, '../..');
var INST_STALL_TIMEOUT = 12000;

function getInstrumentsPath() {
  var instrumentsPath, _ref, stdout;

  return _regeneratorRuntime.async(function getInstrumentsPath$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        instrumentsPath = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', ['-find', 'instruments']));

      case 4:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;

        instrumentsPath = (stdout || '').trim().replace('\n$', '');
        context$1$0.next = 12;
        break;

      case 9:
        context$1$0.prev = 9;
        context$1$0.t0 = context$1$0['catch'](1);

        if (context$1$0.t0) _logger2['default'].error(context$1$0.t0.message);

      case 12:
        if (!instrumentsPath) {
          _logger2['default'].errorAndThrow('Could not find the instruments binary. Please ensure ' + '`xcrun -find instruments` can locate it.');
        }
        _logger2['default'].debug('Instruments is at: ' + instrumentsPath);
        return context$1$0.abrupt('return', instrumentsPath);

      case 15:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 9]]);
}

function getAvailableDevices() {
  var timeout = arguments.length <= 0 || arguments[0] === undefined ? INST_STALL_TIMEOUT : arguments[0];

  var instrumentsPath, opts, lines, _ref2, stdout, devices;

  return _regeneratorRuntime.async(function getAvailableDevices$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Getting list of devices instruments supports');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(getInstrumentsPath());

      case 3:
        instrumentsPath = context$1$0.sent;
        opts = { timeout: timeout };
        lines = undefined;
        context$1$0.prev = 6;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(instrumentsPath, ['-s', 'devices'], opts));

      case 9:
        _ref2 = context$1$0.sent;
        stdout = _ref2.stdout;

        lines = stdout.split('\n');
        context$1$0.next = 17;
        break;

      case 14:
        context$1$0.prev = 14;
        context$1$0.t0 = context$1$0['catch'](6);

        _logger2['default'].errorAndThrow('Failed getting devices, err: ' + context$1$0.t0 + '.');

      case 17:
        devices = lines.filter(function (line) {
          // https://regex101.com/r/aE6aS3/6
          return (/^.+ \(\d+\.(\d+\.)?\d+( Simulator)?\) \[.+\]( \(Simulator\))?$/.test(line)
          );
        });

        _logger2['default'].debug('Available devices: ' + devices);
        return context$1$0.abrupt('return', devices);

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 14]]);
}

function killAllInstruments() {
  return _regeneratorRuntime.async(function killAllInstruments$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Killing all instruments');
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('pkill', ['-f', 'instruments']));

      case 4:
        context$1$0.next = 8;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](1);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 6]]);
}

function cleanAllTraces() {
  return _regeneratorRuntime.async(function cleanAllTraces$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!process.env.CLEAN_TRACES) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf('instrumentscli*.trace'));

      case 4:
        context$1$0.next = 8;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](1);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 6]]);
}

function parseLaunchTimeout(launchTimeout) {
  // number or object like { global: 40000, afterSimLaunch: 5000 }
  // may also parse JSON strings.
  if (_lodash2['default'].isString(launchTimeout)) {
    try {
      launchTimeout = JSON.parse(launchTimeout);
    } catch (err) {
      _logger2['default'].warn('Invalid launch timeout: ' + launchTimeout);
    }
  }
  if (_lodash2['default'].isNumber(launchTimeout)) {
    launchTimeout = {
      global: launchTimeout
    };
  }
  return launchTimeout;
}

function getIwdPath(xcodeMajorVersion) {
  var thirdpartyPath, iwdPath;
  return _regeneratorRuntime.async(function getIwdPath$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        thirdpartyPath = _path2['default'].resolve(rootDir, 'thirdparty');
        iwdPath = _path2['default'].resolve(thirdpartyPath, 'iwd' + xcodeMajorVersion);
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(iwdPath));

      case 4:
        if (context$1$0.sent) {
          context$1$0.next = 6;
          break;
        }

        iwdPath = _path2['default'].resolve(thirdpartyPath, 'iwd');

      case 6:
        _logger2['default'].debug('Found Insruments-Without-Delay: ' + iwdPath);
        return context$1$0.abrupt('return', iwdPath);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

// this function launches an instruments test with a default test
// that immediately passes. In this way we can start a simulator
// and be notified when it completely launches
function quickLaunch(udid) {
  var appPath = arguments.length <= 1 || arguments[1] === undefined ? _path2['default'].resolve(__dirname, '..', '..', 'assets', 'TestApp.app') : arguments[1];
  var traceTemplatePath, scriptPath, traceDocument, resultsPath, args;
  return _regeneratorRuntime.async(function quickLaunch$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getAutomationTraceTemplatePath());

      case 2:
        traceTemplatePath = context$1$0.sent;
        scriptPath = _path2['default'].resolve(__dirname, '..', '..', 'assets', 'blank_instruments_test.js');
        traceDocument = _path2['default'].resolve('/', 'tmp', 'testTrace.trace');
        resultsPath = _path2['default'].resolve('/', 'tmp');
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(traceDocument));

      case 8:
        args = ['instruments', '-D', traceDocument, '-t', traceTemplatePath, '-w', udid, appPath, '-e', 'UIASCRIPT', scriptPath, '-e', 'UIARESULTSPATH', resultsPath];

        _logger2['default'].debug('Running command: \'xcrun ' + args.join(' ') + '\'');
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', args));

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function quickInstruments() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
  var xcodeTraceTemplatePath;
  return _regeneratorRuntime.async(function quickInstruments$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        opts = _lodash2['default'].cloneDeep(opts);
        context$1$0.t0 = opts.xcodeTraceTemplatePath;

        if (context$1$0.t0) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getAutomationTraceTemplatePath());

      case 5:
        context$1$0.t0 = context$1$0.sent;

      case 6:
        xcodeTraceTemplatePath = context$1$0.t0;

        _lodash2['default'].defaults(opts, {
          launchTimeout: 60000,
          template: xcodeTraceTemplatePath,
          withoutDelay: true,
          xcodeVersion: '8.1',
          webSocket: null,
          flakeyRetries: true,
          logNoColors: false
        });
        return context$1$0.abrupt('return', new _instruments2['default'](opts));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.rootDir = rootDir;
exports.killAllInstruments = killAllInstruments;
exports.cleanAllTraces = cleanAllTraces;
exports.getInstrumentsPath = getInstrumentsPath;
exports.getAvailableDevices = getAvailableDevices;
exports.parseLaunchTimeout = parseLaunchTimeout;
exports.getIwdPath = getIwdPath;
exports.quickLaunch = quickLaunch;
exports.quickInstruments = quickInstruments;

// the trace document can be in a weird state
// but we never do anything with it, so delete
//# sourceMappingURL=data:application/json;base64,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RUFBRSxJQUFJLEVBQ1YsT0FBTyxFQUNQLElBQUksRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUM3QixJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxDQUFDOztBQUNqRCw0QkFBSSxLQUFLLCtCQUE0QixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFJLENBQUM7O3lDQUNsRCx3QkFBSyxPQUFPLEVBQUUsSUFBSSxDQUFDOzs7Ozs7O0NBQzFCOztBQUVELFNBQWUsZ0JBQWdCO01BQUUsSUFBSSx5REFBRyxFQUFFO01BRXBDLHNCQUFzQjs7OztBQUQxQixZQUFJLEdBQUcsb0JBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO3lCQUNJLElBQUksQ0FBQyxzQkFBc0I7Ozs7Ozs7O3lDQUM5Qyx5QkFBTSw4QkFBOEIsRUFBRTs7Ozs7O0FBRDVDLDhCQUFzQjs7QUFFMUIsNEJBQUUsUUFBUSxDQUFDLElBQUksRUFBRTtBQUNmLHVCQUFhLEVBQUUsS0FBSztBQUNwQixrQkFBUSxFQUFFLHNCQUFzQjtBQUNoQyxzQkFBWSxFQUFFLElBQUk7QUFDbEIsc0JBQVksRUFBRSxLQUFLO0FBQ25CLG1CQUFTLEVBQUUsSUFBSTtBQUNmLHVCQUFhLEVBQUUsSUFBSTtBQUNuQixxQkFBVyxFQUFFLEtBQUs7U0FDbkIsQ0FBQyxDQUFDOzRDQUNJLDZCQUFnQixJQUFJLENBQUM7Ozs7Ozs7Q0FDN0I7O1FBRVEsT0FBTyxHQUFQLE9BQU87UUFBRSxrQkFBa0IsR0FBbEIsa0JBQWtCO1FBQUUsY0FBYyxHQUFkLGNBQWM7UUFBRSxrQkFBa0IsR0FBbEIsa0JBQWtCO1FBQy9ELG1CQUFtQixHQUFuQixtQkFBbUI7UUFBRSxrQkFBa0IsR0FBbEIsa0JBQWtCO1FBQUUsVUFBVSxHQUFWLFVBQVU7UUFBRSxXQUFXLEdBQVgsV0FBVztRQUNoRSxnQkFBZ0IsR0FBaEIsZ0JBQWdCIiwiZmlsZSI6ImxpYi91dGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHhjb2RlIGZyb20gJ2FwcGl1bS14Y29kZSc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEluc3RydW1lbnRzIGZyb20gJy4vaW5zdHJ1bWVudHMnO1xuXG5cbmNvbnN0IHJvb3REaXIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4nKTtcbmNvbnN0IElOU1RfU1RBTExfVElNRU9VVCA9IDEyMDAwO1xuXG5hc3luYyBmdW5jdGlvbiBnZXRJbnN0cnVtZW50c1BhdGggKCkge1xuICBsZXQgaW5zdHJ1bWVudHNQYXRoO1xuICB0cnkge1xuICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3hjcnVuJywgWyctZmluZCcsICdpbnN0cnVtZW50cyddKTtcbiAgICBpbnN0cnVtZW50c1BhdGggPSAoc3Rkb3V0IHx8ICcnKS50cmltKCkucmVwbGFjZSgnXFxuJCcsICcnKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGVycikgbG9nLmVycm9yKGVyci5tZXNzYWdlKTtcbiAgfVxuICBpZiAoIWluc3RydW1lbnRzUGF0aCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdDb3VsZCBub3QgZmluZCB0aGUgaW5zdHJ1bWVudHMgYmluYXJ5LiBQbGVhc2UgZW5zdXJlICcgK1xuICAgICAgICAgICAgICAgICAgICAgICdgeGNydW4gLWZpbmQgaW5zdHJ1bWVudHNgIGNhbiBsb2NhdGUgaXQuJyk7XG4gIH1cbiAgbG9nLmRlYnVnKGBJbnN0cnVtZW50cyBpcyBhdDogJHtpbnN0cnVtZW50c1BhdGh9YCk7XG4gIHJldHVybiBpbnN0cnVtZW50c1BhdGg7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEF2YWlsYWJsZURldmljZXMgKHRpbWVvdXQgPSBJTlNUX1NUQUxMX1RJTUVPVVQpIHtcbiAgbG9nLmRlYnVnKCdHZXR0aW5nIGxpc3Qgb2YgZGV2aWNlcyBpbnN0cnVtZW50cyBzdXBwb3J0cycpO1xuICBsZXQgaW5zdHJ1bWVudHNQYXRoID0gYXdhaXQgZ2V0SW5zdHJ1bWVudHNQYXRoKCk7XG4gIGxldCBvcHRzID0ge3RpbWVvdXR9O1xuICBsZXQgbGluZXM7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhpbnN0cnVtZW50c1BhdGgsIFsnLXMnLCAnZGV2aWNlcyddLCBvcHRzKTtcbiAgICBsaW5lcyA9IHN0ZG91dC5zcGxpdCgnXFxuJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBGYWlsZWQgZ2V0dGluZyBkZXZpY2VzLCBlcnI6ICR7ZXJyfS5gKTtcbiAgfVxuICBsZXQgZGV2aWNlcyA9IGxpbmVzLmZpbHRlcigobGluZSkgPT4ge1xuICAgIC8vIGh0dHBzOi8vcmVnZXgxMDEuY29tL3IvYUU2YVMzLzZcbiAgICByZXR1cm4gL14uKyBcXChcXGQrXFwuKFxcZCtcXC4pP1xcZCsoIFNpbXVsYXRvcik/XFwpIFxcWy4rXFxdKCBcXChTaW11bGF0b3JcXCkpPyQvLnRlc3QobGluZSk7XG4gIH0pO1xuICBsb2cuZGVidWcoYEF2YWlsYWJsZSBkZXZpY2VzOiAke2RldmljZXN9YCk7XG4gIHJldHVybiBkZXZpY2VzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBraWxsQWxsSW5zdHJ1bWVudHMgKCkge1xuICBsb2cuZGVidWcoJ0tpbGxpbmcgYWxsIGluc3RydW1lbnRzJyk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygncGtpbGwnLCAgWyctZicsICdpbnN0cnVtZW50cyddKTtcbiAgfSBjYXRjaCAoaWduKSB7fVxufVxuXG5hc3luYyBmdW5jdGlvbiBjbGVhbkFsbFRyYWNlcyAoKSB7XG4gIGlmIChwcm9jZXNzLmVudi5DTEVBTl9UUkFDRVMpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKCdpbnN0cnVtZW50c2NsaSoudHJhY2UnKTtcbiAgICB9IGNhdGNoIChpZ24pIHt9XG4gIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VMYXVuY2hUaW1lb3V0IChsYXVuY2hUaW1lb3V0KSB7XG4gIC8vIG51bWJlciBvciBvYmplY3QgbGlrZSB7IGdsb2JhbDogNDAwMDAsIGFmdGVyU2ltTGF1bmNoOiA1MDAwIH1cbiAgLy8gbWF5IGFsc28gcGFyc2UgSlNPTiBzdHJpbmdzLlxuICBpZiAoXy5pc1N0cmluZyhsYXVuY2hUaW1lb3V0KSkge1xuICAgIHRyeSB7XG4gICAgICBsYXVuY2hUaW1lb3V0ID0gSlNPTi5wYXJzZShsYXVuY2hUaW1lb3V0KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBJbnZhbGlkIGxhdW5jaCB0aW1lb3V0OiAke2xhdW5jaFRpbWVvdXR9YCk7XG4gICAgfVxuICB9XG4gIGlmIChfLmlzTnVtYmVyKGxhdW5jaFRpbWVvdXQpKSB7XG4gICAgbGF1bmNoVGltZW91dCA9IHtcbiAgICAgIGdsb2JhbDogbGF1bmNoVGltZW91dFxuICAgIH07XG4gIH1cbiAgcmV0dXJuIGxhdW5jaFRpbWVvdXQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEl3ZFBhdGggKHhjb2RlTWFqb3JWZXJzaW9uKSB7XG4gIGxldCB0aGlyZHBhcnR5UGF0aCA9IHBhdGgucmVzb2x2ZShyb290RGlyLCAndGhpcmRwYXJ0eScpO1xuICBsZXQgaXdkUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlyZHBhcnR5UGF0aCwgYGl3ZCR7eGNvZGVNYWpvclZlcnNpb259YCk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGl3ZFBhdGgpKSB7XG4gICAgaXdkUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlyZHBhcnR5UGF0aCwgJ2l3ZCcpO1xuICB9XG4gIGxvZy5kZWJ1ZyhgRm91bmQgSW5zcnVtZW50cy1XaXRob3V0LURlbGF5OiAke2l3ZFBhdGh9YCk7XG4gIHJldHVybiBpd2RQYXRoO1xufVxuXG4vLyB0aGlzIGZ1bmN0aW9uIGxhdW5jaGVzIGFuIGluc3RydW1lbnRzIHRlc3Qgd2l0aCBhIGRlZmF1bHQgdGVzdFxuLy8gdGhhdCBpbW1lZGlhdGVseSBwYXNzZXMuIEluIHRoaXMgd2F5IHdlIGNhbiBzdGFydCBhIHNpbXVsYXRvclxuLy8gYW5kIGJlIG5vdGlmaWVkIHdoZW4gaXQgY29tcGxldGVseSBsYXVuY2hlc1xuYXN5bmMgZnVuY3Rpb24gcXVpY2tMYXVuY2ggKHVkaWQsIGFwcFBhdGggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnYXNzZXRzJywgJ1Rlc3RBcHAuYXBwJykpIHtcbiAgbGV0IHRyYWNlVGVtcGxhdGVQYXRoID0gYXdhaXQgeGNvZGUuZ2V0QXV0b21hdGlvblRyYWNlVGVtcGxhdGVQYXRoKCk7XG4gIGxldCBzY3JpcHRQYXRoID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2Fzc2V0cycsICdibGFua19pbnN0cnVtZW50c190ZXN0LmpzJyk7XG4gIGxldCB0cmFjZURvY3VtZW50ID0gcGF0aC5yZXNvbHZlKCcvJywgJ3RtcCcsICd0ZXN0VHJhY2UudHJhY2UnKTtcbiAgbGV0IHJlc3VsdHNQYXRoID0gcGF0aC5yZXNvbHZlKCcvJywgJ3RtcCcpO1xuXG4gIC8vIHRoZSB0cmFjZSBkb2N1bWVudCBjYW4gYmUgaW4gYSB3ZWlyZCBzdGF0ZVxuICAvLyBidXQgd2UgbmV2ZXIgZG8gYW55dGhpbmcgd2l0aCBpdCwgc28gZGVsZXRlXG4gIGF3YWl0IGZzLnJpbXJhZih0cmFjZURvY3VtZW50KTtcblxuICBsZXQgYXJncyA9IFsnaW5zdHJ1bWVudHMnLFxuICAgICAgICAgICAgICAnLUQnLCB0cmFjZURvY3VtZW50LFxuICAgICAgICAgICAgICAgJy10JywgdHJhY2VUZW1wbGF0ZVBhdGgsXG4gICAgICAgICAgICAgICAnLXcnLCB1ZGlkLFxuICAgICAgICAgICAgICAgYXBwUGF0aCxcbiAgICAgICAgICAgICAgICctZScsICdVSUFTQ1JJUFQnLCBzY3JpcHRQYXRoLFxuICAgICAgICAgICAgICAgJy1lJywgJ1VJQVJFU1VMVFNQQVRIJywgcmVzdWx0c1BhdGhdO1xuICBsb2cuZGVidWcoYFJ1bm5pbmcgY29tbWFuZDogJ3hjcnVuICR7YXJncy5qb2luKCcgJyl9J2ApO1xuICBhd2FpdCBleGVjKCd4Y3J1bicsIGFyZ3MpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBxdWlja0luc3RydW1lbnRzIChvcHRzID0ge30pIHtcbiAgb3B0cyA9IF8uY2xvbmVEZWVwKG9wdHMpO1xuICBsZXQgeGNvZGVUcmFjZVRlbXBsYXRlUGF0aCA9IG9wdHMueGNvZGVUcmFjZVRlbXBsYXRlUGF0aCB8fFxuICAgICAgYXdhaXQgeGNvZGUuZ2V0QXV0b21hdGlvblRyYWNlVGVtcGxhdGVQYXRoKCk7XG4gIF8uZGVmYXVsdHMob3B0cywge1xuICAgIGxhdW5jaFRpbWVvdXQ6IDYwMDAwLFxuICAgIHRlbXBsYXRlOiB4Y29kZVRyYWNlVGVtcGxhdGVQYXRoLFxuICAgIHdpdGhvdXREZWxheTogdHJ1ZSxcbiAgICB4Y29kZVZlcnNpb246ICc4LjEnLFxuICAgIHdlYlNvY2tldDogbnVsbCxcbiAgICBmbGFrZXlSZXRyaWVzOiB0cnVlLFxuICAgIGxvZ05vQ29sb3JzOiBmYWxzZSxcbiAgfSk7XG4gIHJldHVybiBuZXcgSW5zdHJ1bWVudHMob3B0cyk7XG59XG5cbmV4cG9ydCB7IHJvb3REaXIsIGtpbGxBbGxJbnN0cnVtZW50cywgY2xlYW5BbGxUcmFjZXMsIGdldEluc3RydW1lbnRzUGF0aCxcbiAgICAgICAgIGdldEF2YWlsYWJsZURldmljZXMsIHBhcnNlTGF1bmNoVGltZW91dCwgZ2V0SXdkUGF0aCwgcXVpY2tMYXVuY2gsXG4gICAgICAgICBxdWlja0luc3RydW1lbnRzIH07XG4iXX0=
require('source-map-support').install();

'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumBaseDriver = require('appium-base-driver');

var _remoteDebugger = require('./remote-debugger');

var _webkitRpcClient = require('./webkit-rpc-client');

var _webkitRpcClient2 = _interopRequireDefault(_webkitRpcClient);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _helpers = require('./helpers');

var WebKitRemoteDebugger = (function (_RemoteDebugger) {
  _inherits(WebKitRemoteDebugger, _RemoteDebugger);

  function WebKitRemoteDebugger() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, WebKitRemoteDebugger);

    _get(Object.getPrototypeOf(WebKitRemoteDebugger.prototype), 'constructor', this).call(this, _lodash2['default'].defaults({ debuggerType: _remoteDebugger.DEBUGGER_TYPES.webkit }, opts));

    // used to store callback types when sending requests
    this.dataMethods = {};
  }

  _createClass(WebKitRemoteDebugger, [{
    key: 'connect',
    value: function connect(pageId) {
      return _regeneratorRuntime.async(function connect$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.rpcClient = new _webkitRpcClient2['default'](this.host, this.port);
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.rpcClient.connect(pageId));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'disconnect',
    value: function disconnect() {
      if (this.rpcClient && this.rpcClient.isConnected()) {
        this.rpcClient.disconnect();
      }
    }
  }, {
    key: 'isConnected',
    value: function isConnected() {
      return !!(this.rpcClient && this.rpcClient.isConnected());
    }
  }, {
    key: 'pageArrayFromJson',
    value: function pageArrayFromJson() {
      var ignoreAboutBlankUrl = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];
      var pageElementJSON, devices, newPageArray;
      return _regeneratorRuntime.async(function pageArrayFromJson$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Getting WebKitRemoteDebugger pageArray: ' + this.host + ', ' + this.port);
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getJsonFromUrl(this.host, this.port, '/json'));

          case 3:
            pageElementJSON = context$2$0.sent;

            if (!pageElementJSON[0].deviceId) {
              context$2$0.next = 13;
              break;
            }

            _logger2['default'].debug('Device JSON: ' + (0, _helpers.simpleStringify)(pageElementJSON));

            devices = pageElementJSON.filter(function (device) {
              return device.deviceId !== 'SIMULATOR';
            });

            if (devices.length > 1) {
              _logger2['default'].debug('Connected to ' + devices.length + ' devices. ' + ('Choosing the first, with udid \'' + devices[0].deviceId + '\'.'));
            }
            this.port = devices[0].url.split(':')[1];
            _logger2['default'].debug('Received notification that ios-webkit-debug-proxy is listening on port \'' + this.port + '\'');

            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.getJsonFromUrl(this.host, this.port, '/json'));

          case 12:
            pageElementJSON = context$2$0.sent;

          case 13:
            _logger2['default'].debug('Page element JSON: ' + (0, _helpers.simpleStringify)(pageElementJSON));

            // Add elements to an array
            newPageArray = pageElementJSON.filter(function (pageObject) {
              return pageObject.url && (!ignoreAboutBlankUrl || pageObject.url !== 'about:blank');
            }).map(function (pageObject) {
              var urlArray = pageObject.webSocketDebuggerUrl.split('/').reverse();
              var id = urlArray[0];
              return {
                id: id,
                title: pageObject.title,
                url: pageObject.url,
                isKey: !!id
              };
            });
            return context$2$0.abrupt('return', newPageArray);

          case 16:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getJsonFromUrl',
    value: function getJsonFromUrl(hostname, port, pathname) {
      var uri;
      return _regeneratorRuntime.async(function getJsonFromUrl$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            uri = _url2['default'].format({
              protocol: 'http',
              hostname: hostname,
              port: port,
              pathname: pathname
            });

            _logger2['default'].debug('Sending request to: ' + uri);
            context$2$0.t0 = JSON;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _requestPromise2['default'])({ uri: uri, method: 'GET' }));

          case 5:
            context$2$0.t1 = context$2$0.sent;
            return context$2$0.abrupt('return', context$2$0.t0.parse.call(context$2$0.t0, context$2$0.t1));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'convertResult',
    value: function convertResult(res) {
      // WebKit returns a result wrapped deeper than the Remote Debugger:
      //   {
      //     result: {
      //       type: "string",
      //       value: {
      //         status: 0,
      //         value: {
      //           ELEMENT: ":wdc:1441819740060"
      //         }
      //       }
      //     },
      //     wasThrown: false
      //   }

      // check for errors
      if (res && res.wasThrown) {
        // we got some form of error.
        var message = res.result.value || res.result;
        throw new _appiumBaseDriver.errors.JavaScriptError(message);
      }

      if (res && res.result && res.result.type === 'undefined') {
        // if it doesn't throw an error, we just want to put in a
        // place holder. this happens when we have an async execute request
        res.result.value = {};
      }

      // send the actual result to the Remote Debugger converter
      return _get(Object.getPrototypeOf(WebKitRemoteDebugger.prototype), 'convertResult', this).call(this, res && res.result ? res.result.value : res);
    }
  }]);

  return WebKitRemoteDebugger;
})(_remoteDebugger.RemoteDebugger);

exports['default'] = WebKitRemoteDebugger;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJraXQtcmVtb3RlLWRlYnVnZ2VyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O3NCQUVnQixVQUFVOzs7O2dDQUNILG9CQUFvQjs7OEJBQ0ksbUJBQW1COzsrQkFDdEMscUJBQXFCOzs7O3NCQUNuQyxRQUFROzs7O21CQUNOLEtBQUs7Ozs7OEJBQ0QsaUJBQWlCOzs7O3VCQUNMLFdBQVc7O0lBR3RCLG9CQUFvQjtZQUFwQixvQkFBb0I7O0FBQzNCLFdBRE8sb0JBQW9CLEdBQ2Y7UUFBWCxJQUFJLHlEQUFHLEVBQUU7OzBCQURILG9CQUFvQjs7QUFFckMsK0JBRmlCLG9CQUFvQiw2Q0FFL0Isb0JBQUUsUUFBUSxDQUFDLEVBQUMsWUFBWSxFQUFFLCtCQUFlLE1BQU0sRUFBQyxFQUFFLElBQUksQ0FBQyxFQUFFOzs7QUFHL0QsUUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7R0FDdkI7O2VBTmtCLG9CQUFvQjs7V0FRekIsaUJBQUMsTUFBTTs7OztBQUNuQixnQkFBSSxDQUFDLFNBQVMsR0FBRyxpQ0FBb0IsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7OzZDQUNyRCxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7Ozs7Ozs7S0FDckM7OztXQUVVLHNCQUFHO0FBQ1osVUFBSSxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLEVBQUU7QUFDbEQsWUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztPQUM3QjtLQUNGOzs7V0FFVyx1QkFBRztBQUNiLGFBQU8sQ0FBQyxFQUFFLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQSxBQUFDLENBQUM7S0FDM0Q7OztXQUV1QjtVQUFDLG1CQUFtQix5REFBRyxLQUFLO1VBRTlDLGVBQWUsRUFJYixPQUFP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QUM7T0FDM0M7O0FBRUQsVUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxXQUFXLEVBQUU7OztBQUd4RCxXQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7T0FDdkI7OztBQUdELHdDQWxHaUIsb0JBQW9CLCtDQWtHVixHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxHQUFHLEVBQUU7S0FDeEU7OztTQW5Ha0Isb0JBQW9COzs7cUJBQXBCLG9CQUFvQiIsImZpbGUiOiJsaWIvd2Via2l0LXJlbW90ZS1kZWJ1Z2dlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptYWluXG5cbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IFJlbW90ZURlYnVnZ2VyLCBERUJVR0dFUl9UWVBFUyB9IGZyb20gJy4vcmVtb3RlLWRlYnVnZ2VyJztcbmltcG9ydCBXZWJLaXRScGNDbGllbnQgZnJvbSAnLi93ZWJraXQtcnBjLWNsaWVudCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCB7IHNpbXBsZVN0cmluZ2lmeSB9IGZyb20gJy4vaGVscGVycyc7XG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV2ViS2l0UmVtb3RlRGVidWdnZXIgZXh0ZW5kcyBSZW1vdGVEZWJ1Z2dlciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBzdXBlcihfLmRlZmF1bHRzKHtkZWJ1Z2dlclR5cGU6IERFQlVHR0VSX1RZUEVTLndlYmtpdH0sIG9wdHMpKTtcblxuICAgIC8vIHVzZWQgdG8gc3RvcmUgY2FsbGJhY2sgdHlwZXMgd2hlbiBzZW5kaW5nIHJlcXVlc3RzXG4gICAgdGhpcy5kYXRhTWV0aG9kcyA9IHt9O1xuICB9XG5cbiAgYXN5bmMgY29ubmVjdCAocGFnZUlkKSB7XG4gICAgdGhpcy5ycGNDbGllbnQgPSBuZXcgV2ViS2l0UnBjQ2xpZW50KHRoaXMuaG9zdCwgdGhpcy5wb3J0KTtcbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5jb25uZWN0KHBhZ2VJZCk7XG4gIH1cblxuICBkaXNjb25uZWN0ICgpIHtcbiAgICBpZiAodGhpcy5ycGNDbGllbnQgJiYgdGhpcy5ycGNDbGllbnQuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgdGhpcy5ycGNDbGllbnQuZGlzY29ubmVjdCgpO1xuICAgIH1cbiAgfVxuXG4gIGlzQ29ubmVjdGVkICgpIHtcbiAgICByZXR1cm4gISEodGhpcy5ycGNDbGllbnQgJiYgdGhpcy5ycGNDbGllbnQuaXNDb25uZWN0ZWQoKSk7XG4gIH1cblxuICBhc3luYyBwYWdlQXJyYXlGcm9tSnNvbiAoaWdub3JlQWJvdXRCbGFua1VybCA9IGZhbHNlKSB7XG4gICAgbG9nLmRlYnVnKGBHZXR0aW5nIFdlYktpdFJlbW90ZURlYnVnZ2VyIHBhZ2VBcnJheTogJHt0aGlzLmhvc3R9LCAke3RoaXMucG9ydH1gKTtcbiAgICBsZXQgcGFnZUVsZW1lbnRKU09OID0gYXdhaXQgdGhpcy5nZXRKc29uRnJvbVVybCh0aGlzLmhvc3QsIHRoaXMucG9ydCwgJy9qc29uJyk7XG4gICAgaWYgKHBhZ2VFbGVtZW50SlNPTlswXS5kZXZpY2VJZCkge1xuICAgICAgbG9nLmRlYnVnKGBEZXZpY2UgSlNPTjogJHtzaW1wbGVTdHJpbmdpZnkocGFnZUVsZW1lbnRKU09OKX1gKTtcblxuICAgICAgbGV0IGRldmljZXMgPSBwYWdlRWxlbWVudEpTT04uZmlsdGVyKChkZXZpY2UpID0+IGRldmljZS5kZXZpY2VJZCAhPT0gJ1NJTVVMQVRPUicpO1xuICAgICAgaWYgKGRldmljZXMubGVuZ3RoID4gMSkge1xuICAgICAgICBsb2cuZGVidWcoYENvbm5lY3RlZCB0byAke2RldmljZXMubGVuZ3RofSBkZXZpY2VzLiBgICtcbiAgICAgICAgICAgICAgICAgIGBDaG9vc2luZyB0aGUgZmlyc3QsIHdpdGggdWRpZCAnJHtkZXZpY2VzWzBdLmRldmljZUlkfScuYCk7XG4gICAgICB9XG4gICAgICB0aGlzLnBvcnQgPSBkZXZpY2VzWzBdLnVybC5zcGxpdCgnOicpWzFdO1xuICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCBub3RpZmljYXRpb24gdGhhdCBpb3Mtd2Via2l0LWRlYnVnLXByb3h5IGlzIGxpc3RlbmluZyBvbiBwb3J0ICcke3RoaXMucG9ydH0nYCk7XG5cbiAgICAgIHBhZ2VFbGVtZW50SlNPTiA9IGF3YWl0IHRoaXMuZ2V0SnNvbkZyb21VcmwodGhpcy5ob3N0LCB0aGlzLnBvcnQsICcvanNvbicpO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFBhZ2UgZWxlbWVudCBKU09OOiAke3NpbXBsZVN0cmluZ2lmeShwYWdlRWxlbWVudEpTT04pfWApO1xuXG4gICAgLy8gQWRkIGVsZW1lbnRzIHRvIGFuIGFycmF5XG4gICAgbGV0IG5ld1BhZ2VBcnJheSA9IHBhZ2VFbGVtZW50SlNPTi5maWx0ZXIoKHBhZ2VPYmplY3QpID0+IHtcbiAgICAgIHJldHVybiBwYWdlT2JqZWN0LnVybCAmJiAoIWlnbm9yZUFib3V0QmxhbmtVcmwgfHwgcGFnZU9iamVjdC51cmwgIT09ICdhYm91dDpibGFuaycpO1xuICAgIH0pLm1hcCgocGFnZU9iamVjdCkgPT4ge1xuICAgICAgbGV0IHVybEFycmF5ID0gcGFnZU9iamVjdC53ZWJTb2NrZXREZWJ1Z2dlclVybC5zcGxpdCgnLycpLnJldmVyc2UoKTtcbiAgICAgIGxldCBpZCA9IHVybEFycmF5WzBdO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaWQsXG4gICAgICAgIHRpdGxlOiBwYWdlT2JqZWN0LnRpdGxlLFxuICAgICAgICB1cmw6IHBhZ2VPYmplY3QudXJsLFxuICAgICAgICBpc0tleTogISFpZCxcbiAgICAgIH07XG4gICAgfSk7XG5cbiAgICByZXR1cm4gbmV3UGFnZUFycmF5O1xuICB9XG5cbiAgYXN5bmMgZ2V0SnNvbkZyb21VcmwgKGhvc3RuYW1lLCBwb3J0LCBwYXRobmFtZSkge1xuICAgIGxldCB1cmkgPSB1cmwuZm9ybWF0KHtcbiAgICAgIHByb3RvY29sOiAnaHR0cCcsXG4gICAgICBob3N0bmFtZSxcbiAgICAgIHBvcnQsXG4gICAgICBwYXRobmFtZVxuICAgIH0pO1xuICAgIGxvZy5kZWJ1ZyhgU2VuZGluZyByZXF1ZXN0IHRvOiAke3VyaX1gKTtcbiAgICByZXR1cm4gSlNPTi5wYXJzZShhd2FpdCByZXF1ZXN0KHt1cmksIG1ldGhvZDogJ0dFVCd9KSk7XG4gIH1cblxuICBjb252ZXJ0UmVzdWx0IChyZXMpIHtcbiAgICAvLyBXZWJLaXQgcmV0dXJucyBhIHJlc3VsdCB3cmFwcGVkIGRlZXBlciB0aGFuIHRoZSBSZW1vdGUgRGVidWdnZXI6XG4gICAgLy8gICB7XG4gICAgLy8gICAgIHJlc3VsdDoge1xuICAgIC8vICAgICAgIHR5cGU6IFwic3RyaW5nXCIsXG4gICAgLy8gICAgICAgdmFsdWU6IHtcbiAgICAvLyAgICAgICAgIHN0YXR1czogMCxcbiAgICAvLyAgICAgICAgIHZhbHVlOiB7XG4gICAgLy8gICAgICAgICAgIEVMRU1FTlQ6IFwiOndkYzoxNDQxODE5NzQwMDYwXCJcbiAgICAvLyAgICAgICAgIH1cbiAgICAvLyAgICAgICB9XG4gICAgLy8gICAgIH0sXG4gICAgLy8gICAgIHdhc1Rocm93bjogZmFsc2VcbiAgICAvLyAgIH1cblxuICAgIC8vIGNoZWNrIGZvciBlcnJvcnNcbiAgICBpZiAocmVzICYmIHJlcy53YXNUaHJvd24pIHtcbiAgICAgIC8vIHdlIGdvdCBzb21lIGZvcm0gb2YgZXJyb3IuXG4gICAgICBsZXQgbWVzc2FnZSA9IHJlcy5yZXN1bHQudmFsdWUgfHwgcmVzLnJlc3VsdDtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSmF2YVNjcmlwdEVycm9yKG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIGlmIChyZXMgJiYgcmVzLnJlc3VsdCAmJiByZXMucmVzdWx0LnR5cGUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAvLyBpZiBpdCBkb2Vzbid0IHRocm93IGFuIGVycm9yLCB3ZSBqdXN0IHdhbnQgdG8gcHV0IGluIGFcbiAgICAgIC8vIHBsYWNlIGhvbGRlci4gdGhpcyBoYXBwZW5zIHdoZW4gd2UgaGF2ZSBhbiBhc3luYyBleGVjdXRlIHJlcXVlc3RcbiAgICAgIHJlcy5yZXN1bHQudmFsdWUgPSB7fTtcbiAgICB9XG5cbiAgICAvLyBzZW5kIHRoZSBhY3R1YWwgcmVzdWx0IHRvIHRoZSBSZW1vdGUgRGVidWdnZXIgY29udmVydGVyXG4gICAgcmV0dXJuIHN1cGVyLmNvbnZlcnRSZXN1bHQocmVzICYmIHJlcy5yZXN1bHQgPyByZXMucmVzdWx0LnZhbHVlIDogcmVzKTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9

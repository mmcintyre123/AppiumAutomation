'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumSupport = require('appium-support');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _teen_process = require('teen_process');

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var WDA_DERIVED_DATA_SEARCH_SUFFIX = 'Library/Developer/Xcode/DerivedData/WebDriverAgent-*';
var WDA_ATTACHMENTS_FOLDER_RELATIVE_PATH = 'Logs/Test/Attachments';

function detectUdid() {
  var cmd, args, udid, _ref, stdout, udids;

  return _regeneratorRuntime.async(function detectUdid$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Auto-detecting real device udid...');
        cmd = undefined, args = [];
        context$1$0.prev = 2;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('idevice_id'));

      case 5:
        cmd = context$1$0.sent;

        args.push('-l');
        _logger2['default'].debug('Using idevice_id');
        context$1$0.next = 14;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](2);

        _logger2['default'].debug('Using udidetect');
        cmd = require.resolve('udidetect');

      case 14:
        udid = undefined;
        context$1$0.prev = 15;
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(cmd, args, { timeout: 3000 }));

      case 18:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        udids = _lodash2['default'].filter(stdout.split('\n'), Boolean);

        udid = _lodash2['default'].last(udids);
        if (udids.length > 1) {
          _logger2['default'].warn('Multiple devices found: ' + udids.join(', '));
          _logger2['default'].warn('Choosing \'' + udid + '\'. If this is wrong, manually set with \'udid\' desired capability');
        }
        context$1$0.next = 28;
        break;

      case 25:
        context$1$0.prev = 25;
        context$1$0.t1 = context$1$0['catch'](15);

        _logger2['default'].errorAndThrow('Error detecting udid: ' + context$1$0.t1.message);

      case 28:
        if (!(!udid || udid.length <= 2)) {
          context$1$0.next = 30;
          break;
        }

        throw new Error('Could not detect udid.');

      case 30:
        _logger2['default'].debug('Detected real device udid: \'' + udid + '\'');
        return context$1$0.abrupt('return', udid);

      case 32:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 10], [15, 25]]);
}

function getAndCheckXcodeVersion() {
  var version;
  return _regeneratorRuntime.async(function getAndCheckXcodeVersion$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        version = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getVersion(true));

      case 4:
        version = context$1$0.sent;
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].debug(context$1$0.t0);
        _logger2['default'].errorAndThrow('Could not determine Xcode version: ' + context$1$0.t0.message);

      case 11:

        // we do not support Xcodes < 7.3,
        if (version.versionFloat < 7.3) {
          _logger2['default'].warn('Xcode version \'' + version.versionString + '\'. Support for Xcode ' + (version.versionString + ' has been deprecated and will be removed ') + 'in a future version. Please upgrade to version 7 or higher');
        }
        return context$1$0.abrupt('return', version);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
}

function getAndCheckIosSdkVersion() {
  var versionNumber;
  return _regeneratorRuntime.async(function getAndCheckIosSdkVersion$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        versionNumber = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getMaxIOSSDK());

      case 4:
        versionNumber = context$1$0.sent;
        context$1$0.next = 10;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].errorAndThrow('Could not determine iOS SDK version: ' + context$1$0.t0.message);

      case 10:
        return context$1$0.abrupt('return', versionNumber);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
}

function killAppUsingAppName(udid, appName) {
  var psArgs;
  return _regeneratorRuntime.async(function killAppUsingAppName$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        psArgs = ['-c', 'ps -ax|grep -i "' + appName + '"|grep -i "' + udid + '"|grep -v grep|awk \'{print "kill -9 " $1}\'|sh'];
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('bash', psArgs));

      case 4:
        context$1$0.next = 9;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].debug('Error : ' + context$1$0.t0.message);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 6]]);
}

function adjustWDAAttachmentsPermissions(perms) {
  var derivedDataSearchMask, folders, changesMade, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, folder, attachmentsFolder;

  return _regeneratorRuntime.async(function adjustWDAAttachmentsPermissions$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (process.env.HOME) {
          context$1$0.next = 2;
          break;
        }

        throw new Error('Need HOME env var to be set in order to adjust WDA attachments permission');

      case 2:
        derivedDataSearchMask = _path2['default'].join(process.env.HOME, WDA_DERIVED_DATA_SEARCH_SUFFIX);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.glob(derivedDataSearchMask));

      case 5:
        folders = context$1$0.sent;
        changesMade = false;
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 10;
        _iterator = _getIterator(folders);

      case 12:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 26;
          break;
        }

        folder = _step.value;

        _logger2['default'].debug('Found WDA derived data folder: \'' + folder + '\'');
        attachmentsFolder = _path2['default'].join(folder, WDA_ATTACHMENTS_FOLDER_RELATIVE_PATH);
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(attachmentsFolder));

      case 18:
        if (!context$1$0.sent) {
          context$1$0.next = 23;
          break;
        }

        _logger2['default'].info('Setting \'' + perms + '\' permissions to \'' + attachmentsFolder + '\' folder');
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.chmod(attachmentsFolder, perms));

      case 22:
        changesMade = true;

      case 23:
        _iteratorNormalCompletion = true;
        context$1$0.next = 12;
        break;

      case 26:
        context$1$0.next = 32;
        break;

      case 28:
        context$1$0.prev = 28;
        context$1$0.t0 = context$1$0['catch'](10);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 32:
        context$1$0.prev = 32;
        context$1$0.prev = 33;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 35:
        context$1$0.prev = 35;

        if (!_didIteratorError) {
          context$1$0.next = 38;
          break;
        }

        throw _iteratorError;

      case 38:
        return context$1$0.finish(35);

      case 39:
        return context$1$0.finish(32);

      case 40:
        if (!changesMade) {
          _logger2['default'].info('No WDA derived data folders have been found.');
        }

      case 41:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[10, 28, 32, 40], [33,, 35, 39]]);
}

function generateXcodeConfigFile(orgId, signingId) {
  var contents, xcconfigPath;
  return _regeneratorRuntime.async(function generateXcodeConfigFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Generating xcode config file for orgId \'' + orgId + '\' and signingId ' + ('\'' + signingId + '\''));
        contents = 'DEVELOPMENT_TEAM = ' + orgId + '\nCODE_SIGN_IDENTITY = ' + signingId + '\n';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.path('appium-temp.xcconfig'));

      case 4:
        xcconfigPath = context$1$0.sent;

        _logger2['default'].debug('Writing xcode config file to ' + xcconfigPath);
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(xcconfigPath, contents, "utf8"));

      case 8:
        return context$1$0.abrupt('return', xcconfigPath);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.detectUdid = detectUdid;
exports.getAndCheckXcodeVersion = getAndCheckXcodeVersion;
exports.getAndCheckIosSdkVersion = getAndCheckIosSdkVersion;
exports.killAppUsingAppName = killAppUsingAppName;
exports.adjustWDAAttachmentsPermissions = adjustWDAAttachmentsPermissions;
exports.generateXcodeConfigFile = generateXcodeConfigFile;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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Z0JBQVEsMkJBQXlCLEtBQUssK0JBQ3JCLFNBQVM7O3lDQUVMLHVCQUFRLElBQUksQ0FBQyxzQkFBc0IsQ0FBQzs7O0FBQXpELG9CQUFZOztBQUNoQiw0QkFBSSxLQUFLLG1DQUFpQyxZQUFZLENBQUcsQ0FBQzs7eUNBQ3BELGtCQUFHLFNBQVMsQ0FBQyxZQUFZLEVBQUUsUUFBUSxFQUFFLE1BQU0sQ0FBQzs7OzRDQUMzQyxZQUFZOzs7Ozs7O0NBQ3BCOztRQUVRLFVBQVUsR0FBVixVQUFVO1FBQUUsdUJBQXVCLEdBQXZCLHVCQUF1QjtRQUFFLHdCQUF3QixHQUF4Qix3QkFBd0I7UUFDN0QsbUJBQW1CLEdBQW5CLG1CQUFtQjtRQUFFLCtCQUErQixHQUEvQiwrQkFBK0I7UUFDcEQsdUJBQXVCLEdBQXZCLHVCQUF1QiIsImZpbGUiOiJsaWIvdXRpbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcywgdGVtcERpciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcblxuXG5jb25zdCBXREFfREVSSVZFRF9EQVRBX1NFQVJDSF9TVUZGSVggPSAnTGlicmFyeS9EZXZlbG9wZXIvWGNvZGUvRGVyaXZlZERhdGEvV2ViRHJpdmVyQWdlbnQtKic7XG5jb25zdCBXREFfQVRUQUNITUVOVFNfRk9MREVSX1JFTEFUSVZFX1BBVEggPSAnTG9ncy9UZXN0L0F0dGFjaG1lbnRzJztcblxuYXN5bmMgZnVuY3Rpb24gZGV0ZWN0VWRpZCAoKSB7XG4gIGxvZy5kZWJ1ZygnQXV0by1kZXRlY3RpbmcgcmVhbCBkZXZpY2UgdWRpZC4uLicpO1xuICBsZXQgIGNtZCwgYXJncyA9IFtdO1xuICB0cnkge1xuICAgIGNtZCA9IGF3YWl0IGZzLndoaWNoKCdpZGV2aWNlX2lkJyk7XG4gICAgYXJncy5wdXNoKCctbCcpO1xuICAgIGxvZy5kZWJ1ZygnVXNpbmcgaWRldmljZV9pZCcpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoJ1VzaW5nIHVkaWRldGVjdCcpO1xuICAgIGNtZCA9IHJlcXVpcmUucmVzb2x2ZSgndWRpZGV0ZWN0Jyk7XG4gIH1cbiAgbGV0IHVkaWQ7XG4gIHRyeSB7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhjbWQsIGFyZ3MsIHt0aW1lb3V0OiAzMDAwfSk7XG4gICAgbGV0IHVkaWRzID0gXy5maWx0ZXIoc3Rkb3V0LnNwbGl0KCdcXG4nKSwgQm9vbGVhbik7XG4gICAgdWRpZCA9IF8ubGFzdCh1ZGlkcyk7XG4gICAgaWYgKHVkaWRzLmxlbmd0aCA+IDEpIHtcbiAgICAgIGxvZy53YXJuKGBNdWx0aXBsZSBkZXZpY2VzIGZvdW5kOiAke3VkaWRzLmpvaW4oJywgJyl9YCk7XG4gICAgICBsb2cud2FybihgQ2hvb3NpbmcgJyR7dWRpZH0nLiBJZiB0aGlzIGlzIHdyb25nLCBtYW51YWxseSBzZXQgd2l0aCAndWRpZCcgZGVzaXJlZCBjYXBhYmlsaXR5YCk7XG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgRXJyb3IgZGV0ZWN0aW5nIHVkaWQ6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbiAgaWYgKCF1ZGlkIHx8IHVkaWQubGVuZ3RoIDw9IDIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBkZXRlY3QgdWRpZC4nKTtcbiAgfVxuICBsb2cuZGVidWcoYERldGVjdGVkIHJlYWwgZGV2aWNlIHVkaWQ6ICcke3VkaWR9J2ApO1xuICByZXR1cm4gdWRpZDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QW5kQ2hlY2tYY29kZVZlcnNpb24gKCkge1xuICBsZXQgdmVyc2lvbjtcbiAgdHJ5IHtcbiAgICB2ZXJzaW9uID0gYXdhaXQgeGNvZGUuZ2V0VmVyc2lvbih0cnVlKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmRlYnVnKGVycik7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENvdWxkIG5vdCBkZXRlcm1pbmUgWGNvZGUgdmVyc2lvbjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIHdlIGRvIG5vdCBzdXBwb3J0IFhjb2RlcyA8IDcuMyxcbiAgaWYgKHZlcnNpb24udmVyc2lvbkZsb2F0IDwgNy4zKSB7XG4gICAgbG9nLndhcm4oYFhjb2RlIHZlcnNpb24gJyR7dmVyc2lvbi52ZXJzaW9uU3RyaW5nfScuIFN1cHBvcnQgZm9yIFhjb2RlIGAgK1xuICAgICAgICAgICAgIGAke3ZlcnNpb24udmVyc2lvblN0cmluZ30gaGFzIGJlZW4gZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGAgK1xuICAgICAgICAgICAgIGBpbiBhIGZ1dHVyZSB2ZXJzaW9uLiBQbGVhc2UgdXBncmFkZSB0byB2ZXJzaW9uIDcgb3IgaGlnaGVyYCk7XG4gIH1cbiAgcmV0dXJuIHZlcnNpb247XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFuZENoZWNrSW9zU2RrVmVyc2lvbiAoKSB7XG4gIGxldCB2ZXJzaW9uTnVtYmVyO1xuICB0cnkge1xuICAgIHZlcnNpb25OdW1iZXIgPSBhd2FpdCB4Y29kZS5nZXRNYXhJT1NTREsoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENvdWxkIG5vdCBkZXRlcm1pbmUgaU9TIFNESyB2ZXJzaW9uOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG4gIHJldHVybiB2ZXJzaW9uTnVtYmVyO1xufVxuXG5hc3luYyBmdW5jdGlvbiBraWxsQXBwVXNpbmdBcHBOYW1lICh1ZGlkLCBhcHBOYW1lKSB7XG4gIGxldCBwc0FyZ3MgPSBbYC1jYCwgYHBzIC1heHxncmVwIC1pIFwiJHthcHBOYW1lfVwifGdyZXAgLWkgXCIke3VkaWR9XCJ8Z3JlcCAtdiBncmVwfGF3ayAne3ByaW50IFwia2lsbCAtOSBcIiAkMX0nfHNoYF07XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYyhgYmFzaGAsIHBzQXJncyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5kZWJ1ZyhgRXJyb3IgOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGFkanVzdFdEQUF0dGFjaG1lbnRzUGVybWlzc2lvbnMgKHBlcm1zKSB7XG4gIGlmICghcHJvY2Vzcy5lbnYuSE9NRSkge1xuICAgIHRocm93IG5ldyBFcnJvcignTmVlZCBIT01FIGVudiB2YXIgdG8gYmUgc2V0IGluIG9yZGVyIHRvIGFkanVzdCBXREEgYXR0YWNobWVudHMgcGVybWlzc2lvbicpO1xuICB9XG4gIGxldCBkZXJpdmVkRGF0YVNlYXJjaE1hc2sgPSBwYXRoLmpvaW4ocHJvY2Vzcy5lbnYuSE9NRSwgV0RBX0RFUklWRURfREFUQV9TRUFSQ0hfU1VGRklYKTtcbiAgbGV0IGZvbGRlcnMgPSBhd2FpdCBmcy5nbG9iKGRlcml2ZWREYXRhU2VhcmNoTWFzayk7XG4gIGxldCBjaGFuZ2VzTWFkZSA9IGZhbHNlO1xuICBmb3IgKGxldCBmb2xkZXIgb2YgZm9sZGVycykge1xuICAgIGxvZy5kZWJ1ZyhgRm91bmQgV0RBIGRlcml2ZWQgZGF0YSBmb2xkZXI6ICcke2ZvbGRlcn0nYCk7XG4gICAgbGV0IGF0dGFjaG1lbnRzRm9sZGVyID0gcGF0aC5qb2luKGZvbGRlciwgV0RBX0FUVEFDSE1FTlRTX0ZPTERFUl9SRUxBVElWRV9QQVRIKTtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKGF0dGFjaG1lbnRzRm9sZGVyKSkge1xuICAgICAgbG9nLmluZm8oYFNldHRpbmcgJyR7cGVybXN9JyBwZXJtaXNzaW9ucyB0byAnJHthdHRhY2htZW50c0ZvbGRlcn0nIGZvbGRlcmApO1xuICAgICAgYXdhaXQgZnMuY2htb2QoYXR0YWNobWVudHNGb2xkZXIsIHBlcm1zKTtcbiAgICAgIGNoYW5nZXNNYWRlID0gdHJ1ZTtcbiAgICB9XG4gIH1cbiAgaWYgKCFjaGFuZ2VzTWFkZSkge1xuICAgIGxvZy5pbmZvKCdObyBXREEgZGVyaXZlZCBkYXRhIGZvbGRlcnMgaGF2ZSBiZWVuIGZvdW5kLicpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlWGNvZGVDb25maWdGaWxlIChvcmdJZCwgc2lnbmluZ0lkKSB7XG4gIGxvZy5kZWJ1ZyhgR2VuZXJhdGluZyB4Y29kZSBjb25maWcgZmlsZSBmb3Igb3JnSWQgJyR7b3JnSWR9JyBhbmQgc2lnbmluZ0lkIGAgK1xuICAgICAgICAgICAgYCcke3NpZ25pbmdJZH0nYCk7XG4gIGxldCBjb250ZW50cyA9IGBERVZFTE9QTUVOVF9URUFNID0gJHtvcmdJZH1cbkNPREVfU0lHTl9JREVOVElUWSA9ICR7c2lnbmluZ0lkfVxuYDtcbiAgbGV0IHhjY29uZmlnUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCgnYXBwaXVtLXRlbXAueGNjb25maWcnKTtcbiAgbG9nLmRlYnVnKGBXcml0aW5nIHhjb2RlIGNvbmZpZyBmaWxlIHRvICR7eGNjb25maWdQYXRofWApO1xuICBhd2FpdCBmcy53cml0ZUZpbGUoeGNjb25maWdQYXRoLCBjb250ZW50cywgXCJ1dGY4XCIpO1xuICByZXR1cm4geGNjb25maWdQYXRoO1xufVxuXG5leHBvcnQgeyBkZXRlY3RVZGlkLCBnZXRBbmRDaGVja1hjb2RlVmVyc2lvbiwgZ2V0QW5kQ2hlY2tJb3NTZGtWZXJzaW9uLFxuICAgICAgICAga2lsbEFwcFVzaW5nQXBwTmFtZSwgYWRqdXN0V0RBQXR0YWNobWVudHNQZXJtaXNzaW9ucyxcbiAgICAgICAgIGdlbmVyYXRlWGNvZGVDb25maWdGaWxlIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=

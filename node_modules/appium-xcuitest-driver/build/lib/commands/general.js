'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumBaseDriver = require('appium-base-driver');

var _appiumIosDriver = require('appium-ios-driver');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var commands = {};

commands.active = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.UnknownError('Command should be proxied to WDA');

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.executeAtom('active_element', []));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Close app (simulate device home button). If a duration is given, app will
 * re-open after that many seconds
 */
commands.background = function callee$0$0(seconds) {
  var params;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        params = {};

        if (seconds) {
          params.duration = seconds;
        }
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.proxyCommand('/wda/deactivateApp', 'POST', params));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/*
 * Simulate Touch ID with either valid (match === true) or invalid (match === false)
 * fingerprint
 */
commands.touchId = function callee$0$0() {
  var match = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
  var params;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        params = {
          match: match
        };
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.proxyCommand('/wda/simulator/touch_id', 'POST', params));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getWindowSize = function callee$0$0() {
  var windowHandle = arguments.length <= 0 || arguments[0] === undefined ? 'current' : arguments[0];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(windowHandle !== "current")) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError('Currently only getting current window size is supported.');

      case 2:
        if (this.isWebContext()) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.proxyCommand('/window/size', 'GET'));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.executeAtom('get_window_size', []));

      case 10:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.hideKeyboard = function callee$0$0(strategy) {
  for (var _len = arguments.length, possibleKeys = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    possibleKeys[_key - 1] = arguments[_key];
  }

  var keyboard, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, key, el, buttons;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        keyboard = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.findNativeElementOrElements('class name', 'XCUIElementTypeKeyboard', false));

      case 4:
        keyboard = context$1$0.sent;
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        // no keyboard found
        _logger2['default'].debug('No keyboard found. Unable to hide.');
        return context$1$0.abrupt('return');

      case 11:

        possibleKeys.pop(); // last parameter is the session id
        possibleKeys = possibleKeys.filter(function (element) {
          return !!element;
        }); // get rid of undefined elements

        if (!possibleKeys.length) {
          context$1$0.next = 50;
          break;
        }

        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 17;
        _iterator = _getIterator(possibleKeys);

      case 19:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 34;
          break;
        }

        key = _step.value;
        context$1$0.t1 = _lodash2['default'];
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(this.findNativeElementOrElements('accessibility id', key, true, keyboard));

      case 24:
        context$1$0.t2 = context$1$0.sent;
        el = context$1$0.t1.last.call(context$1$0.t1, context$1$0.t2);

        if (!el) {
          context$1$0.next = 31;
          break;
        }

        _logger2['default'].debug('Attempting to hide keyboard by pressing \'' + key + '\' key.');
        context$1$0.next = 30;
        return _regeneratorRuntime.awrap(this.nativeClick(el));

      case 30:
        return context$1$0.abrupt('return');

      case 31:
        _iteratorNormalCompletion = true;
        context$1$0.next = 19;
        break;

      case 34:
        context$1$0.next = 40;
        break;

      case 36:
        context$1$0.prev = 36;
        context$1$0.t3 = context$1$0['catch'](17);
        _didIteratorError = true;
        _iteratorError = context$1$0.t3;

      case 40:
        context$1$0.prev = 40;
        context$1$0.prev = 41;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 43:
        context$1$0.prev = 43;

        if (!_didIteratorError) {
          context$1$0.next = 46;
          break;
        }

        throw _iteratorError;

      case 46:
        return context$1$0.finish(43);

      case 47:
        return context$1$0.finish(40);

      case 48:
        context$1$0.next = 56;
        break;

      case 50:
        // find the keyboard, and hit the last Button
        _logger2['default'].debug('Finding keyboard and clicking final button to close');
        context$1$0.next = 53;
        return _regeneratorRuntime.awrap(this.findNativeElementOrElements('class name', 'XCUIElementTypeButton', true, keyboard));

      case 53:
        buttons = context$1$0.sent;
        context$1$0.next = 56;
        return _regeneratorRuntime.awrap(this.nativeClick(_lodash2['default'].last(buttons)));

      case 56:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7], [17, 36, 40, 48], [41,, 43, 47]]);
};

commands.getDeviceTime = _appiumIosDriver.iosCommands.general.getDeviceTime;

commands.getStrings = _appiumIosDriver.iosCommands.general.getStrings;

commands.removeApp = function callee$0$0(bundleId) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isRealDevice()) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.opts.device.remove(bundleId));

      case 3:
        context$1$0.next = 7;
        break;

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.opts.device.removeApp(bundleId));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.launchApp = _appiumIosDriver.iosCommands.general.launchApp;

commands.closeApp = _appiumIosDriver.iosCommands.general.closeApp;

commands.keys = function callee$0$0(keys) {
  var el;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.UnknownError('Command should be proxied to WDA');

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.active());

      case 4:
        el = context$1$0.sent;

        if (!_lodash2['default'].isUndefined(el.ELEMENT)) {
          context$1$0.next = 7;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchElementError();

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.setValue(keys, el.ELEMENT));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

exports.commands = commands;
exports['default'] = commands;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztzQkFBYyxRQUFROzs7O2dDQUNDLG9CQUFvQjs7K0JBQ2YsbUJBQW1COztzQkFDL0IsV0FBVzs7OztBQUczQixJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7O0FBRWxCLFFBQVEsQ0FBQyxNQUFNLEdBQUc7Ozs7WUFDWCxJQUFJLENBQUMsWUFBWSxFQUFFOzs7OztjQUNoQixJQUFJLHlCQUFPLFlBQVksQ0FBQyxrQ0FBa0MsQ0FBQzs7Ozt5Q0FFdEQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLENBQUM7Ozs7Ozs7Ozs7Q0FDcEQsQ0FBQzs7Ozs7O0FBTUYsUUFBUSxDQUFDLFVBQVUsR0FBRyxvQkFBZ0IsT0FBTztNQUN2QyxNQUFNOzs7O0FBQU4sY0FBTSxHQUFHLEVBQUU7O0FBQ2YsWUFBSSxPQUFPLEVBQUU7QUFDWCxnQkFBTSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7U0FDM0I7O3lDQUNZLElBQUksQ0FBQyxZQUFZLENBQUMsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQzs7Ozs7Ozs7OztDQUNyRSxDQUFDOzs7Ozs7QUFNRixRQUFRLENBQUMsT0FBTyxHQUFHO01BQWdCLEtBQUsseURBQUcsSUFBSTtNQUN6QyxNQUFNOzs7O0FBQU4sY0FBTSxHQUFHO0FBQ1gsZUFBSyxFQUFMLEtBQUs7U0FDTjs7eUNBQ1ksSUFBSSxDQUFDLFlBQVksQ0FBQyx5QkFBeUIsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDOzs7Ozs7Ozs7O0NBQzFFLENBQUM7O0FBRUYsUUFBUSxDQUFDLGFBQWEsR0FBRztNQUFnQixZQUFZLHlEQUFHLFNBQVM7Ozs7Y0FDM0QsWUFBWSxLQUFLLFNBQVMsQ0FBQTs7Ozs7Y0FDdEIsSUFBSSx5QkFBTyxzQkFBc0IsQ0FBQywwREFBMEQsQ0FBQzs7O1lBR2hHLElBQUksQ0FBQyxZQUFZLEVBQUU7Ozs7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IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgaW9zQ29tbWFuZHMgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5cblxubGV0IGNvbW1hbmRzID0ge307XG5cbmNvbW1hbmRzLmFjdGl2ZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoJ0NvbW1hbmQgc2hvdWxkIGJlIHByb3hpZWQgdG8gV0RBJyk7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2FjdGl2ZV9lbGVtZW50JywgW10pO1xufTtcblxuLyoqXG4gKiBDbG9zZSBhcHAgKHNpbXVsYXRlIGRldmljZSBob21lIGJ1dHRvbikuIElmIGEgZHVyYXRpb24gaXMgZ2l2ZW4sIGFwcCB3aWxsXG4gKiByZS1vcGVuIGFmdGVyIHRoYXQgbWFueSBzZWNvbmRzXG4gKi9cbmNvbW1hbmRzLmJhY2tncm91bmQgPSBhc3luYyBmdW5jdGlvbiAoc2Vjb25kcykge1xuICBsZXQgcGFyYW1zID0ge307XG4gIGlmIChzZWNvbmRzKSB7XG4gICAgcGFyYW1zLmR1cmF0aW9uID0gc2Vjb25kcztcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvZGVhY3RpdmF0ZUFwcCcsICdQT1NUJywgcGFyYW1zKTtcbn07XG5cbi8qXG4gKiBTaW11bGF0ZSBUb3VjaCBJRCB3aXRoIGVpdGhlciB2YWxpZCAobWF0Y2ggPT09IHRydWUpIG9yIGludmFsaWQgKG1hdGNoID09PSBmYWxzZSlcbiAqIGZpbmdlcnByaW50XG4gKi9cbmNvbW1hbmRzLnRvdWNoSWQgPSBhc3luYyBmdW5jdGlvbiAobWF0Y2ggPSB0cnVlKSB7XG4gIGxldCBwYXJhbXMgPSB7XG4gICAgbWF0Y2hcbiAgfTtcbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL3NpbXVsYXRvci90b3VjaF9pZCcsICdQT1NUJywgcGFyYW1zKTtcbn07XG5cbmNvbW1hbmRzLmdldFdpbmRvd1NpemUgPSBhc3luYyBmdW5jdGlvbiAod2luZG93SGFuZGxlID0gJ2N1cnJlbnQnKSB7XG4gIGlmICh3aW5kb3dIYW5kbGUgIT09IFwiY3VycmVudFwiKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCdDdXJyZW50bHkgb25seSBnZXR0aW5nIGN1cnJlbnQgd2luZG93IHNpemUgaXMgc3VwcG9ydGVkLicpO1xuICB9XG5cbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvd2luZG93L3NpemVgLCAnR0VUJyk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF93aW5kb3dfc2l6ZScsIFtdKTtcbiAgfVxufTtcblxuY29tbWFuZHMuaGlkZUtleWJvYXJkID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCAuLi5wb3NzaWJsZUtleXMpIHtcbiAgbGV0IGtleWJvYXJkO1xuICB0cnkge1xuICAgIGtleWJvYXJkID0gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnWENVSUVsZW1lbnRUeXBlS2V5Ym9hcmQnLCBmYWxzZSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIC8vIG5vIGtleWJvYXJkIGZvdW5kXG4gICAgbG9nLmRlYnVnKCdObyBrZXlib2FyZCBmb3VuZC4gVW5hYmxlIHRvIGhpZGUuJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgcG9zc2libGVLZXlzLnBvcCgpOyAvLyBsYXN0IHBhcmFtZXRlciBpcyB0aGUgc2Vzc2lvbiBpZFxuICBwb3NzaWJsZUtleXMgPSBwb3NzaWJsZUtleXMuZmlsdGVyKChlbGVtZW50KSA9PiAhIWVsZW1lbnQpOyAvLyBnZXQgcmlkIG9mIHVuZGVmaW5lZCBlbGVtZW50c1xuICBpZiAocG9zc2libGVLZXlzLmxlbmd0aCkge1xuICAgIGZvciAobGV0IGtleSBvZiBwb3NzaWJsZUtleXMpIHtcbiAgICAgIGxldCBlbCA9IF8ubGFzdChhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnYWNjZXNzaWJpbGl0eSBpZCcsIGtleSwgdHJ1ZSwga2V5Ym9hcmQpKTtcbiAgICAgIGlmIChlbCkge1xuICAgICAgICBsb2cuZGVidWcoYEF0dGVtcHRpbmcgdG8gaGlkZSBrZXlib2FyZCBieSBwcmVzc2luZyAnJHtrZXl9JyBrZXkuYCk7XG4gICAgICAgIGF3YWl0IHRoaXMubmF0aXZlQ2xpY2soZWwpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIC8vIGZpbmQgdGhlIGtleWJvYXJkLCBhbmQgaGl0IHRoZSBsYXN0IEJ1dHRvblxuICAgIGxvZy5kZWJ1ZygnRmluZGluZyBrZXlib2FyZCBhbmQgY2xpY2tpbmcgZmluYWwgYnV0dG9uIHRvIGNsb3NlJyk7XG4gICAgbGV0IGJ1dHRvbnMgPSBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnY2xhc3MgbmFtZScsICdYQ1VJRWxlbWVudFR5cGVCdXR0b24nLCB0cnVlLCBrZXlib2FyZCk7XG4gICAgYXdhaXQgdGhpcy5uYXRpdmVDbGljayhfLmxhc3QoYnV0dG9ucykpO1xuICB9XG59O1xuXG5jb21tYW5kcy5nZXREZXZpY2VUaW1lID0gaW9zQ29tbWFuZHMuZ2VuZXJhbC5nZXREZXZpY2VUaW1lO1xuXG5jb21tYW5kcy5nZXRTdHJpbmdzID0gaW9zQ29tbWFuZHMuZ2VuZXJhbC5nZXRTdHJpbmdzO1xuXG5jb21tYW5kcy5yZW1vdmVBcHAgPSBhc3luYyBmdW5jdGlvbiAoYnVuZGxlSWQpIHtcbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLnJlbW92ZShidW5kbGVJZCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgdGhpcy5vcHRzLmRldmljZS5yZW1vdmVBcHAoYnVuZGxlSWQpO1xuICB9XG59O1xuXG5jb21tYW5kcy5sYXVuY2hBcHAgPSBpb3NDb21tYW5kcy5nZW5lcmFsLmxhdW5jaEFwcDtcblxuY29tbWFuZHMuY2xvc2VBcHAgPSBpb3NDb21tYW5kcy5nZW5lcmFsLmNsb3NlQXBwO1xuXG5jb21tYW5kcy5rZXlzID0gYXN5bmMgZnVuY3Rpb24gKGtleXMpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoJ0NvbW1hbmQgc2hvdWxkIGJlIHByb3hpZWQgdG8gV0RBJyk7XG4gIH1cbiAgbGV0IGVsID0gYXdhaXQgdGhpcy5hY3RpdmUoKTtcbiAgaWYgKF8uaXNVbmRlZmluZWQoZWwuRUxFTUVOVCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICB9XG4gIGF3YWl0IHRoaXMuc2V0VmFsdWUoa2V5cywgZWwuRUxFTUVOVCk7XG59O1xuXG5leHBvcnQgeyBjb21tYW5kcyB9O1xuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=

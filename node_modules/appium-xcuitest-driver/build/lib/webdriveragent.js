'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _url2 = require('url');

var _url3 = _interopRequireDefault(_url2);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _asyncbox = require('asyncbox');

var _teen_process = require('teen_process');

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumLogger = require('appium-logger');

var _utilsJs = require('./utils.js');

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var xcodeLog = (0, _appiumLogger.getLogger)('Xcode');
var iproxyLog = (0, _appiumLogger.getLogger)('iProxy');

var BOOTSTRAP_PATH = _path2['default'].resolve(__dirname, '..', '..', 'WebDriverAgent');
var WDA_BUNDLE_ID = 'com.apple.test.WebDriverAgentRunner-Runner';
var DEFAULT_SIGNING_ID = "iPhone Developer";
var WDA_LAUNCH_TIMEOUT = 60 * 1000;
var IPROXY_TIMEOUT = 5000;
var WDA_AGENT_PORT = 8100;
var WDA_BASE_URL = 'http://localhost';

var WebDriverAgent = (function () {

  // agentPath (optional): Path to WebdriverAgent Executable (inside WebDriverAgent.app)

  function WebDriverAgent(xcodeVersion) {
    var args = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    _classCallCheck(this, WebDriverAgent);

    this.xcodeVersion = xcodeVersion;

    this.device = args.device;
    this.platformVersion = args.platformVersion;
    this.host = args.host;
    this.realDevice = !!args.realDevice;

    this.setWDAPaths(args.bootstrapPath, args.agentPath);

    this.wdaLocalPort = args.wdaLocalPort;
    this.showXcodeLog = !!args.showXcodeLog;
    this.xcodeConfigFile = args.xcodeConfigFile;
    this.xcodeOrgId = args.xcodeOrgId;
    this.xcodeSigningId = args.xcodeSigningId || DEFAULT_SIGNING_ID;
    this.keychainPath = args.keychainPath;
    this.keychainPassword = args.keychainPassword;

    this.usePrebuiltWDA = args.usePrebuiltWDA;
    this.webDriverAgentUrl = args.webDriverAgentUrl;

    this.expectIProxyErrors = true;

    this.wdaLaunchTimeout = args.wdaLaunchTimeout || WDA_LAUNCH_TIMEOUT;
    this.wdaConnectionTimeout = args.wdaConnectionTimeout;
  }

  _createClass(WebDriverAgent, [{
    key: 'setWDAPaths',
    value: function setWDAPaths(bootstrapPath, agentPath) {
      // allow the user to specify a place for WDA. This is undocumented and
      // only here for the purposes of testing development of WDA
      this.bootstrapPath = bootstrapPath || BOOTSTRAP_PATH;
      _logger2['default'].info('Using WDA path: \'' + this.bootstrapPath + '\'');

      // for backward compatibility we need to be able to specify agentPath too
      this.agentPath = agentPath || _path2['default'].resolve(this.bootstrapPath, 'WebDriverAgent.xcodeproj');
      _logger2['default'].info('Using WDA agent: \'' + this.agentPath + '\'');
    }
  }, {
    key: 'uninstall',
    value: function uninstall() {
      return _regeneratorRuntime.async(function uninstall$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Removing WDA application from device');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.device.removeApp(WDA_BUNDLE_ID));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'launch',
    value: function launch(sessionId) {
      return _regeneratorRuntime.async(function launch$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.webDriverAgentUrl) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].info('Using provided WebdriverAgent at \'' + this.webDriverAgentUrl + '\'');
            this.url = this.webDriverAgentUrl;
            this.setupProxy(sessionId);
            return context$2$0.abrupt('return', this.webDriverAgentUrl);

          case 5:

            _logger2['default'].info('Launching WebDriverAgent on the device');

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.agentPath));

          case 8:
            if (context$2$0.sent) {
              context$2$0.next = 10;
              break;
            }

            throw new Error('Trying to use WebDriverAgent project at \'' + this.agentPath + '\' but the ' + 'file does not exist');

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.checkForDependencies());

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.killHangingProcesses());

          case 14:
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.createXcodeBuildSubProcess());

          case 16:
            this.xcodebuild = context$2$0.sent;

            if (!this.realDevice) {
              context$2$0.next = 21;
              break;
            }

            this.iproxy = this.createiProxySubProcess(this.url.port, WDA_AGENT_PORT);
            context$2$0.next = 21;
            return _regeneratorRuntime.awrap(this.startiproxy());

          case 21:

            this.setupProxy(sessionId);

            // start the xcodebuild process
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(this.startXcodebuild());

          case 24:
            return context$2$0.abrupt('return');

          case 25:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setupProxy',
    value: function setupProxy(sessionId) {
      this.jwproxy = new _appiumBaseDriver.JWProxy({
        server: this.url.hostname,
        port: this.url.port,
        base: '',
        timeout: this.wdaConnectionTimeout
      });
      this.jwproxy.sessionId = sessionId;
      this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    }
  }, {
    key: 'checkForDependencies',
    value: function checkForDependencies() {
      var carthagePath;
      return _regeneratorRuntime.async(function checkForDependencies$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.which('carthage'));

          case 3:
            carthagePath = context$2$0.sent;

            _logger2['default'].debug('Carthage found: ' + carthagePath);
            context$2$0.next = 10;
            break;

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](0);

            _logger2['default'].warn('Carthage not found. Install using `brew install carthage`');

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(this.bootstrapPath + '/Carthage'));

          case 12:
            if (context$2$0.sent) {
              context$2$0.next = 16;
              break;
            }

            _logger2['default'].debug('Running WebDriverAgent bootstrap script to install dependencies');
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('/bin/bash', ['Scripts/bootstrap.sh', '-d'], { cwd: this.bootstrapPath }));

          case 16:
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(this.bootstrapPath + '/Resources'));

          case 18:
            if (context$2$0.sent) {
              context$2$0.next = 22;
              break;
            }

            _logger2['default'].debug('Creating WebDriverAgent resources directory');
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(this.bootstrapPath + '/Resources'));

          case 22:
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(this.bootstrapPath + '/Resources/WebDriverAgent.bundle'));

          case 24:
            if (context$2$0.sent) {
              context$2$0.next = 28;
              break;
            }

            _logger2['default'].debug('Creating WebDriverAgent resource bundle directory');
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(this.bootstrapPath + '/Resources/WebDriverAgent.bundle'));

          case 28:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 7]]);
    }
  }, {
    key: 'getXcodeBuildCommand',
    value: function getXcodeBuildCommand() {
      var _args;

      var cmd = 'xcodebuild';
      var args = undefined;

      // figure out the targets for xcodebuild
      if (this.xcodeVersion.major < 8) {
        if (this.usePrebuiltWDA) {
          var msg = '\'usePrebuiltWDA\' set, but on Xcode ' + ('\'' + this.xcodeVersion.versionString + '\', so skipping, as it ') + 'needs a version >= 8';
          _logger2['default'].warn(msg);
        }
        args = ['build', 'test'];
      } else {
        args = this.usePrebuiltWDA ? ['test-without-building'] : ['build-for-testing', 'test-without-building'];
      }

      // add the rest of the arguments for the xcodebuild command
      var genericArgs = ['-project', this.agentPath, '-scheme', 'WebDriverAgentRunner', '-destination', 'id=' + this.device.udid, '-configuration', 'Debug'];
      (_args = args).push.apply(_args, genericArgs);

      if (this.realDevice && this.xcodeConfigFile) {
        _logger2['default'].debug('Using Xcode configuration file: \'' + this.xcodeConfigFile + '\'');
        args.push('-xcconfig', this.xcodeConfigFile);
      }

      return { cmd: cmd, args: args };
    }
  }, {
    key: 'setRealDeviceSecurity',
    value: function setRealDeviceSecurity(keychainPath, keychainPassword) {
      return _regeneratorRuntime.async(function setRealDeviceSecurity$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Setting security for iOS device');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['-v', 'list-keychains', '-s', keychainPath]));

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['-v', 'unlock-keychain', '-p', keychainPassword, keychainPath]));

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['set-keychain-settings', '-t', '3600', '-l', keychainPath]));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createXcodeBuildSubProcess',
    value: function createXcodeBuildSubProcess() {
      var _getXcodeBuildCommand, cmd, args, xcodebuild, logXcodeOutput;

      return _regeneratorRuntime.async(function createXcodeBuildSubProcess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.realDevice) {
              context$2$0.next = 8;
              break;
            }

            if (!(this.keychainPath && this.keychainPassword)) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.setRealDeviceSecurity(this.keychainPath, this.keychainPassword));

          case 4:
            if (!(this.xcodeOrgId && this.xcodeSigningId && !this.xcodeConfigFile)) {
              context$2$0.next = 8;
              break;
            }

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _utilsJs.generateXcodeConfigFile)(this.xcodeOrgId, this.xcodeSigningId));

          case 7:
            this.xcodeConfigFile = context$2$0.sent;

          case 8:
            _getXcodeBuildCommand = this.getXcodeBuildCommand();
            cmd = _getXcodeBuildCommand.cmd;
            args = _getXcodeBuildCommand.args;

            _logger2['default'].debug('Beginning test with command \'' + cmd + ' ' + args.join(' ') + '\' ' + ('in directory \'' + this.bootstrapPath + '\''));
            xcodebuild = new _teen_process.SubProcess(cmd, args, { cwd: this.bootstrapPath });
            logXcodeOutput = this.showXcodeLog;

            xcodebuild.on('output', function (stdout, stderr) {
              var out = stdout || stderr;
              // we want to pull out the log file that is created, and highlight it
              // for diagnostic purposes
              if (out.indexOf('Writing diagnostic log for test session to') !== -1) {
                // pull out the first line that begins with the path separator
                // which *should* be the line indicating the log file generated
                var logLocation = _lodash2['default'].first(_lodash2['default'].remove(out.trim().split('\n'), function (v) {
                  return v.indexOf(_path2['default'].sep) === 0;
                }));
                _logger2['default'].debug('Log file for xcodebuild test: ' + logLocation);
              }

              // if we have an error we want to output the logs
              // otherwise the failure is inscrutible
              // but do not log permission errors from trying to write to attachments folder
              if (out.indexOf('Error Domain=') !== -1 && out.indexOf('Error writing attachment data to file') === -1) {
                logXcodeOutput = true;

                // terrible hack to handle case where xcode return 0 but is failing
                xcodebuild._wda_error_occurred = true;
              }

              if (logXcodeOutput) {
                xcodeLog.info(out);
              }
            });

            return context$2$0.abrupt('return', xcodebuild);

          case 16:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createiProxySubProcess',
    value: function createiProxySubProcess(localport, deviceport) {
      _logger2['default'].debug('Starting iproxy to forward traffic from local port ' + localport + ' to device port ' + deviceport + ' over USB');
      return new _teen_process.SubProcess('iproxy', [localport, deviceport, this.device.udid]);
    }
  }, {
    key: 'startXcodebuild',
    value: function startXcodebuild() {
      return _regeneratorRuntime.async(function startXcodebuild$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
              _this.xcodebuild.on('exit', function (code, signal) {
                _logger2['default'].info('xcodebuild exited with code \'' + code + '\' and signal \'' + signal + '\'');
                _this.xcodebuild.processExited = true;
                if (_this.xcodebuild._wda_error_occurred || !signal && code !== 0) {
                  return reject(new Error('xcodebuild failed with code ' + code));
                }
              });

              return (function callee$3$0() {
                var startTime, msg;
                return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                  while (1) switch (context$4$0.prev = context$4$0.next) {
                    case 0:
                      context$4$0.prev = 0;
                      startTime = process.hrtime();
                      context$4$0.next = 4;
                      return _regeneratorRuntime.awrap(this.xcodebuild.start());

                    case 4:
                      context$4$0.next = 6;
                      return _regeneratorRuntime.awrap(this.waitForStart(startTime));

                    case 6:
                      resolve();
                      context$4$0.next = 14;
                      break;

                    case 9:
                      context$4$0.prev = 9;
                      context$4$0.t0 = context$4$0['catch'](0);
                      msg = 'Unable to start WebDriverAgent: ' + context$4$0.t0;

                      _logger2['default'].error(msg);
                      reject(new Error(msg));

                    case 14:
                    case 'end':
                      return context$4$0.stop();
                  }
                }, null, _this, [[0, 9]]);
              })();
            }));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForStart',
    value: function waitForStart(startTime) {
      var retries, endTime, startupTime;
      return _regeneratorRuntime.async(function waitForStart$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // try to connect once every 0.5 seconds, until `wdaLaunchTimeout` is up
            _logger2['default'].debug('Waiting up to ' + this.wdaLaunchTimeout + 'ms for WebDriverAgent to start');
            context$2$0.prev = 1;
            retries = parseInt(this.wdaLaunchTimeout / 500, 10);
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(retries, 500, function callee$2$0() {
              var opts, res;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    if (!this.xcodebuild.processExited) {
                      context$3$0.next = 2;
                      break;
                    }

                    return context$3$0.abrupt('return');

                  case 2:
                    context$3$0.prev = 2;
                    opts = {
                      method: 'GET',
                      uri: this.url.href + 'status',
                      headers: 'Content-Type: application/json;charset=UTF-8, accept: application/json',
                      forever: true,
                      json: true
                    };
                    context$3$0.next = 6;
                    return _regeneratorRuntime.awrap((0, _requestPromise2['default'])(opts));

                  case 6:
                    res = context$3$0.sent;

                    if (!(res.status !== 0)) {
                      context$3$0.next = 9;
                      break;
                    }

                    throw new Error('Received non-zero status code from WDA server: \'' + res.status + '\'');

                  case 9:
                    if (res.value && res.value.ios && res.value.ios.ip) {
                      this.agentUrl = res.value.ios.ip;
                      _logger2['default'].debug('WebDriverAgent running on ip \'' + this.agentUrl + '\'');
                    }
                    context$3$0.next = 15;
                    break;

                  case 12:
                    context$3$0.prev = 12;
                    context$3$0.t0 = context$3$0['catch'](2);
                    throw new Error('Unable to connect to running WebDriverAgent: ' + context$3$0.t0.message);

                  case 15:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2, [[2, 12]]);
            }));

          case 5:
            endTime = process.hrtime(startTime);
            startupTime = parseInt((endTime[0] * 1e9 + endTime[1]) / 1e6, 10);

            _logger2['default'].debug('WebDriverAgent successfully started after ' + startupTime + 'ms');
            context$2$0.next = 14;
            break;

          case 10:
            context$2$0.prev = 10;
            context$2$0.t0 = context$2$0['catch'](1);

            // at this point, if we have not had any errors from xcode itself (reported
            // elsewhere), we can let this go through and try to create the session
            _logger2['default'].debug(context$2$0.t0.message);
            _logger2['default'].warn('Getting status of WebDriverAgent on device timed out. Continuing');

          case 14:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 10]]);
    }
  }, {
    key: 'startiproxy',
    value: function startiproxy() {
      return _regeneratorRuntime.async(function startiproxy$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
              _this3.iproxy.on('exit', function (code) {
                _logger2['default'].debug('iproxy exited with code \'' + code + '\'');
                if (code) {
                  return reject(new Error('iproxy exited with code \'' + code + '\''));
                }
              });
              _this3.iproxy.on('output', function (stdout, stderr) {
                // do nothing if we expect errors
                if (_this3.expectIProxyErrors) return;

                var out = stdout || stderr;
                var _iteratorNormalCompletion = true;
                var _didIteratorError = false;
                var _iteratorError = undefined;

                try {
                  for (var _iterator = _getIterator(out.split('\n')), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                    var line = _step.value;

                    if (!line.length) continue;

                    if (line.indexOf('Resource temporarily unavailable') !== -1) {
                      // this generally happens when WDA does not respond,
                      // so print a more useful message
                      _logger2['default'].debug('Connection to WDA timed out');
                    } else {
                      iproxyLog.debug(line);
                    }
                  }
                } catch (err) {
                  _didIteratorError = true;
                  _iteratorError = err;
                } finally {
                  try {
                    if (!_iteratorNormalCompletion && _iterator['return']) {
                      _iterator['return']();
                    }
                  } finally {
                    if (_didIteratorError) {
                      throw _iteratorError;
                    }
                  }
                }
              });

              return (function callee$3$0() {
                return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                  while (1) switch (context$4$0.prev = context$4$0.next) {
                    case 0:
                      context$4$0.prev = 0;
                      context$4$0.next = 3;
                      return _regeneratorRuntime.awrap(this.iproxy.start(IPROXY_TIMEOUT));

                    case 3:
                      resolve();
                      context$4$0.next = 10;
                      break;

                    case 6:
                      context$4$0.prev = 6;
                      context$4$0.t0 = context$4$0['catch'](0);

                      _logger2['default'].error('Error starting iproxy: \'' + context$4$0.t0.message + '\'');
                      reject(new Error('Unable to start iproxy. Is it installed?'));

                    case 10:
                    case 'end':
                      return context$4$0.stop();
                  }
                }, null, _this3, [[0, 6]]);
              })();
            }));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'killHangingProcesses',
    value: function killHangingProcesses() {
      var procNames, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, proc;

      return _regeneratorRuntime.async(function killHangingProcesses$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Killing hanging processes');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _utilsJs.killAppUsingAppName)(this.device.udid, 'xcodebuild'));

          case 3:
            procNames = this.realDevice ? ['iproxy'] : ['XCTRunner'];
            _iteratorNormalCompletion2 = true;
            _didIteratorError2 = false;
            _iteratorError2 = undefined;
            context$2$0.prev = 7;
            _iterator2 = _getIterator(procNames);

          case 9:
            if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
              context$2$0.next = 16;
              break;
            }

            proc = _step2.value;
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap((0, _utilsJs.killAppUsingAppName)(this.device.udid, proc));

          case 13:
            _iteratorNormalCompletion2 = true;
            context$2$0.next = 9;
            break;

          case 16:
            context$2$0.next = 22;
            break;

          case 18:
            context$2$0.prev = 18;
            context$2$0.t0 = context$2$0['catch'](7);
            _didIteratorError2 = true;
            _iteratorError2 = context$2$0.t0;

          case 22:
            context$2$0.prev = 22;
            context$2$0.prev = 23;

            if (!_iteratorNormalCompletion2 && _iterator2['return']) {
              _iterator2['return']();
            }

          case 25:
            context$2$0.prev = 25;

            if (!_didIteratorError2) {
              context$2$0.next = 28;
              break;
            }

            throw _iteratorError2;

          case 28:
            return context$2$0.finish(25);

          case 29:
            return context$2$0.finish(22);

          case 30:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[7, 18, 22, 30], [23,, 25, 29]]);
    }
  }, {
    key: 'quit',
    value: function quit() {
      var killProcess;
      return _regeneratorRuntime.async(function quit$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            killProcess = function killProcess(name, proc) {
              return _regeneratorRuntime.async(function killProcess$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    if (!(proc && proc.proc)) {
                      context$3$0.next = 22;
                      break;
                    }

                    _logger2['default'].info('Shutting down ' + name + ' process (pid ' + proc.proc.pid + ')');
                    context$3$0.prev = 2;
                    context$3$0.next = 5;
                    return _regeneratorRuntime.awrap(proc.stop('SIGTERM'));

                  case 5:
                    context$3$0.next = 22;
                    break;

                  case 7:
                    context$3$0.prev = 7;
                    context$3$0.t0 = context$3$0['catch'](2);

                    if (!(context$3$0.t0.message.indexOf('Process didn\'t end after') === -1)) {
                      context$3$0.next = 11;
                      break;
                    }

                    throw context$3$0.t0;

                  case 11:
                    _logger2['default'].debug(name + ' process did not end in a timely fashion: \'' + context$3$0.t0.message + '\'. ' + 'Sending \'SIGKILL\'...');
                    context$3$0.prev = 12;
                    context$3$0.next = 15;
                    return _regeneratorRuntime.awrap(proc.stop('SIGKILL'));

                  case 15:
                    context$3$0.next = 22;
                    break;

                  case 17:
                    context$3$0.prev = 17;
                    context$3$0.t1 = context$3$0['catch'](12);

                    if (!(context$3$0.t1.message.indexOf('not currently running') !== -1)) {
                      context$3$0.next = 21;
                      break;
                    }

                    return context$3$0.abrupt('return');

                  case 21:
                    throw context$3$0.t1;

                  case 22:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, this, [[2, 7], [12, 17]]);
            };

            _logger2['default'].info('Shutting down sub-processes');

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(killProcess('xcodebuild', this.xcodebuild));

          case 4:
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(killProcess('iproxy', this.iproxy));

          case 6:

            if (this.jwproxy) {
              this.jwproxy.sessionId = null;
            }

            this.expectIProxyErrors = true;

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'url',
    get: function get() {
      if (!this._url) {
        if (this.realDevice && this.wdaLocalPort) {
          this._url = _url3['default'].parse(WDA_BASE_URL + ':' + this.wdaLocalPort);
        } else {
          this._url = _url3['default'].parse(WDA_BASE_URL + ':' + WDA_AGENT_PORT);
        }
      }
      return this._url;
    },
    set: function set(_url) {
      this._url = _url3['default'].parse(_url);
    }
  }, {
    key: 'fullyStarted',
    get: function get() {
      return this.expectIProxyErrors;
    },
    set: function set() {
      var started = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];

      this.expectIProxyErrors = started;
    }
  }]);

  return WebDriverAgent;
})();

exports['default'] = WebDriverAgent;
exports.WebDriverAgent = WebDriverAgent;
exports.WDA_BUNDLE_ID = WDA_BUNDLE_ID;
exports.BOOTSTRAP_PATH = BOOTSTRAP_PATH;

// make sure that the WDA library has been built

//kill all hanging processes

// wrap the start procedure in a promise so that we can catch, and report,
// any startup errors that are thrown as events

// there has been an error elsewhere and we need to short-circuit

// must get [s, ns] array into ms

// the process ended but for some reason we were not informed
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFJLENBQUMsa0JBQWtCLEdBQUcsT0FBTyxDQUFDO0tBQ25DOzs7U0FuWUcsY0FBYzs7O3FCQXNZTCxjQUFjO1FBQ3BCLGNBQWMsR0FBZCxjQUFjO1FBQUUsYUFBYSxHQUFiLGFBQWE7UUFBRSxjQUFjLEdBQWQsY0FBYyIsImZpbGUiOiJsaWIvd2ViZHJpdmVyYWdlbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgU3ViUHJvY2VzcywgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBnZXRMb2dnZXIgfSBmcm9tICdhcHBpdW0tbG9nZ2VyJztcbmltcG9ydCB7IGtpbGxBcHBVc2luZ0FwcE5hbWUsIGdlbmVyYXRlWGNvZGVDb25maWdGaWxlIH0gZnJvbSAnLi91dGlscy5qcyc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuXG5cbmNvbnN0IHhjb2RlTG9nID0gZ2V0TG9nZ2VyKCdYY29kZScpO1xuY29uc3QgaXByb3h5TG9nID0gZ2V0TG9nZ2VyKCdpUHJveHknKTtcblxuY29uc3QgQk9PVFNUUkFQX1BBVEggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnV2ViRHJpdmVyQWdlbnQnKTtcbmNvbnN0IFdEQV9CVU5ETEVfSUQgPSAnY29tLmFwcGxlLnRlc3QuV2ViRHJpdmVyQWdlbnRSdW5uZXItUnVubmVyJztcbmNvbnN0IERFRkFVTFRfU0lHTklOR19JRCA9IFwiaVBob25lIERldmVsb3BlclwiO1xuY29uc3QgV0RBX0xBVU5DSF9USU1FT1VUID0gNjAgKiAxMDAwO1xuY29uc3QgSVBST1hZX1RJTUVPVVQgPSA1MDAwO1xuY29uc3QgV0RBX0FHRU5UX1BPUlQgPSA4MTAwO1xuY29uc3QgV0RBX0JBU0VfVVJMID0gJ2h0dHA6Ly9sb2NhbGhvc3QnO1xuXG5jbGFzcyBXZWJEcml2ZXJBZ2VudCB7XG5cbiAgLy8gYWdlbnRQYXRoIChvcHRpb25hbCk6IFBhdGggdG8gV2ViZHJpdmVyQWdlbnQgRXhlY3V0YWJsZSAoaW5zaWRlIFdlYkRyaXZlckFnZW50LmFwcClcbiAgY29uc3RydWN0b3IgKHhjb2RlVmVyc2lvbiwgYXJncyA9IHt9KSB7XG4gICAgdGhpcy54Y29kZVZlcnNpb24gPSB4Y29kZVZlcnNpb247XG5cbiAgICB0aGlzLmRldmljZSA9IGFyZ3MuZGV2aWNlO1xuICAgIHRoaXMucGxhdGZvcm1WZXJzaW9uID0gYXJncy5wbGF0Zm9ybVZlcnNpb247XG4gICAgdGhpcy5ob3N0ID0gYXJncy5ob3N0O1xuICAgIHRoaXMucmVhbERldmljZSA9ICEhYXJncy5yZWFsRGV2aWNlO1xuXG4gICAgdGhpcy5zZXRXREFQYXRocyhhcmdzLmJvb3RzdHJhcFBhdGgsIGFyZ3MuYWdlbnRQYXRoKTtcblxuICAgIHRoaXMud2RhTG9jYWxQb3J0ID0gYXJncy53ZGFMb2NhbFBvcnQ7XG4gICAgdGhpcy5zaG93WGNvZGVMb2cgPSAhIWFyZ3Muc2hvd1hjb2RlTG9nO1xuICAgIHRoaXMueGNvZGVDb25maWdGaWxlID0gYXJncy54Y29kZUNvbmZpZ0ZpbGU7XG4gICAgdGhpcy54Y29kZU9yZ0lkID0gYXJncy54Y29kZU9yZ0lkO1xuICAgIHRoaXMueGNvZGVTaWduaW5nSWQgPSBhcmdzLnhjb2RlU2lnbmluZ0lkIHx8IERFRkFVTFRfU0lHTklOR19JRDtcbiAgICB0aGlzLmtleWNoYWluUGF0aCA9IGFyZ3Mua2V5Y2hhaW5QYXRoO1xuICAgIHRoaXMua2V5Y2hhaW5QYXNzd29yZCA9IGFyZ3Mua2V5Y2hhaW5QYXNzd29yZDtcblxuICAgIHRoaXMudXNlUHJlYnVpbHRXREEgPSBhcmdzLnVzZVByZWJ1aWx0V0RBO1xuICAgIHRoaXMud2ViRHJpdmVyQWdlbnRVcmwgPSBhcmdzLndlYkRyaXZlckFnZW50VXJsO1xuXG4gICAgdGhpcy5leHBlY3RJUHJveHlFcnJvcnMgPSB0cnVlO1xuXG4gICAgdGhpcy53ZGFMYXVuY2hUaW1lb3V0ID0gYXJncy53ZGFMYXVuY2hUaW1lb3V0IHx8IFdEQV9MQVVOQ0hfVElNRU9VVDtcbiAgICB0aGlzLndkYUNvbm5lY3Rpb25UaW1lb3V0ID0gYXJncy53ZGFDb25uZWN0aW9uVGltZW91dDtcbiAgfVxuXG4gIHNldFdEQVBhdGhzIChib290c3RyYXBQYXRoLCBhZ2VudFBhdGgpIHtcbiAgICAvLyBhbGxvdyB0aGUgdXNlciB0byBzcGVjaWZ5IGEgcGxhY2UgZm9yIFdEQS4gVGhpcyBpcyB1bmRvY3VtZW50ZWQgYW5kXG4gICAgLy8gb25seSBoZXJlIGZvciB0aGUgcHVycG9zZXMgb2YgdGVzdGluZyBkZXZlbG9wbWVudCBvZiBXREFcbiAgICB0aGlzLmJvb3RzdHJhcFBhdGggPSBib290c3RyYXBQYXRoIHx8IEJPT1RTVFJBUF9QQVRIO1xuICAgIGxvZy5pbmZvKGBVc2luZyBXREEgcGF0aDogJyR7dGhpcy5ib290c3RyYXBQYXRofSdgKTtcblxuICAgIC8vIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5IHdlIG5lZWQgdG8gYmUgYWJsZSB0byBzcGVjaWZ5IGFnZW50UGF0aCB0b29cbiAgICB0aGlzLmFnZW50UGF0aCA9IGFnZW50UGF0aCB8fCBwYXRoLnJlc29sdmUodGhpcy5ib290c3RyYXBQYXRoLCAnV2ViRHJpdmVyQWdlbnQueGNvZGVwcm9qJyk7XG4gICAgbG9nLmluZm8oYFVzaW5nIFdEQSBhZ2VudDogJyR7dGhpcy5hZ2VudFBhdGh9J2ApO1xuICB9XG5cbiAgYXN5bmMgdW5pbnN0YWxsICgpIHtcbiAgICBsb2cuZGVidWcoYFJlbW92aW5nIFdEQSBhcHBsaWNhdGlvbiBmcm9tIGRldmljZWApO1xuICAgIGF3YWl0IHRoaXMuZGV2aWNlLnJlbW92ZUFwcChXREFfQlVORExFX0lEKTtcbiAgfVxuXG4gIGFzeW5jIGxhdW5jaCAoc2Vzc2lvbklkKSB7XG4gICAgaWYgKHRoaXMud2ViRHJpdmVyQWdlbnRVcmwpIHtcbiAgICAgIGxvZy5pbmZvKGBVc2luZyBwcm92aWRlZCBXZWJkcml2ZXJBZ2VudCBhdCAnJHt0aGlzLndlYkRyaXZlckFnZW50VXJsfSdgKTtcbiAgICAgIHRoaXMudXJsID0gdGhpcy53ZWJEcml2ZXJBZ2VudFVybDtcbiAgICAgIHRoaXMuc2V0dXBQcm94eShzZXNzaW9uSWQpO1xuICAgICAgcmV0dXJuIHRoaXMud2ViRHJpdmVyQWdlbnRVcmw7XG4gICAgfVxuXG4gICAgbG9nLmluZm8oJ0xhdW5jaGluZyBXZWJEcml2ZXJBZ2VudCBvbiB0aGUgZGV2aWNlJyk7XG5cbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyh0aGlzLmFnZW50UGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJ5aW5nIHRvIHVzZSBXZWJEcml2ZXJBZ2VudCBwcm9qZWN0IGF0ICcke3RoaXMuYWdlbnRQYXRofScgYnV0IHRoZSBgICtcbiAgICAgICAgICAgICAgICAgICAgICAnZmlsZSBkb2VzIG5vdCBleGlzdCcpO1xuICAgIH1cblxuICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBXREEgbGlicmFyeSBoYXMgYmVlbiBidWlsdFxuICAgIGF3YWl0IHRoaXMuY2hlY2tGb3JEZXBlbmRlbmNpZXMoKTtcblxuICAgIC8va2lsbCBhbGwgaGFuZ2luZyBwcm9jZXNzZXNcbiAgICBhd2FpdCB0aGlzLmtpbGxIYW5naW5nUHJvY2Vzc2VzKCk7XG5cbiAgICB0aGlzLnhjb2RlYnVpbGQgPSBhd2FpdCB0aGlzLmNyZWF0ZVhjb2RlQnVpbGRTdWJQcm9jZXNzKCk7XG5cbiAgICBpZiAodGhpcy5yZWFsRGV2aWNlKSB7XG4gICAgICB0aGlzLmlwcm94eSA9IHRoaXMuY3JlYXRlaVByb3h5U3ViUHJvY2Vzcyh0aGlzLnVybC5wb3J0LCBXREFfQUdFTlRfUE9SVCk7XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0aXByb3h5KCk7XG4gICAgfVxuXG4gICAgdGhpcy5zZXR1cFByb3h5KHNlc3Npb25JZCk7XG5cbiAgICAvLyBzdGFydCB0aGUgeGNvZGVidWlsZCBwcm9jZXNzXG4gICAgYXdhaXQgdGhpcy5zdGFydFhjb2RlYnVpbGQoKTtcblxuICAgIHJldHVybjtcbiAgfVxuXG4gIHNldHVwUHJveHkgKHNlc3Npb25JZCkge1xuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtcbiAgICAgIHNlcnZlcjogdGhpcy51cmwuaG9zdG5hbWUsXG4gICAgICBwb3J0OiB0aGlzLnVybC5wb3J0LFxuICAgICAgYmFzZTogJycsXG4gICAgICB0aW1lb3V0OiB0aGlzLndkYUNvbm5lY3Rpb25UaW1lb3V0LFxuICAgIH0pO1xuICAgIHRoaXMuandwcm94eS5zZXNzaW9uSWQgPSBzZXNzaW9uSWQ7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuandwcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMuandwcm94eSk7XG4gIH1cblxuICBhc3luYyBjaGVja0ZvckRlcGVuZGVuY2llcyAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBjYXJ0aGFnZVBhdGggPSBhd2FpdCBmcy53aGljaCgnY2FydGhhZ2UnKTtcbiAgICAgIGxvZy5kZWJ1ZyhgQ2FydGhhZ2UgZm91bmQ6ICR7Y2FydGhhZ2VQYXRofWApO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oJ0NhcnRoYWdlIG5vdCBmb3VuZC4gSW5zdGFsbCB1c2luZyBgYnJldyBpbnN0YWxsIGNhcnRoYWdlYCcpO1xuICAgIH1cbiAgICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhgJHt0aGlzLmJvb3RzdHJhcFBhdGh9L0NhcnRoYWdlYCkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnUnVubmluZyBXZWJEcml2ZXJBZ2VudCBib290c3RyYXAgc2NyaXB0IHRvIGluc3RhbGwgZGVwZW5kZW5jaWVzJyk7XG4gICAgICBhd2FpdCBleGVjKCcvYmluL2Jhc2gnLCBbJ1NjcmlwdHMvYm9vdHN0cmFwLnNoJywgJy1kJ10sIHtjd2Q6IHRoaXMuYm9vdHN0cmFwUGF0aH0pO1xuICAgIH1cbiAgICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhgJHt0aGlzLmJvb3RzdHJhcFBhdGh9L1Jlc291cmNlc2ApKSB7XG4gICAgICBsb2cuZGVidWcoJ0NyZWF0aW5nIFdlYkRyaXZlckFnZW50IHJlc291cmNlcyBkaXJlY3RvcnknKTtcbiAgICAgIGF3YWl0IGZzLm1rZGlyKGAke3RoaXMuYm9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzYCk7XG4gICAgfVxuICAgIGlmICghYXdhaXQgZnMuaGFzQWNjZXNzKGAke3RoaXMuYm9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzL1dlYkRyaXZlckFnZW50LmJ1bmRsZWApKSB7XG4gICAgICBsb2cuZGVidWcoJ0NyZWF0aW5nIFdlYkRyaXZlckFnZW50IHJlc291cmNlIGJ1bmRsZSBkaXJlY3RvcnknKTtcbiAgICAgIGF3YWl0IGZzLm1rZGlyKGAke3RoaXMuYm9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzL1dlYkRyaXZlckFnZW50LmJ1bmRsZWApO1xuICAgIH1cbiAgfVxuXG4gIGdldFhjb2RlQnVpbGRDb21tYW5kICgpIHtcbiAgICBsZXQgY21kID0gJ3hjb2RlYnVpbGQnO1xuICAgIGxldCBhcmdzO1xuXG4gICAgLy8gZmlndXJlIG91dCB0aGUgdGFyZ2V0cyBmb3IgeGNvZGVidWlsZFxuICAgIGlmICh0aGlzLnhjb2RlVmVyc2lvbi5tYWpvciA8IDgpIHtcbiAgICAgIGlmICh0aGlzLnVzZVByZWJ1aWx0V0RBKSB7XG4gICAgICAgIGxldCBtc2cgPSBgJ3VzZVByZWJ1aWx0V0RBJyBzZXQsIGJ1dCBvbiBYY29kZSBgICtcbiAgICAgICAgICAgICAgICAgIGAnJHt0aGlzLnhjb2RlVmVyc2lvbi52ZXJzaW9uU3RyaW5nfScsIHNvIHNraXBwaW5nLCBhcyBpdCBgICtcbiAgICAgICAgICAgICAgICAgIGBuZWVkcyBhIHZlcnNpb24gPj0gOGA7XG4gICAgICAgIGxvZy53YXJuKG1zZyk7XG4gICAgICB9XG4gICAgICBhcmdzID1bXG4gICAgICAgICdidWlsZCcsXG4gICAgICAgICd0ZXN0JyxcbiAgICAgIF07XG4gICAgfSBlbHNlIHtcbiAgICAgIGFyZ3MgPSB0aGlzLnVzZVByZWJ1aWx0V0RBID8gW1xuICAgICAgICAndGVzdC13aXRob3V0LWJ1aWxkaW5nJ1xuICAgICAgXSA6IFtcbiAgICAgICAgJ2J1aWxkLWZvci10ZXN0aW5nJyxcbiAgICAgICAgJ3Rlc3Qtd2l0aG91dC1idWlsZGluZydcbiAgICAgIF07XG4gICAgfVxuXG4gICAgLy8gYWRkIHRoZSByZXN0IG9mIHRoZSBhcmd1bWVudHMgZm9yIHRoZSB4Y29kZWJ1aWxkIGNvbW1hbmRcbiAgICBsZXQgZ2VuZXJpY0FyZ3MgPSBbXG4gICAgICAnLXByb2plY3QnLCB0aGlzLmFnZW50UGF0aCxcbiAgICAgICctc2NoZW1lJywgJ1dlYkRyaXZlckFnZW50UnVubmVyJyxcbiAgICAgICctZGVzdGluYXRpb24nLCBgaWQ9JHt0aGlzLmRldmljZS51ZGlkfWAsXG4gICAgICAnLWNvbmZpZ3VyYXRpb24nLCAnRGVidWcnXG4gICAgXTtcbiAgICBhcmdzLnB1c2goLi4uZ2VuZXJpY0FyZ3MpO1xuXG4gICAgaWYgKHRoaXMucmVhbERldmljZSAmJiB0aGlzLnhjb2RlQ29uZmlnRmlsZSkge1xuICAgICAgbG9nLmRlYnVnKGBVc2luZyBYY29kZSBjb25maWd1cmF0aW9uIGZpbGU6ICcke3RoaXMueGNvZGVDb25maWdGaWxlfSdgKTtcbiAgICAgIGFyZ3MucHVzaCgnLXhjY29uZmlnJywgdGhpcy54Y29kZUNvbmZpZ0ZpbGUpO1xuICAgIH1cblxuICAgIHJldHVybiB7Y21kLCBhcmdzfTtcbiAgfVxuXG4gIGFzeW5jIHNldFJlYWxEZXZpY2VTZWN1cml0eSAoa2V5Y2hhaW5QYXRoLCBrZXljaGFpblBhc3N3b3JkKSB7XG4gICAgbG9nLmRlYnVnKCdTZXR0aW5nIHNlY3VyaXR5IGZvciBpT1MgZGV2aWNlJyk7XG4gICAgYXdhaXQgZXhlYygnc2VjdXJpdHknLCBbJy12JywgJ2xpc3Qta2V5Y2hhaW5zJywgJy1zJywga2V5Y2hhaW5QYXRoXSk7XG4gICAgYXdhaXQgZXhlYygnc2VjdXJpdHknLCBbJy12JywgJ3VubG9jay1rZXljaGFpbicsICctcCcsIGtleWNoYWluUGFzc3dvcmQsIGtleWNoYWluUGF0aF0pO1xuICAgIGF3YWl0IGV4ZWMoJ3NlY3VyaXR5JywgWydzZXQta2V5Y2hhaW4tc2V0dGluZ3MnLCAnLXQnLCAnMzYwMCcsICctbCcsIGtleWNoYWluUGF0aF0pO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlWGNvZGVCdWlsZFN1YlByb2Nlc3MgKCkge1xuICAgIGlmICh0aGlzLnJlYWxEZXZpY2UpIHtcbiAgICAgIGlmICh0aGlzLmtleWNoYWluUGF0aCAmJiB0aGlzLmtleWNoYWluUGFzc3dvcmQpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5zZXRSZWFsRGV2aWNlU2VjdXJpdHkodGhpcy5rZXljaGFpblBhdGgsIHRoaXMua2V5Y2hhaW5QYXNzd29yZCk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy54Y29kZU9yZ0lkICYmIHRoaXMueGNvZGVTaWduaW5nSWQgJiYgIXRoaXMueGNvZGVDb25maWdGaWxlKSB7XG4gICAgICAgIHRoaXMueGNvZGVDb25maWdGaWxlID0gYXdhaXQgZ2VuZXJhdGVYY29kZUNvbmZpZ0ZpbGUodGhpcy54Y29kZU9yZ0lkLCB0aGlzLnhjb2RlU2lnbmluZ0lkKTtcbiAgICAgIH1cbiAgICB9XG4gICAgbGV0IHtjbWQsIGFyZ3N9ID0gdGhpcy5nZXRYY29kZUJ1aWxkQ29tbWFuZCgpO1xuICAgIGxvZy5kZWJ1ZyhgQmVnaW5uaW5nIHRlc3Qgd2l0aCBjb21tYW5kICcke2NtZH0gJHthcmdzLmpvaW4oJyAnKX0nIGAgK1xuICAgICAgICAgICAgICBgaW4gZGlyZWN0b3J5ICcke3RoaXMuYm9vdHN0cmFwUGF0aH0nYCk7XG4gICAgbGV0IHhjb2RlYnVpbGQgPSBuZXcgU3ViUHJvY2VzcyhjbWQsIGFyZ3MsIHtjd2Q6IHRoaXMuYm9vdHN0cmFwUGF0aH0pO1xuXG4gICAgbGV0IGxvZ1hjb2RlT3V0cHV0ID0gdGhpcy5zaG93WGNvZGVMb2c7XG4gICAgeGNvZGVidWlsZC5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICBsZXQgb3V0ID0gc3Rkb3V0IHx8IHN0ZGVycjtcbiAgICAgIC8vIHdlIHdhbnQgdG8gcHVsbCBvdXQgdGhlIGxvZyBmaWxlIHRoYXQgaXMgY3JlYXRlZCwgYW5kIGhpZ2hsaWdodCBpdFxuICAgICAgLy8gZm9yIGRpYWdub3N0aWMgcHVycG9zZXNcbiAgICAgIGlmIChvdXQuaW5kZXhPZignV3JpdGluZyBkaWFnbm9zdGljIGxvZyBmb3IgdGVzdCBzZXNzaW9uIHRvJykgIT09IC0xKSB7XG4gICAgICAgIC8vIHB1bGwgb3V0IHRoZSBmaXJzdCBsaW5lIHRoYXQgYmVnaW5zIHdpdGggdGhlIHBhdGggc2VwYXJhdG9yXG4gICAgICAgIC8vIHdoaWNoICpzaG91bGQqIGJlIHRoZSBsaW5lIGluZGljYXRpbmcgdGhlIGxvZyBmaWxlIGdlbmVyYXRlZFxuICAgICAgICBsZXQgbG9nTG9jYXRpb24gPSBfLmZpcnN0KF8ucmVtb3ZlKG91dC50cmltKCkuc3BsaXQoJ1xcbicpLCAodikgPT4gdi5pbmRleE9mKHBhdGguc2VwKSA9PT0gMCkpO1xuICAgICAgICBsb2cuZGVidWcoYExvZyBmaWxlIGZvciB4Y29kZWJ1aWxkIHRlc3Q6ICR7bG9nTG9jYXRpb259YCk7XG4gICAgICB9XG5cbiAgICAgIC8vIGlmIHdlIGhhdmUgYW4gZXJyb3Igd2Ugd2FudCB0byBvdXRwdXQgdGhlIGxvZ3NcbiAgICAgIC8vIG90aGVyd2lzZSB0aGUgZmFpbHVyZSBpcyBpbnNjcnV0aWJsZVxuICAgICAgLy8gYnV0IGRvIG5vdCBsb2cgcGVybWlzc2lvbiBlcnJvcnMgZnJvbSB0cnlpbmcgdG8gd3JpdGUgdG8gYXR0YWNobWVudHMgZm9sZGVyXG4gICAgICBpZiAob3V0LmluZGV4T2YoJ0Vycm9yIERvbWFpbj0nKSAhPT0gLTEgJiYgb3V0LmluZGV4T2YoJ0Vycm9yIHdyaXRpbmcgYXR0YWNobWVudCBkYXRhIHRvIGZpbGUnKSA9PT0gLTEpIHtcbiAgICAgICAgbG9nWGNvZGVPdXRwdXQgPSB0cnVlO1xuXG4gICAgICAgIC8vIHRlcnJpYmxlIGhhY2sgdG8gaGFuZGxlIGNhc2Ugd2hlcmUgeGNvZGUgcmV0dXJuIDAgYnV0IGlzIGZhaWxpbmdcbiAgICAgICAgeGNvZGVidWlsZC5fd2RhX2Vycm9yX29jY3VycmVkID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKGxvZ1hjb2RlT3V0cHV0KSB7XG4gICAgICAgIHhjb2RlTG9nLmluZm8ob3V0KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB4Y29kZWJ1aWxkO1xuICB9XG5cbiAgY3JlYXRlaVByb3h5U3ViUHJvY2VzcyAobG9jYWxwb3J0LCBkZXZpY2Vwb3J0KSB7XG4gICAgbG9nLmRlYnVnKGBTdGFydGluZyBpcHJveHkgdG8gZm9yd2FyZCB0cmFmZmljIGZyb20gbG9jYWwgcG9ydCAke2xvY2FscG9ydH0gdG8gZGV2aWNlIHBvcnQgJHtkZXZpY2Vwb3J0fSBvdmVyIFVTQmApO1xuICAgIHJldHVybiBuZXcgU3ViUHJvY2VzcyhgaXByb3h5YCwgW2xvY2FscG9ydCwgZGV2aWNlcG9ydCwgdGhpcy5kZXZpY2UudWRpZF0pO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRYY29kZWJ1aWxkICgpIHtcbiAgICAvLyB3cmFwIHRoZSBzdGFydCBwcm9jZWR1cmUgaW4gYSBwcm9taXNlIHNvIHRoYXQgd2UgY2FuIGNhdGNoLCBhbmQgcmVwb3J0LFxuICAgIC8vIGFueSBzdGFydHVwIGVycm9ycyB0aGF0IGFyZSB0aHJvd24gYXMgZXZlbnRzXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMueGNvZGVidWlsZC5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgICAgbG9nLmluZm8oYHhjb2RlYnVpbGQgZXhpdGVkIHdpdGggY29kZSAnJHtjb2RlfScgYW5kIHNpZ25hbCAnJHtzaWduYWx9J2ApO1xuICAgICAgICB0aGlzLnhjb2RlYnVpbGQucHJvY2Vzc0V4aXRlZCA9IHRydWU7XG4gICAgICAgIGlmICh0aGlzLnhjb2RlYnVpbGQuX3dkYV9lcnJvcl9vY2N1cnJlZCB8fCAoIXNpZ25hbCAmJiBjb2RlICE9PSAwKSkge1xuICAgICAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKGB4Y29kZWJ1aWxkIGZhaWxlZCB3aXRoIGNvZGUgJHtjb2RlfWApKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiAoYXN5bmMgKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGxldCBzdGFydFRpbWUgPSBwcm9jZXNzLmhydGltZSgpO1xuICAgICAgICAgIGF3YWl0IHRoaXMueGNvZGVidWlsZC5zdGFydCgpO1xuICAgICAgICAgIGF3YWl0IHRoaXMud2FpdEZvclN0YXJ0KHN0YXJ0VGltZSk7XG4gICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsZXQgbXNnID0gYFVuYWJsZSB0byBzdGFydCBXZWJEcml2ZXJBZ2VudDogJHtlcnJ9YDtcbiAgICAgICAgICBsb2cuZXJyb3IobXNnKTtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKG1zZykpO1xuICAgICAgICB9XG4gICAgICB9KSgpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvclN0YXJ0IChzdGFydFRpbWUpIHtcbiAgICAvLyB0cnkgdG8gY29ubmVjdCBvbmNlIGV2ZXJ5IDAuNSBzZWNvbmRzLCB1bnRpbCBgd2RhTGF1bmNoVGltZW91dGAgaXMgdXBcbiAgICBsb2cuZGVidWcoYFdhaXRpbmcgdXAgdG8gJHt0aGlzLndkYUxhdW5jaFRpbWVvdXR9bXMgZm9yIFdlYkRyaXZlckFnZW50IHRvIHN0YXJ0YCk7XG4gICAgdHJ5IHtcbiAgICAgIGxldCByZXRyaWVzID0gcGFyc2VJbnQodGhpcy53ZGFMYXVuY2hUaW1lb3V0IC8gNTAwLCAxMCk7XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKHJldHJpZXMsIDUwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy54Y29kZWJ1aWxkLnByb2Nlc3NFeGl0ZWQpIHtcbiAgICAgICAgICAvLyB0aGVyZSBoYXMgYmVlbiBhbiBlcnJvciBlbHNld2hlcmUgYW5kIHdlIG5lZWQgdG8gc2hvcnQtY2lyY3VpdFxuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgIGxldCBvcHRzID0ge1xuICAgICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICAgIHVyaTogYCR7dGhpcy51cmwuaHJlZn1zdGF0dXNgLFxuICAgICAgICAgICAgaGVhZGVyczogJ0NvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PVVURi04LCBhY2NlcHQ6IGFwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgZm9yZXZlcjogdHJ1ZSxcbiAgICAgICAgICAgIGpzb246IHRydWUsXG4gICAgICAgICAgfTtcbiAgICAgICAgICBsZXQgcmVzID0gYXdhaXQgcmVxdWVzdChvcHRzKTtcbiAgICAgICAgICBpZiAocmVzLnN0YXR1cyAhPT0gMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWNlaXZlZCBub24temVybyBzdGF0dXMgY29kZSBmcm9tIFdEQSBzZXJ2ZXI6ICcke3Jlcy5zdGF0dXN9J2ApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzLnZhbHVlICYmIHJlcy52YWx1ZS5pb3MgJiYgcmVzLnZhbHVlLmlvcy5pcCkge1xuICAgICAgICAgICAgdGhpcy5hZ2VudFVybCA9IHJlcy52YWx1ZS5pb3MuaXA7XG4gICAgICAgICAgICBsb2cuZGVidWcoYFdlYkRyaXZlckFnZW50IHJ1bm5pbmcgb24gaXAgJyR7dGhpcy5hZ2VudFVybH0nYCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBjb25uZWN0IHRvIHJ1bm5pbmcgV2ViRHJpdmVyQWdlbnQ6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgbGV0IGVuZFRpbWUgPSBwcm9jZXNzLmhydGltZShzdGFydFRpbWUpO1xuICAgICAgLy8gbXVzdCBnZXQgW3MsIG5zXSBhcnJheSBpbnRvIG1zXG4gICAgICBsZXQgc3RhcnR1cFRpbWUgPSBwYXJzZUludCgoZW5kVGltZVswXSAqIDFlOSArIGVuZFRpbWVbMV0pIC8gMWU2LCAxMCk7XG4gICAgICBsb2cuZGVidWcoYFdlYkRyaXZlckFnZW50IHN1Y2Nlc3NmdWxseSBzdGFydGVkIGFmdGVyICR7c3RhcnR1cFRpbWV9bXNgKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGlmIHdlIGhhdmUgbm90IGhhZCBhbnkgZXJyb3JzIGZyb20geGNvZGUgaXRzZWxmIChyZXBvcnRlZFxuICAgICAgLy8gZWxzZXdoZXJlKSwgd2UgY2FuIGxldCB0aGlzIGdvIHRocm91Z2ggYW5kIHRyeSB0byBjcmVhdGUgdGhlIHNlc3Npb25cbiAgICAgIGxvZy5kZWJ1ZyhlcnIubWVzc2FnZSk7XG4gICAgICBsb2cud2FybihgR2V0dGluZyBzdGF0dXMgb2YgV2ViRHJpdmVyQWdlbnQgb24gZGV2aWNlIHRpbWVkIG91dC4gQ29udGludWluZ2ApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0YXJ0aXByb3h5ICgpIHtcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5pcHJveHkub24oJ2V4aXQnLCAoY29kZSkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoYGlwcm94eSBleGl0ZWQgd2l0aCBjb2RlICcke2NvZGV9J2ApO1xuICAgICAgICBpZiAoY29kZSkge1xuICAgICAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKGBpcHJveHkgZXhpdGVkIHdpdGggY29kZSAnJHtjb2RlfSdgKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgdGhpcy5pcHJveHkub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgICAvLyBkbyBub3RoaW5nIGlmIHdlIGV4cGVjdCBlcnJvcnNcbiAgICAgICAgaWYgKHRoaXMuZXhwZWN0SVByb3h5RXJyb3JzKSByZXR1cm47XG5cbiAgICAgICAgbGV0IG91dCA9IHN0ZG91dCB8fCBzdGRlcnI7XG4gICAgICAgIGZvciAobGV0IGxpbmUgb2Ygb3V0LnNwbGl0KCdcXG4nKSkge1xuICAgICAgICAgIGlmICghbGluZS5sZW5ndGgpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgaWYgKGxpbmUuaW5kZXhPZignUmVzb3VyY2UgdGVtcG9yYXJpbHkgdW5hdmFpbGFibGUnKSAhPT0gLTEpIHtcbiAgICAgICAgICAgIC8vIHRoaXMgZ2VuZXJhbGx5IGhhcHBlbnMgd2hlbiBXREEgZG9lcyBub3QgcmVzcG9uZCxcbiAgICAgICAgICAgIC8vIHNvIHByaW50IGEgbW9yZSB1c2VmdWwgbWVzc2FnZVxuICAgICAgICAgICAgbG9nLmRlYnVnKCdDb25uZWN0aW9uIHRvIFdEQSB0aW1lZCBvdXQnKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaXByb3h5TG9nLmRlYnVnKGxpbmUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiAoYXN5bmMgKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuaXByb3h5LnN0YXJ0KElQUk9YWV9USU1FT1VUKTtcbiAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGxvZy5lcnJvcihgRXJyb3Igc3RhcnRpbmcgaXByb3h5OiAnJHtlcnIubWVzc2FnZX0nYCk7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignVW5hYmxlIHRvIHN0YXJ0IGlwcm94eS4gSXMgaXQgaW5zdGFsbGVkPycpKTtcbiAgICAgICAgfVxuICAgICAgfSkoKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGtpbGxIYW5naW5nUHJvY2Vzc2VzICgpIHtcbiAgICBsb2cuZGVidWcoJ0tpbGxpbmcgaGFuZ2luZyBwcm9jZXNzZXMnKTtcbiAgICBhd2FpdCBraWxsQXBwVXNpbmdBcHBOYW1lKHRoaXMuZGV2aWNlLnVkaWQsIGB4Y29kZWJ1aWxkYCk7XG4gICAgbGV0IHByb2NOYW1lcyA9IHRoaXMucmVhbERldmljZSA/IFsnaXByb3h5J11cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogWydYQ1RSdW5uZXInXTtcbiAgICBmb3IgKGxldCBwcm9jIG9mIHByb2NOYW1lcykge1xuICAgICAgYXdhaXQga2lsbEFwcFVzaW5nQXBwTmFtZSh0aGlzLmRldmljZS51ZGlkLCBwcm9jKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBxdWl0ICgpIHtcbiAgICBsb2cuaW5mbygnU2h1dHRpbmcgZG93biBzdWItcHJvY2Vzc2VzJyk7XG5cbiAgICBhc3luYyBmdW5jdGlvbiBraWxsUHJvY2VzcyAobmFtZSwgcHJvYykge1xuICAgICAgaWYgKHByb2MgJiYgcHJvYy5wcm9jKSB7XG4gICAgICAgIGxvZy5pbmZvKGBTaHV0dGluZyBkb3duICR7bmFtZX0gcHJvY2VzcyAocGlkICR7cHJvYy5wcm9jLnBpZH0pYCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgcHJvYy5zdG9wKCdTSUdURVJNJyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKGBQcm9jZXNzIGRpZG4ndCBlbmQgYWZ0ZXJgKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICB9XG4gICAgICAgICAgbG9nLmRlYnVnKGAke25hbWV9IHByb2Nlc3MgZGlkIG5vdCBlbmQgaW4gYSB0aW1lbHkgZmFzaGlvbjogJyR7ZXJyLm1lc3NhZ2V9Jy4gYCArXG4gICAgICAgICAgICAgICAgICAgIGBTZW5kaW5nICdTSUdLSUxMJy4uLmApO1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBwcm9jLnN0b3AoJ1NJR0tJTEwnKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKCdub3QgY3VycmVudGx5IHJ1bm5pbmcnKSAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgLy8gdGhlIHByb2Nlc3MgZW5kZWQgYnV0IGZvciBzb21lIHJlYXNvbiB3ZSB3ZXJlIG5vdCBpbmZvcm1lZFxuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgYXdhaXQga2lsbFByb2Nlc3MoJ3hjb2RlYnVpbGQnLCB0aGlzLnhjb2RlYnVpbGQpO1xuICAgIGF3YWl0IGtpbGxQcm9jZXNzKCdpcHJveHknLCB0aGlzLmlwcm94eSk7XG5cbiAgICBpZiAodGhpcy5qd3Byb3h5KSB7XG4gICAgICB0aGlzLmp3cHJveHkuc2Vzc2lvbklkID0gbnVsbDtcbiAgICB9XG5cbiAgICB0aGlzLmV4cGVjdElQcm94eUVycm9ycyA9IHRydWU7XG4gIH1cblxuICBnZXQgdXJsICgpIHtcbiAgICBpZiAoIXRoaXMuX3VybCkge1xuICAgICAgaWYgKHRoaXMucmVhbERldmljZSAmJiB0aGlzLndkYUxvY2FsUG9ydCkge1xuICAgICAgICB0aGlzLl91cmwgPSB1cmwucGFyc2UoYCR7V0RBX0JBU0VfVVJMfToke3RoaXMud2RhTG9jYWxQb3J0fWApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fdXJsID0gdXJsLnBhcnNlKGAke1dEQV9CQVNFX1VSTH06JHtXREFfQUdFTlRfUE9SVH1gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3VybDtcbiAgfVxuXG4gIHNldCB1cmwgKF91cmwpIHtcbiAgICB0aGlzLl91cmwgPSB1cmwucGFyc2UoX3VybCk7XG4gIH1cblxuICBnZXQgZnVsbHlTdGFydGVkICgpIHtcbiAgICByZXR1cm4gdGhpcy5leHBlY3RJUHJveHlFcnJvcnM7XG4gIH1cblxuICBzZXQgZnVsbHlTdGFydGVkIChzdGFydGVkID0gZmFsc2UpIHtcbiAgICB0aGlzLmV4cGVjdElQcm94eUVycm9ycyA9IHN0YXJ0ZWQ7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgV2ViRHJpdmVyQWdlbnQ7XG5leHBvcnQgeyBXZWJEcml2ZXJBZ2VudCwgV0RBX0JVTkRMRV9JRCwgQk9PVFNUUkFQX1BBVEggfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

// Date-Utils: Polyfills for the Date object
require('date-utils');

var MAX_EVENTS = 5000;

var IOSPerformanceLog = (function () {
  function IOSPerformanceLog(remoteDebugger) {
    var maxEvents = arguments.length <= 1 || arguments[1] === undefined ? MAX_EVENTS : arguments[1];

    _classCallCheck(this, IOSPerformanceLog);

    this.remoteDebugger = remoteDebugger;
    this.maxEvents = parseInt(maxEvents, 10);

    this.timelineEvents = [];
  }

  _createClass(IOSPerformanceLog, [{
    key: 'startCapture',
    value: function startCapture() {
      return _regeneratorRuntime.async(function startCapture$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Starting performance (Timeline) log capture');
            this.timelineEvents = [];
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.remoteDebugger.startTimeline(this.onTimelineEvent.bind(this)));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stopCapture',
    value: function stopCapture() {
      return _regeneratorRuntime.async(function stopCapture$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Stopping performance (Timeline) log capture');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.remoteDebugger.stopTimeline());

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'onTimelineEvent',
    value: function onTimelineEvent(event) {
      _logger2['default'].debug('Received Timeline event: ' + _lodash2['default'].truncate(JSON.stringify(event)));
      this.timelineEvents.push(event);

      // if we have too many, get rid of the oldest log line
      if (this.timelineEvents.length > this.maxEvents) {
        var removedEvent = this.timelineEvents.shift();
        _logger2['default'].warn('Too many Timeline events, removing earliest: ' + _lodash2['default'].truncate(JSON.stringify(removedEvent)));
      }
    }
  }, {
    key: 'getLogs',
    value: function getLogs() {
      var events;
      return _regeneratorRuntime.async(function getLogs$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            events = this.timelineEvents;

            // flush events
            _logger2['default'].debug('Flushing Timeline events');
            this.timelineEvents = [];

            return context$2$0.abrupt('return', events);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getAllLogs',
    value: function getAllLogs() {
      return _regeneratorRuntime.async(function getAllLogs$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', this.getLogs());

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return IOSPerformanceLog;
})();

exports['default'] = IOSPerformanceLog;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtbG9nL2lvcy1wZXJmb3JtYW5jZS1sb2cuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7c0JBQW1CLFVBQVU7Ozs7c0JBQ2YsUUFBUTs7Ozs7QUFJdEIsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDOztBQUV0QixJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUM7O0lBRWxCLGlCQUFpQjtBQUNULFdBRFIsaUJBQWlCLENBQ1IsY0FBYyxFQUEwQjtRQUF4QixTQUFTLHlEQUFHLFVBQVU7OzBCQUQvQyxpQkFBaUI7O0FBRW5CLFFBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO0FBQ3JDLFFBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQzs7QUFFekMsUUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7R0FDMUI7O2VBTkcsaUJBQWlCOztXQVFGOzs7O0FBQ2pCLGdDQUFPLEtBQUssQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO0FBQzVELGdCQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQzs7NkNBQ1osSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Ozs7Ozs7Ozs7S0FDaEY7OztXQUVpQjs7OztBQUNoQixnQ0FBTyxLQUFLLENBQUMsNkNBQTZDLENBQUMsQ0FBQzs7NkNBQy9DLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxFQUFFOzs7Ozs7Ozs7O0tBQ2hEOzs7V0FFZSx5QkFBQyxLQUFLLEVBQUU7QUFDdEIsMEJBQU8sS0FBSywrQkFBNkIsb0JBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBRyxDQUFDO0FBQzlFLFVBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDOzs7QUFHaEMsVUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFO0FBQy9DLFlBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDL0MsNEJBQU8sSUFBSSxtREFBaUQsb0JBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBRyxDQUFDO09BQ3pHO0tBQ0Y7OztXQUVhO1VBQ1IsTUFBTTs7OztBQUFOLGtCQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWM7OztBQUdoQyxnQ0FBTyxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztBQUN6QyxnQkFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7O2dEQUVsQixNQUFNOzs7Ozs7O0tBQ2Q7OztXQUVnQjs7OztnREFDUixJQUFJLENBQUMsT0FBTyxFQUFFOzs7Ozs7O0tBQ3RCOzs7U0ExQ0csaUJBQWlCOzs7cUJBNkNSLGlCQUFpQiIsImZpbGUiOiJsaWIvZGV2aWNlLWxvZy9pb3MtcGVyZm9ybWFuY2UtbG9nLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5cbi8vIERhdGUtVXRpbHM6IFBvbHlmaWxscyBmb3IgdGhlIERhdGUgb2JqZWN0XG5yZXF1aXJlKCdkYXRlLXV0aWxzJyk7XG5cbmNvbnN0IE1BWF9FVkVOVFMgPSA1MDAwO1xuXG5jbGFzcyBJT1NQZXJmb3JtYW5jZUxvZyB7XG4gIGNvbnN0cnVjdG9yIChyZW1vdGVEZWJ1Z2dlciwgbWF4RXZlbnRzID0gTUFYX0VWRU5UUykge1xuICAgIHRoaXMucmVtb3RlRGVidWdnZXIgPSByZW1vdGVEZWJ1Z2dlcjtcbiAgICB0aGlzLm1heEV2ZW50cyA9IHBhcnNlSW50KG1heEV2ZW50cywgMTApO1xuXG4gICAgdGhpcy50aW1lbGluZUV2ZW50cyA9IFtdO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRDYXB0dXJlICgpIHtcbiAgICBsb2dnZXIuZGVidWcoJ1N0YXJ0aW5nIHBlcmZvcm1hbmNlIChUaW1lbGluZSkgbG9nIGNhcHR1cmUnKTtcbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRzID0gW107XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucmVtb3RlRGVidWdnZXIuc3RhcnRUaW1lbGluZSh0aGlzLm9uVGltZWxpbmVFdmVudC5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIGFzeW5jIHN0b3BDYXB0dXJlICgpIHtcbiAgICBsb2dnZXIuZGVidWcoJ1N0b3BwaW5nIHBlcmZvcm1hbmNlIChUaW1lbGluZSkgbG9nIGNhcHR1cmUnKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5yZW1vdGVEZWJ1Z2dlci5zdG9wVGltZWxpbmUoKTtcbiAgfVxuXG4gIG9uVGltZWxpbmVFdmVudCAoZXZlbnQpIHtcbiAgICBsb2dnZXIuZGVidWcoYFJlY2VpdmVkIFRpbWVsaW5lIGV2ZW50OiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoZXZlbnQpKX1gKTtcbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRzLnB1c2goZXZlbnQpO1xuXG4gICAgLy8gaWYgd2UgaGF2ZSB0b28gbWFueSwgZ2V0IHJpZCBvZiB0aGUgb2xkZXN0IGxvZyBsaW5lXG4gICAgaWYgKHRoaXMudGltZWxpbmVFdmVudHMubGVuZ3RoID4gdGhpcy5tYXhFdmVudHMpIHtcbiAgICAgIGxldCByZW1vdmVkRXZlbnQgPSB0aGlzLnRpbWVsaW5lRXZlbnRzLnNoaWZ0KCk7XG4gICAgICBsb2dnZXIud2FybihgVG9vIG1hbnkgVGltZWxpbmUgZXZlbnRzLCByZW1vdmluZyBlYXJsaWVzdDogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KHJlbW92ZWRFdmVudCkpfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldExvZ3MgKCkge1xuICAgIGxldCBldmVudHMgPSB0aGlzLnRpbWVsaW5lRXZlbnRzO1xuXG4gICAgLy8gZmx1c2ggZXZlbnRzXG4gICAgbG9nZ2VyLmRlYnVnKCdGbHVzaGluZyBUaW1lbGluZSBldmVudHMnKTtcbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRzID0gW107XG5cbiAgICByZXR1cm4gZXZlbnRzO1xuICB9XG5cbiAgYXN5bmMgZ2V0QWxsTG9ncyAoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0TG9ncygpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IElPU1BlcmZvcm1hbmNlTG9nO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9

'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumBaseDriver = require('appium-base-driver');

var _cookies = require('../cookies');

var _cookies2 = _interopRequireDefault(_cookies);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var commands = {},
    helpers = {},
    extensions = {};

var ELEMENT_OFFSET = 5000;

commands.setFrame = function callee$0$0(frame) {
  var command, atom, atomsElement, value;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 6;
          break;
        }

        frame = frame ? frame : 'target.frontMostApp()';
        command = 'wd_frame = ' + frame;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
        atom = undefined;

        if (!_lodash2['default'].isNull(frame)) {
          context$1$0.next = 11;
          break;
        }

        this.curWebFrames = [];
        _logger2['default'].debug('Leaving web frame and going back to default content');
        return context$1$0.abrupt('return');

      case 11:
        if (_lodash2['default'].isUndefined(frame.ELEMENT)) {
          context$1$0.next = 20;
          break;
        }

        atomsElement = this.useAtomsElement(frame.ELEMENT);
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(this.executeAtom('get_frame_window', [atomsElement]));

      case 15:
        value = context$1$0.sent;

        _logger2['default'].debug('Entering new web frame: \'' + value.WINDOW + '\'');
        this.curWebFrames.unshift(value.WINDOW);
        context$1$0.next = 28;
        break;

      case 20:
        atom = _lodash2['default'].isNumber(frame) ? 'frame_by_index' : 'frame_by_id_or_name';
        context$1$0.next = 23;
        return _regeneratorRuntime.awrap(this.executeAtom(atom, [frame]));

      case 23:
        value = context$1$0.sent;

        if (!(_lodash2['default'].isNull(value) || _lodash2['default'].isUndefined(value.WINDOW))) {
          context$1$0.next = 26;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchFrameError();

      case 26:
        _logger2['default'].debug('Entering new web frame: \'' + value.WINDOW + '\'');
        this.curWebFrames.unshift(value.WINDOW);

      case 28:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getCssProperty = function callee$0$0(propertyName, el) {
  var atomsElement;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('get_value_of_css_property', [atomsElement, propertyName]));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.submit = function callee$0$0(el) {
  var atomsElement;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 6;
          break;
        }

        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.executeAtom('submit', [atomsElement]));

      case 4:
        context$1$0.next = 7;
        break;

      case 6:
        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.refresh = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('refresh', []));

      case 3:
        context$1$0.next = 6;
        break;

      case 5:
        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setUrl = function callee$0$0(url) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Attempting to set url \'' + url + '\'');

        if (this.isWebContext()) {
          context$1$0.next = 3;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 3:
        this.setCurrentUrl(url);
        // make sure to clear out any leftover web frames
        this.curWebFrames = [];
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.remote.navToUrl(url));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getUrl = function callee$0$0() {
  var url;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.remote.execute('window.location.href'));

      case 4:
        url = context$1$0.sent;
        return context$1$0.abrupt('return', url);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.title = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.executeAtom('title', [], true));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getCookies = function callee$0$0() {
  var script, jsCookies, cookies, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, _name, value;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:

        _logger2['default'].debug('Retrieving all cookies');

        script = 'return document.cookie';
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, []]));

      case 6:
        jsCookies = context$1$0.sent;
        cookies = [];
        context$1$0.prev = 8;
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 12;

        for (_iterator = _getIterator(_lodash2['default'].toPairs(_cookies2['default'].createJWPCookie(undefined, jsCookies))); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          _step$value = _slicedToArray(_step.value, 2);
          _name = _step$value[0];
          value = _step$value[1];

          cookies.push({ name: _name, value: value });
        }
        context$1$0.next = 20;
        break;

      case 16:
        context$1$0.prev = 16;
        context$1$0.t0 = context$1$0['catch'](12);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 20:
        context$1$0.prev = 20;
        context$1$0.prev = 21;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 23:
        context$1$0.prev = 23;

        if (!_didIteratorError) {
          context$1$0.next = 26;
          break;
        }

        throw _iteratorError;

      case 26:
        return context$1$0.finish(23);

      case 27:
        return context$1$0.finish(20);

      case 28:
        return context$1$0.abrupt('return', cookies);

      case 31:
        context$1$0.prev = 31;
        context$1$0.t1 = context$1$0['catch'](8);

        _logger2['default'].error(context$1$0.t1);
        throw new _appiumBaseDriver.errors.UnknownError('Error parsing cookies from result: \'' + jsCookies + '\'');

      case 35:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[8, 31], [12, 16, 20, 28], [21,, 23, 27]]);
};

commands.setCookie = function callee$0$0(cookie) {
  var jsCookie, script;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:

        cookie = _lodash2['default'].clone(cookie);

        // if `path` field is not specified, Safari will not update cookies as expected; eg issue #1708
        if (!cookie.path) {
          cookie.path = "/";
        }

        jsCookie = _cookies2['default'].createJSCookie(cookie.name, cookie.value, {
          expires: _lodash2['default'].isNumber(cookie.expiry) ? new Date(cookie.expiry * 1000).toUTCString() : cookie.expiry,
          path: cookie.path,
          domain: cookie.domain,
          httpOnly: cookie.httpOnly,
          secure: cookie.secure
        });
        script = 'document.cookie = ' + JSON.stringify(jsCookie);
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, []]));

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.deleteCookie = function callee$0$0(cookieName) {
  var cookies;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.getCookies());

      case 4:
        cookies = context$1$0.sent;

        if (!(_lodash2['default'].indexOf(_lodash2['default'].map(cookies, 'name'), cookieName) === -1)) {
          context$1$0.next = 8;
          break;
        }

        _logger2['default'].debug('Cookie \'' + cookieName + '\' not found. Ignoring.');
        return context$1$0.abrupt('return', true);

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this._deleteCookie(cookieName));

      case 10:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.deleteCookies = function callee$0$0() {
  var cookies, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, cookie;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.getCookies());

      case 4:
        cookies = context$1$0.sent;

        if (!cookies.length) {
          context$1$0.next = 32;
          break;
        }

        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 9;
        _iterator2 = _getIterator(cookies);

      case 11:
        if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
          context$1$0.next = 18;
          break;
        }

        cookie = _step2.value;
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(this._deleteCookie(cookie.name));

      case 15:
        _iteratorNormalCompletion2 = true;
        context$1$0.next = 11;
        break;

      case 18:
        context$1$0.next = 24;
        break;

      case 20:
        context$1$0.prev = 20;
        context$1$0.t0 = context$1$0['catch'](9);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t0;

      case 24:
        context$1$0.prev = 24;
        context$1$0.prev = 25;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 27:
        context$1$0.prev = 27;

        if (!_didIteratorError2) {
          context$1$0.next = 30;
          break;
        }

        throw _iteratorError2;

      case 30:
        return context$1$0.finish(27);

      case 31:
        return context$1$0.finish(24);

      case 32:
        return context$1$0.abrupt('return', true);

      case 33:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[9, 20, 24, 32], [25,, 27, 31]]);
};

helpers._deleteCookie = function callee$0$0(cookieName) {
  var webCookie, script;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Deleting cookie \'' + cookieName + '\'');
        webCookie = _cookies2['default'].expireCookie(cookieName, { path: "/" });
        script = 'document.cookie = ' + JSON.stringify(webCookie);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, []]));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.findWebElementOrElements = function callee$0$0(strategy, selector, many, ctx) {
  var atomsElement, element, doFind;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        atomsElement = this.getAtomsElement(ctx);
        element = undefined;

        doFind = function doFind() {
          return _regeneratorRuntime.async(function doFind$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.executeAtom('find_element' + (many ? 's' : ''), [strategy, selector, atomsElement]));

              case 2:
                element = context$2$0.sent;
                return context$2$0.abrupt('return', !_lodash2['default'].isNull(element));

              case 4:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.prev = 3;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.implicitWaitForCondition(doFind));

      case 6:
        context$1$0.next = 15;
        break;

      case 8:
        context$1$0.prev = 8;
        context$1$0.t0 = context$1$0['catch'](3);

        if (!(context$1$0.t0.message && context$1$0.t0.message.match(/Condition unmet/))) {
          context$1$0.next = 14;
          break;
        }

        // condition was not met setting res to empty array
        element = [];
        context$1$0.next = 15;
        break;

      case 14:
        throw context$1$0.t0;

      case 15:
        if (!many) {
          context$1$0.next = 19;
          break;
        }

        return context$1$0.abrupt('return', element);

      case 19:
        if (!(!element || _lodash2['default'].size(element) === 0)) {
          context$1$0.next = 21;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchElementError();

      case 21:
        return context$1$0.abrupt('return', element);

      case 22:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 8]]);
};

extensions.webFlickElement = function callee$0$0(el, xoffset, yoffset) {
  var atomsElement, _ref, x, y, _ref2, width, height, from, to, args, command;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.useAtomsElement(el));

      case 2:
        atomsElement = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('get_top_left_coordinates', [atomsElement]));

      case 5:
        _ref = context$1$0.sent;
        x = _ref.x;
        y = _ref.y;
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.executeAtom('get_size', [atomsElement]));

      case 10:
        _ref2 = context$1$0.sent;
        width = _ref2.width;
        height = _ref2.height;

        // translate to proper coordinates
        x = x + width / 2;
        y = y + height / 2;

        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(this.translateWebCoords({ x: x, y: y }));

      case 17:
        from = context$1$0.sent;
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(this.translateWebCoords({ x: x + xoffset, y: y + yoffset }));

      case 20:
        to = context$1$0.sent;
        args = { from: from, to: to };
        command = 'au.flick(' + JSON.stringify(args) + ')';
        context$1$0.next = 25;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 25:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.mobileWebNav = function callee$0$0(navType) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        this.remote.allowNavigationWithoutReload();
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', ['history.' + navType + '();', null]));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.nativeWebTap = function callee$0$0(el) {
  var atomsElement, _ref3, x, y, _ref4, width, height;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('get_top_left_coordinates', [atomsElement]));

      case 3:
        _ref3 = context$1$0.sent;
        x = _ref3.x;
        y = _ref3.y;
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.executeAtom('get_size', [atomsElement]));

      case 8:
        _ref4 = context$1$0.sent;
        width = _ref4.width;
        height = _ref4.height;

        x = x + width / 2;
        y = y + height / 2;
        this.curWebCoords = { x: x, y: y };
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.clickWebCoords());

      case 16:
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(500));

      case 18:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.clickWebCoords = function callee$0$0() {
  var coords;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.translateWebCoords(this.curWebCoords));

      case 2:
        coords = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.clickCoords(coords));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.translateWebCoords = function callee$0$0(coords) {
  var wvCmd, webviewIndex, yOffset, webviews, wvId, locCmd, rect, wvPos, realDims, cmd, _ref5, w, h, wvDims, xRatio, yRatio, serviceBarHeight, newCoords;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Translating coordinates (' + JSON.stringify(coords) + ') to web coordinates');
        wvCmd = 'au.getElementsByType(\'webview\')';
        webviewIndex = this.webContextIndex();
        yOffset = this.opts.curOrientation === 'LANDSCAPE' ? this.landscapeWebCoordsOffset : 0;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(wvCmd));

      case 6:
        webviews = context$1$0.sent;

        if (!(webviews.length < 1)) {
          context$1$0.next = 9;
          break;
        }

        throw new _appiumBaseDriver.errors.UnknownError.code('Could not find any webviews to click inside!');

      case 9:
        if (_lodash2['default'].isUndefined(webviews[webviewIndex])) {
          _logger2['default'].warn('Could not find webview at index ' + webviewIndex + ', taking ' + 'last available one for clicking purposes');
          webviewIndex = webviews.length - 1;
        }

        wvId = webviews[webviewIndex].ELEMENT;
        locCmd = 'au.getElement(\'' + wvId + '\').rect()';
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(locCmd));

      case 14:
        rect = context$1$0.sent;
        wvPos = { x: rect.origin.x, y: rect.origin.y };
        realDims = { w: rect.size.width, h: rect.size.height };
        cmd = '(function () { return {w: document.width, h: document.height}; })()';
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(this.remote.execute(cmd));

      case 20:
        _ref5 = context$1$0.sent;
        w = _ref5.w;
        h = _ref5.h;
        wvDims = { w: w, h: h };

        if (!(wvDims && realDims && wvPos)) {
          context$1$0.next = 32;
          break;
        }

        xRatio = realDims.w / wvDims.w;
        yRatio = realDims.h / wvDims.h;
        serviceBarHeight = 20;

        if (parseFloat(this.opts.platformVersion) >= 8) {
          // ios8 includes the service bar height in the app
          serviceBarHeight = 0;
        }
        newCoords = {
          x: wvPos.x + Math.round(xRatio * coords.x),
          y: wvPos.y + yOffset + Math.round(yRatio * coords.y) - serviceBarHeight
        };

        _logger2['default'].debug('Converted web coords ' + JSON.stringify(coords) + ' ' + ('into real coords ' + JSON.stringify(newCoords)));
        return context$1$0.abrupt('return', newCoords);

      case 32:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.clickCoords = function callee$0$0(coords) {
  var opts, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.useRobot) {
          context$1$0.next = 4;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError();

      case 4:
        opts = coords;

        opts.tapCount = 1;
        opts.duration = 0.3;
        opts.touchCount = 1;
        command = 'au.complexTap(' + JSON.stringify(opts) + ')';
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.executeAtom = function callee$0$0(atom, args) {
  var alwaysDefaultFrame = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
  var frames, promise;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        frames = alwaysDefaultFrame === true ? [] : this.curWebFrames;
        promise = this.remote.executeAtom(atom, args, frames);
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.waitForAtom(promise));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.executeAtomAsync = function callee$0$0(atom, args, responseUrl) {
  var promise;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        promise = new _bluebird2['default'](function (resolve, reject) {
          _this2.asyncPromise = { resolve: resolve, reject: reject };
        });
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.remote.executeAtomAsync(atom, args, this.curWebFrames, responseUrl));

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.waitForAtom(promise));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.waitForAtom = function callee$0$0(promise) {
  var done, error, i, res;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        done = false;
        error = null;

        promise.then(function (res) {
          // eslint-disable-line promise/prefer-await-to-then
          done = true;
          return res;
        })['catch'](function (err) {
          // eslint-disable-line promise/prefer-await-to-callbacks
          _logger2['default'].debug('Error received while executing atom: ' + err.message);
          // error gets swallowed, so save and check later
          done = true;
          error = err;
        });
        // try ten times to check alert, if we are not done yet
        i = 0;

      case 4:
        if (!(i < 10)) {
          context$1$0.next = 18;
          break;
        }

        if (!done) {
          context$1$0.next = 7;
          break;
        }

        return context$1$0.abrupt('break', 18);

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(500));

      case 9:
        if (!done) {
          context$1$0.next = 11;
          break;
        }

        return context$1$0.abrupt('break', 18);

      case 11:
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.checkForAlert());

      case 13:
        if (!context$1$0.sent) {
          context$1$0.next = 15;
          break;
        }

        return context$1$0.abrupt('return', '');

      case 15:
        i++;
        context$1$0.next = 4;
        break;

      case 18:
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(promise);

      case 20:
        res = context$1$0.sent;

        if (!error) {
          context$1$0.next = 23;
          break;
        }

        throw error;

      case 23:
        return context$1$0.abrupt('return', this.parseExecuteResponse(res));

      case 24:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.checkForAlert = function callee$0$0() {
  var present;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (_lodash2['default'].isNull(this.uiAutoClient)) {
          context$1$0.next = 7;
          break;
        }

        _logger2['default'].debug('atom did not return yet, checking to see if ' + 'we are blocked by an alert');
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.alertIsPresent()'));

      case 4:
        present = context$1$0.sent;

        if (!present) {
          _logger2['default'].debug('No alert found.');
        } else {
          _logger2['default'].debug('Found an alert, returning control to client');
        }
        return context$1$0.abrupt('return', present);

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.getAtomsElement = function (wdId) {
  var atomsId = undefined;
  try {
    atomsId = this.webElementIds[parseInt(wdId, 10) - ELEMENT_OFFSET];
  } catch (e) {
    return null;
  }
  if (_lodash2['default'].isUndefined(atomsId)) {
    return null;
  }
  return { ELEMENT: atomsId };
};

helpers.useAtomsElement = function (el) {
  if (parseInt(el, 10) < ELEMENT_OFFSET) {
    _logger2['default'].debug('Element with id \'' + el + '\' passed in for use with ' + ('atoms, but it\'s out of our internal scope. Adding ' + ELEMENT_OFFSET + '.'));
    el = (parseInt(el, 10) + ELEMENT_OFFSET).toString();
  }
  var atomsElement = this.getAtomsElement(el);
  if (atomsElement === null) {
    throw new _appiumBaseDriver.errors.UnknownError('Error converting element ID for using in WD atoms: ' + el);
  }
  return atomsElement;
};

helpers.convertElementsForAtoms = function () {
  var args = arguments.length <= 0 || arguments[0] === undefined ? [] : arguments[0];

  var newArgs = [];
  var _iteratorNormalCompletion3 = true;
  var _didIteratorError3 = false;
  var _iteratorError3 = undefined;

  try {
    for (var _iterator3 = _getIterator(args), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
      var arg = _step3.value;

      if (!_lodash2['default'].isNull(arg) && !_lodash2['default'].isUndefined(arg.ELEMENT)) {
        var atomsElement = this.getAtomsElement(arg.ELEMENT);
        if (atomsElement === null) {
          throw new _appiumBaseDriver.errors.UnknownError('Error converting element ID for using in WD atoms: ' + arg.ELEMENT);
        }
        newArgs.push(atomsElement);
      } else {
        newArgs.push(arg);
      }
    }
  } catch (err) {
    _didIteratorError3 = true;
    _iteratorError3 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion3 && _iterator3['return']) {
        _iterator3['return']();
      }
    } finally {
      if (_didIteratorError3) {
        throw _iteratorError3;
      }
    }
  }

  return newArgs;
};

helpers.parseExecuteResponse = function (res) {
  if (_lodash2['default'].isNull(res) || _lodash2['default'].isUndefined(res)) return null;

  var wdElement = null;
  if (!_lodash2['default'].isArray(res)) {
    if (!_lodash2['default'].isUndefined(res.ELEMENT)) {
      wdElement = this.parseElementResponse(res);
      if (wdElement === null) {
        throw new _appiumBaseDriver.errors.UnknownError('Error converting element ID atom for using in WD: ' + res.ELEMENT);
      }
      res = wdElement;
    }
  } else {
    // value is an array, so go through and convert each
    var args = [];
    var _iteratorNormalCompletion4 = true;
    var _didIteratorError4 = false;
    var _iteratorError4 = undefined;

    try {
      for (var _iterator4 = _getIterator(res), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
        var arg = _step4.value;

        wdElement = arg;
        if (!_lodash2['default'].isNull(arg) && !_lodash2['default'].isUndefined(arg.ELEMENT)) {
          wdElement = this.parseElementResponse(arg);
          if (wdElement === null) {
            throw new _appiumBaseDriver.errors.UnknownError('Error converting element ID atom for using in WD: ' + arg.ELEMENT);
          }
          args.push(wdElement);
        } else {
          args.push(arg);
        }
      }
    } catch (err) {
      _didIteratorError4 = true;
      _iteratorError4 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion4 && _iterator4['return']) {
          _iterator4['return']();
        }
      } finally {
        if (_didIteratorError4) {
          throw _iteratorError4;
        }
      }
    }

    res = args;
  }
  return res;
};

helpers.parseElementResponse = function (element) {
  var objId = element.ELEMENT;
  var clientId = (ELEMENT_OFFSET + this.webElementIds.length).toString();
  this.webElementIds.push(objId);
  return { ELEMENT: clientId };
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// in the future, detect whether we have a UIWebView that we can use to
// make sense of this command. For now, and otherwise, it's a no-op

// check cookie existence

// make sure real tap actually has time to register

// add static offset for safari in landscape mode

// absolutize web coords

// var tapUrl = this.args.robotUrl + "/tap";
// request.post({url:tapUrl, form: {x:coords.x, y:coords.y}}, cb);
/*TODO*/
// save the resolve and reject methods of the promise to be waited for

// need to check for alert while the atom is being executed.
// so notify ourselves when it happens

// check if the promise has been resolved

// check if there is an alert

// we found an alert, and should just return control
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUcsQ0FBQztDQUNaLENBQUM7O0FBRUYsT0FBTyxDQUFDLG9CQUFvQixHQUFHLFVBQVUsT0FBTyxFQUFFO0FBQ2hELE1BQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUM7QUFDNUIsTUFBSSxRQUFRLEdBQUcsQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUEsQ0FBRSxRQUFRLEVBQUUsQ0FBQztBQUN2RSxNQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUMvQixTQUFPLEVBQUMsT0FBTyxFQUFFLFFBQVEsRUFBQyxDQUFDO0NBQzVCLENBQUM7O0FBR0YsZUFBYyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3BDLFFBQVEsR0FBUixRQUFRO1FBQUUsT0FBTyxHQUFQLE9BQU87cUJBQ1gsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvd2ViLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgY29va2llVXRpbHMgZnJvbSAnLi4vY29va2llcyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5cblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBFTEVNRU5UX09GRlNFVCA9IDUwMDA7XG5cbmNvbW1hbmRzLnNldEZyYW1lID0gYXN5bmMgZnVuY3Rpb24gKGZyYW1lKSB7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGZyYW1lID0gZnJhbWUgPyBmcmFtZSA6ICd0YXJnZXQuZnJvbnRNb3N0QXBwKCknO1xuICAgIGxldCBjb21tYW5kID0gYHdkX2ZyYW1lID0gJHtmcmFtZX1gO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgfVxuXG4gIGxldCBhdG9tO1xuICBpZiAoXy5pc051bGwoZnJhbWUpKSB7XG4gICAgdGhpcy5jdXJXZWJGcmFtZXMgPSBbXTtcbiAgICBsb2dnZXIuZGVidWcoJ0xlYXZpbmcgd2ViIGZyYW1lIGFuZCBnb2luZyBiYWNrIHRvIGRlZmF1bHQgY29udGVudCcpO1xuICAgIHJldHVybjtcbiAgfVxuICBpZiAoIV8uaXNVbmRlZmluZWQoZnJhbWUuRUxFTUVOVCkpIHtcbiAgICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZnJhbWUuRUxFTUVOVCk7XG4gICAgbGV0IHZhbHVlID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X2ZyYW1lX3dpbmRvdycsIFthdG9tc0VsZW1lbnRdKTtcbiAgICBsb2dnZXIuZGVidWcoYEVudGVyaW5nIG5ldyB3ZWIgZnJhbWU6ICcke3ZhbHVlLldJTkRPV30nYCk7XG4gICAgdGhpcy5jdXJXZWJGcmFtZXMudW5zaGlmdCh2YWx1ZS5XSU5ET1cpO1xuICB9IGVsc2Uge1xuICAgIGF0b20gPSBfLmlzTnVtYmVyKGZyYW1lKSA/ICdmcmFtZV9ieV9pbmRleCcgOiAnZnJhbWVfYnlfaWRfb3JfbmFtZSc7XG4gICAgbGV0IHZhbHVlID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbShhdG9tLCBbZnJhbWVdKTtcbiAgICBpZiAoXy5pc051bGwodmFsdWUpIHx8IF8uaXNVbmRlZmluZWQodmFsdWUuV0lORE9XKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hGcmFtZUVycm9yKCk7XG4gICAgfVxuICAgIGxvZ2dlci5kZWJ1ZyhgRW50ZXJpbmcgbmV3IHdlYiBmcmFtZTogJyR7dmFsdWUuV0lORE9XfSdgKTtcbiAgICB0aGlzLmN1cldlYkZyYW1lcy51bnNoaWZ0KHZhbHVlLldJTkRPVyk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldENzc1Byb3BlcnR5ID0gYXN5bmMgZnVuY3Rpb24gKHByb3BlcnR5TmFtZSwgZWwpIHtcbiAgbGV0IGF0b21zRWxlbWVudCA9IHRoaXMudXNlQXRvbXNFbGVtZW50KGVsKTtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF92YWx1ZV9vZl9jc3NfcHJvcGVydHknLCBbYXRvbXNFbGVtZW50LCBwcm9wZXJ0eU5hbWVdKTtcbn07XG5cbmNvbW1hbmRzLnN1Ym1pdCA9IGFzeW5jIGZ1bmN0aW9uIChlbCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBhdG9tc0VsZW1lbnQgPSB0aGlzLnVzZUF0b21zRWxlbWVudChlbCk7XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnc3VibWl0JywgW2F0b21zRWxlbWVudF0pO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG59O1xuXG5jb21tYW5kcy5yZWZyZXNoID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ3JlZnJlc2gnLCBbXSk7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnNldFVybCA9IGFzeW5jIGZ1bmN0aW9uICh1cmwpIHtcbiAgbG9nZ2VyLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHNldCB1cmwgJyR7dXJsfSdgKTtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgLy8gaW4gdGhlIGZ1dHVyZSwgZGV0ZWN0IHdoZXRoZXIgd2UgaGF2ZSBhIFVJV2ViVmlldyB0aGF0IHdlIGNhbiB1c2UgdG9cbiAgICAvLyBtYWtlIHNlbnNlIG9mIHRoaXMgY29tbWFuZC4gRm9yIG5vdywgYW5kIG90aGVyd2lzZSwgaXQncyBhIG5vLW9wXG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cbiAgdGhpcy5zZXRDdXJyZW50VXJsKHVybCk7XG4gIC8vIG1ha2Ugc3VyZSB0byBjbGVhciBvdXQgYW55IGxlZnRvdmVyIHdlYiBmcmFtZXNcbiAgdGhpcy5jdXJXZWJGcmFtZXMgPSBbXTtcbiAgYXdhaXQgdGhpcy5yZW1vdGUubmF2VG9VcmwodXJsKTtcbn07XG5cbmNvbW1hbmRzLmdldFVybCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cbiAgbGV0IHVybCA9IGF3YWl0IHRoaXMucmVtb3RlLmV4ZWN1dGUoJ3dpbmRvdy5sb2NhdGlvbi5ocmVmJyk7XG4gIHJldHVybiB1cmw7XG59O1xuXG5jb21tYW5kcy50aXRsZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ3RpdGxlJywgW10sIHRydWUpO1xufTtcblxuY29tbWFuZHMuZ2V0Q29va2llcyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBsb2dnZXIuZGVidWcoJ1JldHJpZXZpbmcgYWxsIGNvb2tpZXMnKTtcblxuICBsZXQgc2NyaXB0ID0gJ3JldHVybiBkb2N1bWVudC5jb29raWUnO1xuICBsZXQganNDb29raWVzID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZXhlY3V0ZV9zY3JpcHQnLCBbc2NyaXB0LCBbXV0pO1xuXG4gIGxldCBjb29raWVzID0gW107XG4gIHRyeSB7XG4gICAgZm9yIChsZXQgW25hbWUsIHZhbHVlXSBvZiBfLnRvUGFpcnMoY29va2llVXRpbHMuY3JlYXRlSldQQ29va2llKHVuZGVmaW5lZCwganNDb29raWVzKSkpIHtcbiAgICAgIGNvb2tpZXMucHVzaCh7bmFtZSwgdmFsdWV9KTtcbiAgICB9XG4gICAgcmV0dXJuIGNvb2tpZXM7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZ2dlci5lcnJvcihlcnIpO1xuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKGBFcnJvciBwYXJzaW5nIGNvb2tpZXMgZnJvbSByZXN1bHQ6ICcke2pzQ29va2llc30nYCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnNldENvb2tpZSA9IGFzeW5jIGZ1bmN0aW9uIChjb29raWUpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBjb29raWUgPSBfLmNsb25lKGNvb2tpZSk7XG5cbiAgLy8gaWYgYHBhdGhgIGZpZWxkIGlzIG5vdCBzcGVjaWZpZWQsIFNhZmFyaSB3aWxsIG5vdCB1cGRhdGUgY29va2llcyBhcyBleHBlY3RlZDsgZWcgaXNzdWUgIzE3MDhcbiAgaWYgKCFjb29raWUucGF0aCkge1xuICAgIGNvb2tpZS5wYXRoID0gXCIvXCI7XG4gIH1cblxuICBsZXQganNDb29raWUgPSBjb29raWVVdGlscy5jcmVhdGVKU0Nvb2tpZShjb29raWUubmFtZSwgY29va2llLnZhbHVlLCB7XG4gICAgZXhwaXJlczogXy5pc051bWJlcihjb29raWUuZXhwaXJ5KSA/IChuZXcgRGF0ZShjb29raWUuZXhwaXJ5ICogMTAwMCkpLnRvVVRDU3RyaW5nKCkgOlxuICAgICAgY29va2llLmV4cGlyeSxcbiAgICBwYXRoOiBjb29raWUucGF0aCxcbiAgICBkb21haW46IGNvb2tpZS5kb21haW4sXG4gICAgaHR0cE9ubHk6IGNvb2tpZS5odHRwT25seSxcbiAgICBzZWN1cmU6IGNvb2tpZS5zZWN1cmVcbiAgfSk7XG4gIGxldCBzY3JpcHQgPSBgZG9jdW1lbnQuY29va2llID0gJHtKU09OLnN0cmluZ2lmeShqc0Nvb2tpZSl9YDtcbiAgYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZXhlY3V0ZV9zY3JpcHQnLCBbc2NyaXB0LCBbXV0pO1xufTtcblxuY29tbWFuZHMuZGVsZXRlQ29va2llID0gYXN5bmMgZnVuY3Rpb24gKGNvb2tpZU5hbWUpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICAvLyBjaGVjayBjb29raWUgZXhpc3RlbmNlXG4gIGxldCBjb29raWVzID0gYXdhaXQgdGhpcy5nZXRDb29raWVzKCk7XG4gIGlmIChfLmluZGV4T2YoXy5tYXAoY29va2llcywgJ25hbWUnKSwgY29va2llTmFtZSkgPT09IC0xKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBDb29raWUgJyR7Y29va2llTmFtZX0nIG5vdCBmb3VuZC4gSWdub3JpbmcuYCk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgdGhpcy5fZGVsZXRlQ29va2llKGNvb2tpZU5hbWUpO1xufTtcblxuY29tbWFuZHMuZGVsZXRlQ29va2llcyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBsZXQgY29va2llcyA9IGF3YWl0IHRoaXMuZ2V0Q29va2llcygpO1xuICBpZiAoY29va2llcy5sZW5ndGgpIHtcbiAgICBmb3IgKGxldCBjb29raWUgb2YgY29va2llcykge1xuICAgICAgYXdhaXQgdGhpcy5fZGVsZXRlQ29va2llKGNvb2tpZS5uYW1lKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHRydWU7XG59O1xuXG5oZWxwZXJzLl9kZWxldGVDb29raWUgPSBhc3luYyBmdW5jdGlvbiAoY29va2llTmFtZSkge1xuICBsb2dnZXIuZGVidWcoYERlbGV0aW5nIGNvb2tpZSAnJHtjb29raWVOYW1lfSdgKTtcbiAgbGV0IHdlYkNvb2tpZSA9IGNvb2tpZVV0aWxzLmV4cGlyZUNvb2tpZShjb29raWVOYW1lLCB7cGF0aDogXCIvXCJ9KTtcbiAgbGV0IHNjcmlwdCA9IGBkb2N1bWVudC5jb29raWUgPSAke0pTT04uc3RyaW5naWZ5KHdlYkNvb2tpZSl9YDtcbiAgYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZXhlY3V0ZV9zY3JpcHQnLCBbc2NyaXB0LCBbXV0pO1xufTtcblxuZXh0ZW5zaW9ucy5maW5kV2ViRWxlbWVudE9yRWxlbWVudHMgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtYW55LCBjdHgpIHtcbiAgbGV0IGF0b21zRWxlbWVudCA9IHRoaXMuZ2V0QXRvbXNFbGVtZW50KGN0eCk7XG4gIGxldCBlbGVtZW50O1xuICBsZXQgZG9GaW5kID0gYXN5bmMgKCkgPT4ge1xuICAgIGVsZW1lbnQgPSBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKGBmaW5kX2VsZW1lbnQke21hbnkgPyAncycgOiAnJ31gLCBbc3RyYXRlZ3ksIHNlbGVjdG9yLCBhdG9tc0VsZW1lbnRdKTtcbiAgICByZXR1cm4gIV8uaXNOdWxsKGVsZW1lbnQpO1xuICB9O1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uKGRvRmluZCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIubWVzc2FnZSAmJiBlcnIubWVzc2FnZS5tYXRjaCgvQ29uZGl0aW9uIHVubWV0LykpIHtcbiAgICAgIC8vIGNvbmRpdGlvbiB3YXMgbm90IG1ldCBzZXR0aW5nIHJlcyB0byBlbXB0eSBhcnJheVxuICAgICAgZWxlbWVudCA9IFtdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG5cbiAgaWYgKG1hbnkpIHtcbiAgICByZXR1cm4gZWxlbWVudDtcbiAgfSBlbHNlIHtcbiAgICBpZiAoIWVsZW1lbnQgfHwgXy5zaXplKGVsZW1lbnQpID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICAgIH1cbiAgICByZXR1cm4gZWxlbWVudDtcbiAgfVxufTtcblxuZXh0ZW5zaW9ucy53ZWJGbGlja0VsZW1lbnQgPSBhc3luYyBmdW5jdGlvbiAoZWwsIHhvZmZzZXQsIHlvZmZzZXQpIHtcbiAgbGV0IGF0b21zRWxlbWVudCA9IGF3YWl0IHRoaXMudXNlQXRvbXNFbGVtZW50KGVsKTtcblxuICBsZXQge3gsIHl9ID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3RvcF9sZWZ0X2Nvb3JkaW5hdGVzJywgW2F0b21zRWxlbWVudF0pO1xuICBsZXQge3dpZHRoLCBoZWlnaHR9ID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3NpemUnLCBbYXRvbXNFbGVtZW50XSk7XG5cbiAgLy8gdHJhbnNsYXRlIHRvIHByb3BlciBjb29yZGluYXRlc1xuICB4ID0geCArICh3aWR0aCAvIDIpO1xuICB5ID0geSArIChoZWlnaHQgLyAyKTtcblxuICBsZXQgZnJvbSA9IGF3YWl0IHRoaXMudHJhbnNsYXRlV2ViQ29vcmRzKHt4LCB5fSk7XG4gIGxldCB0byA9IGF3YWl0IHRoaXMudHJhbnNsYXRlV2ViQ29vcmRzKHt4OiB4ICsgeG9mZnNldCwgeTogeSArIHlvZmZzZXR9KTtcblxuICBsZXQgYXJncyA9IHtmcm9tLCB0b307XG4gIGxldCBjb21tYW5kID0gYGF1LmZsaWNrKCR7SlNPTi5zdHJpbmdpZnkoYXJncyl9KWA7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xufTtcblxuZXh0ZW5zaW9ucy5tb2JpbGVXZWJOYXYgPSBhc3luYyBmdW5jdGlvbiAobmF2VHlwZSkge1xuICB0aGlzLnJlbW90ZS5hbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkKCk7XG4gIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2V4ZWN1dGVfc2NyaXB0JywgW2BoaXN0b3J5LiR7bmF2VHlwZX0oKTtgLCBudWxsXSk7XG59O1xuXG5leHRlbnNpb25zLm5hdGl2ZVdlYlRhcCA9IGFzeW5jIGZ1bmN0aW9uIChlbCkge1xuICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICBsZXQge3gsIHl9ID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3RvcF9sZWZ0X2Nvb3JkaW5hdGVzJywgW2F0b21zRWxlbWVudF0pO1xuICBsZXQge3dpZHRoLCBoZWlnaHR9ID0gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3NpemUnLCBbYXRvbXNFbGVtZW50XSk7XG4gIHggPSB4ICsgKHdpZHRoIC8gMik7XG4gIHkgPSB5ICsgKGhlaWdodCAvIDIpO1xuICB0aGlzLmN1cldlYkNvb3JkcyA9IHt4LCB5fTtcbiAgYXdhaXQgdGhpcy5jbGlja1dlYkNvb3JkcygpO1xuICAvLyBtYWtlIHN1cmUgcmVhbCB0YXAgYWN0dWFsbHkgaGFzIHRpbWUgdG8gcmVnaXN0ZXJcbiAgYXdhaXQgQi5kZWxheSg1MDApO1xufTtcblxuZXh0ZW5zaW9ucy5jbGlja1dlYkNvb3JkcyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IGNvb3JkcyA9IGF3YWl0IHRoaXMudHJhbnNsYXRlV2ViQ29vcmRzKHRoaXMuY3VyV2ViQ29vcmRzKTtcbiAgYXdhaXQgdGhpcy5jbGlja0Nvb3Jkcyhjb29yZHMpO1xufTtcblxuZXh0ZW5zaW9ucy50cmFuc2xhdGVXZWJDb29yZHMgPSBhc3luYyBmdW5jdGlvbiAoY29vcmRzKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgVHJhbnNsYXRpbmcgY29vcmRpbmF0ZXMgKCR7SlNPTi5zdHJpbmdpZnkoY29vcmRzKX0pIHRvIHdlYiBjb29yZGluYXRlc2ApO1xuICBsZXQgd3ZDbWQgPSAnYXUuZ2V0RWxlbWVudHNCeVR5cGUoXFwnd2Vidmlld1xcJyknO1xuICBsZXQgd2Vidmlld0luZGV4ID0gdGhpcy53ZWJDb250ZXh0SW5kZXgoKTtcblxuICAvLyBhZGQgc3RhdGljIG9mZnNldCBmb3Igc2FmYXJpIGluIGxhbmRzY2FwZSBtb2RlXG4gIGxldCB5T2Zmc2V0ID0gdGhpcy5vcHRzLmN1ck9yaWVudGF0aW9uID09PSAnTEFORFNDQVBFJyA/IHRoaXMubGFuZHNjYXBlV2ViQ29vcmRzT2Zmc2V0IDogMDtcblxuICAvLyBhYnNvbHV0aXplIHdlYiBjb29yZHNcbiAgbGV0IHdlYnZpZXdzID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQod3ZDbWQpO1xuICBpZiAod2Vidmlld3MubGVuZ3RoIDwgMSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yLmNvZGUoJ0NvdWxkIG5vdCBmaW5kIGFueSB3ZWJ2aWV3cyB0byBjbGljayBpbnNpZGUhJyk7XG4gIH1cbiAgaWYgKF8uaXNVbmRlZmluZWQod2Vidmlld3Nbd2Vidmlld0luZGV4XSkpIHtcbiAgICBsb2dnZXIud2FybihgQ291bGQgbm90IGZpbmQgd2VidmlldyBhdCBpbmRleCAke3dlYnZpZXdJbmRleH0sIHRha2luZyBgICtcbiAgICAgICAgICAgICAgICBgbGFzdCBhdmFpbGFibGUgb25lIGZvciBjbGlja2luZyBwdXJwb3Nlc2ApO1xuICAgIHdlYnZpZXdJbmRleCA9IHdlYnZpZXdzLmxlbmd0aCAtIDE7XG4gIH1cblxuICBsZXQgd3ZJZCA9IHdlYnZpZXdzW3dlYnZpZXdJbmRleF0uRUxFTUVOVDtcbiAgbGV0IGxvY0NtZCA9IGBhdS5nZXRFbGVtZW50KCcke3d2SWR9JykucmVjdCgpYDtcbiAgbGV0IHJlY3QgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChsb2NDbWQpO1xuICBsZXQgd3ZQb3MgPSB7eDogcmVjdC5vcmlnaW4ueCwgeTogcmVjdC5vcmlnaW4ueX07XG4gIGxldCByZWFsRGltcyA9IHt3OiByZWN0LnNpemUud2lkdGgsIGg6IHJlY3Quc2l6ZS5oZWlnaHR9O1xuXG4gIGxldCBjbWQgPSAnKGZ1bmN0aW9uICgpIHsgcmV0dXJuIHt3OiBkb2N1bWVudC53aWR0aCwgaDogZG9jdW1lbnQuaGVpZ2h0fTsgfSkoKSc7XG4gIGxldCB7dywgaH0gPSBhd2FpdCB0aGlzLnJlbW90ZS5leGVjdXRlKGNtZCk7XG4gIGxldCB3dkRpbXMgPSB7dywgaH07XG5cbiAgaWYgKHd2RGltcyAmJiByZWFsRGltcyAmJiB3dlBvcykge1xuICAgIGxldCB4UmF0aW8gPSByZWFsRGltcy53IC8gd3ZEaW1zLnc7XG4gICAgbGV0IHlSYXRpbyA9IHJlYWxEaW1zLmggLyB3dkRpbXMuaDtcbiAgICBsZXQgc2VydmljZUJhckhlaWdodCA9IDIwO1xuICAgIGlmIChwYXJzZUZsb2F0KHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24pID49IDgpIHtcbiAgICAgIC8vIGlvczggaW5jbHVkZXMgdGhlIHNlcnZpY2UgYmFyIGhlaWdodCBpbiB0aGUgYXBwXG4gICAgICBzZXJ2aWNlQmFySGVpZ2h0ID0gMDtcbiAgICB9XG4gICAgbGV0IG5ld0Nvb3JkcyA9IHtcbiAgICAgIHg6IHd2UG9zLnggKyBNYXRoLnJvdW5kKHhSYXRpbyAqIGNvb3Jkcy54KVxuICAgICwgeTogd3ZQb3MueSArIHlPZmZzZXQgKyBNYXRoLnJvdW5kKHlSYXRpbyAqIGNvb3Jkcy55KSAtIHNlcnZpY2VCYXJIZWlnaHRcbiAgICB9O1xuICAgIGxvZ2dlci5kZWJ1ZyhgQ29udmVydGVkIHdlYiBjb29yZHMgJHtKU09OLnN0cmluZ2lmeShjb29yZHMpfSBgICtcbiAgICAgICAgICAgICAgICBgaW50byByZWFsIGNvb3JkcyAke0pTT04uc3RyaW5naWZ5KG5ld0Nvb3Jkcyl9YCk7XG4gICAgcmV0dXJuIG5ld0Nvb3JkcztcbiAgfVxufTtcblxuaGVscGVycy5jbGlja0Nvb3JkcyA9IGFzeW5jIGZ1bmN0aW9uIChjb29yZHMpIHtcbiAgaWYgKHRoaXMudXNlUm9ib3QpIHtcbiAgICAvLyB2YXIgdGFwVXJsID0gdGhpcy5hcmdzLnJvYm90VXJsICsgXCIvdGFwXCI7XG4gICAgLy8gcmVxdWVzdC5wb3N0KHt1cmw6dGFwVXJsLCBmb3JtOiB7eDpjb29yZHMueCwgeTpjb29yZHMueX19LCBjYik7XG4gICAgLypUT0RPKi90aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfSBlbHNlIHtcbiAgICBsZXQgb3B0cyA9IGNvb3JkcztcbiAgICBvcHRzLnRhcENvdW50ID0gMTtcbiAgICBvcHRzLmR1cmF0aW9uID0gMC4zO1xuICAgIG9wdHMudG91Y2hDb3VudCA9IDE7XG4gICAgbGV0IGNvbW1hbmQgPSBgYXUuY29tcGxleFRhcCgke0pTT04uc3RyaW5naWZ5KG9wdHMpfSlgO1xuICAgIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNvbW1hbmQpO1xuICB9XG59O1xuXG5oZWxwZXJzLmV4ZWN1dGVBdG9tID0gYXN5bmMgZnVuY3Rpb24gKGF0b20sIGFyZ3MsIGFsd2F5c0RlZmF1bHRGcmFtZSA9IGZhbHNlKSB7XG4gIGxldCBmcmFtZXMgPSBhbHdheXNEZWZhdWx0RnJhbWUgPT09IHRydWUgPyBbXSA6IHRoaXMuY3VyV2ViRnJhbWVzO1xuICBsZXQgcHJvbWlzZSA9IHRoaXMucmVtb3RlLmV4ZWN1dGVBdG9tKGF0b20sIGFyZ3MsIGZyYW1lcyk7XG4gIHJldHVybiBhd2FpdCB0aGlzLndhaXRGb3JBdG9tKHByb21pc2UpO1xufTtcblxuaGVscGVycy5leGVjdXRlQXRvbUFzeW5jID0gYXN5bmMgZnVuY3Rpb24gKGF0b20sIGFyZ3MsIHJlc3BvbnNlVXJsKSB7XG4gIC8vIHNhdmUgdGhlIHJlc29sdmUgYW5kIHJlamVjdCBtZXRob2RzIG9mIHRoZSBwcm9taXNlIHRvIGJlIHdhaXRlZCBmb3JcbiAgbGV0IHByb21pc2UgPSBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgdGhpcy5hc3luY1Byb21pc2UgPSB7cmVzb2x2ZSwgcmVqZWN0fTtcbiAgfSk7XG4gIGF3YWl0IHRoaXMucmVtb3RlLmV4ZWN1dGVBdG9tQXN5bmMoYXRvbSwgYXJncywgdGhpcy5jdXJXZWJGcmFtZXMsIHJlc3BvbnNlVXJsKTtcbiAgcmV0dXJuIGF3YWl0IHRoaXMud2FpdEZvckF0b20ocHJvbWlzZSk7XG59O1xuXG5oZWxwZXJzLndhaXRGb3JBdG9tID0gYXN5bmMgZnVuY3Rpb24gKHByb21pc2UpIHtcbiAgLy8gbmVlZCB0byBjaGVjayBmb3IgYWxlcnQgd2hpbGUgdGhlIGF0b20gaXMgYmVpbmcgZXhlY3V0ZWQuXG4gIC8vIHNvIG5vdGlmeSBvdXJzZWx2ZXMgd2hlbiBpdCBoYXBwZW5zXG4gIGxldCBkb25lID0gZmFsc2U7XG4gIGxldCBlcnJvciA9IG51bGw7XG4gIHByb21pc2UudGhlbigocmVzKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tdGhlblxuICAgIGRvbmUgPSB0cnVlO1xuICAgIHJldHVybiByZXM7XG4gIH0pXG4gIC5jYXRjaCgoZXJyKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gICAgbG9nZ2VyLmRlYnVnKGBFcnJvciByZWNlaXZlZCB3aGlsZSBleGVjdXRpbmcgYXRvbTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAvLyBlcnJvciBnZXRzIHN3YWxsb3dlZCwgc28gc2F2ZSBhbmQgY2hlY2sgbGF0ZXJcbiAgICBkb25lID0gdHJ1ZTtcbiAgICBlcnJvciA9IGVycjtcbiAgfSk7XG4gIC8vIHRyeSB0ZW4gdGltZXMgdG8gY2hlY2sgYWxlcnQsIGlmIHdlIGFyZSBub3QgZG9uZSB5ZXRcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDsgaSsrKSB7XG4gICAgLy8gY2hlY2sgaWYgdGhlIHByb21pc2UgaGFzIGJlZW4gcmVzb2x2ZWRcbiAgICBpZiAoZG9uZSkgYnJlYWs7XG4gICAgYXdhaXQgQi5kZWxheSg1MDApO1xuICAgIGlmIChkb25lKSBicmVhaztcbiAgICAvLyBjaGVjayBpZiB0aGVyZSBpcyBhbiBhbGVydFxuICAgIGlmIChhd2FpdCB0aGlzLmNoZWNrRm9yQWxlcnQoKSkge1xuICAgICAgLy8gd2UgZm91bmQgYW4gYWxlcnQsIGFuZCBzaG91bGQganVzdCByZXR1cm4gY29udHJvbFxuICAgICAgcmV0dXJuICcnO1xuICAgIH1cbiAgfVxuXG4gIGxldCByZXMgPSBhd2FpdCBwcm9taXNlO1xuICBpZiAoZXJyb3IpIHtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxuICByZXR1cm4gdGhpcy5wYXJzZUV4ZWN1dGVSZXNwb25zZShyZXMpO1xufTtcblxuaGVscGVycy5jaGVja0ZvckFsZXJ0ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAoIV8uaXNOdWxsKHRoaXMudWlBdXRvQ2xpZW50KSkge1xuICAgIGxvZ2dlci5kZWJ1ZygnYXRvbSBkaWQgbm90IHJldHVybiB5ZXQsIGNoZWNraW5nIHRvIHNlZSBpZiAnICtcbiAgICAgICAgICAgICAgICAgJ3dlIGFyZSBibG9ja2VkIGJ5IGFuIGFsZXJ0Jyk7XG4gICAgbGV0IHByZXNlbnQgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZCgnYXUuYWxlcnRJc1ByZXNlbnQoKScpO1xuICAgIGlmICghcHJlc2VudCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdObyBhbGVydCBmb3VuZC4nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdGb3VuZCBhbiBhbGVydCwgcmV0dXJuaW5nIGNvbnRyb2wgdG8gY2xpZW50Jyk7XG4gICAgfVxuICAgIHJldHVybiBwcmVzZW50O1xuICB9XG59O1xuXG5oZWxwZXJzLmdldEF0b21zRWxlbWVudCA9IGZ1bmN0aW9uICh3ZElkKSB7XG4gIGxldCBhdG9tc0lkO1xuICB0cnkge1xuICAgIGF0b21zSWQgPSB0aGlzLndlYkVsZW1lbnRJZHNbcGFyc2VJbnQod2RJZCwgMTApIC0gRUxFTUVOVF9PRkZTRVRdO1xuICB9IGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgaWYgKF8uaXNVbmRlZmluZWQoYXRvbXNJZCkpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICByZXR1cm4ge0VMRU1FTlQ6IGF0b21zSWR9O1xufTtcblxuaGVscGVycy51c2VBdG9tc0VsZW1lbnQgPSBmdW5jdGlvbiAoZWwpIHtcbiAgaWYgKHBhcnNlSW50KGVsLCAxMCkgPCBFTEVNRU5UX09GRlNFVCkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgRWxlbWVudCB3aXRoIGlkICcke2VsfScgcGFzc2VkIGluIGZvciB1c2Ugd2l0aCBgICtcbiAgICAgICAgICAgICAgICAgYGF0b21zLCBidXQgaXQncyBvdXQgb2Ygb3VyIGludGVybmFsIHNjb3BlLiBBZGRpbmcgJHtFTEVNRU5UX09GRlNFVH0uYCk7XG4gICAgZWwgPSAocGFyc2VJbnQoZWwsIDEwKSArIEVMRU1FTlRfT0ZGU0VUKS50b1N0cmluZygpO1xuICB9XG4gIGxldCBhdG9tc0VsZW1lbnQgPSB0aGlzLmdldEF0b21zRWxlbWVudChlbCk7XG4gIGlmIChhdG9tc0VsZW1lbnQgPT09IG51bGwpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRXJyb3IgY29udmVydGluZyBlbGVtZW50IElEIGZvciB1c2luZyBpbiBXRCBhdG9tczogJHtlbH1gKTtcbiAgfVxuICByZXR1cm4gYXRvbXNFbGVtZW50O1xufTtcblxuaGVscGVycy5jb252ZXJ0RWxlbWVudHNGb3JBdG9tcyA9IGZ1bmN0aW9uIChhcmdzID0gW10pIHtcbiAgbGV0IG5ld0FyZ3MgPSBbXTtcbiAgZm9yIChsZXQgYXJnIG9mIGFyZ3MpIHtcbiAgICBpZiAoIV8uaXNOdWxsKGFyZykgJiYgIV8uaXNVbmRlZmluZWQoYXJnLkVMRU1FTlQpKSB7XG4gICAgICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy5nZXRBdG9tc0VsZW1lbnQoYXJnLkVMRU1FTlQpO1xuICAgICAgaWYgKGF0b21zRWxlbWVudCA9PT0gbnVsbCkge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRXJyb3IgY29udmVydGluZyBlbGVtZW50IElEIGZvciB1c2luZyBpbiBXRCBhdG9tczogJHthcmcuRUxFTUVOVH1gKTtcbiAgICAgIH1cbiAgICAgIG5ld0FyZ3MucHVzaChhdG9tc0VsZW1lbnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBuZXdBcmdzLnB1c2goYXJnKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG5ld0FyZ3M7XG59O1xuXG5oZWxwZXJzLnBhcnNlRXhlY3V0ZVJlc3BvbnNlID0gZnVuY3Rpb24gKHJlcykge1xuICBpZiAoXy5pc051bGwocmVzKSB8fCBfLmlzVW5kZWZpbmVkKHJlcykpIHJldHVybiBudWxsO1xuXG4gIGxldCB3ZEVsZW1lbnQgPSBudWxsO1xuICBpZiAoIV8uaXNBcnJheShyZXMpKSB7XG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHJlcy5FTEVNRU5UKSkge1xuICAgICAgd2RFbGVtZW50ID0gdGhpcy5wYXJzZUVsZW1lbnRSZXNwb25zZShyZXMpO1xuICAgICAgaWYgKHdkRWxlbWVudCA9PT0gbnVsbCkge1xuICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRXJyb3IgY29udmVydGluZyBlbGVtZW50IElEIGF0b20gZm9yIHVzaW5nIGluIFdEOiAke3Jlcy5FTEVNRU5UfWApO1xuICAgICAgfVxuICAgICAgcmVzID0gd2RFbGVtZW50O1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICAvLyB2YWx1ZSBpcyBhbiBhcnJheSwgc28gZ28gdGhyb3VnaCBhbmQgY29udmVydCBlYWNoXG4gICAgbGV0IGFyZ3MgPSBbXTtcbiAgICBmb3IgKGxldCBhcmcgb2YgcmVzKSB7XG4gICAgICB3ZEVsZW1lbnQgPSBhcmc7XG4gICAgICBpZiAoIV8uaXNOdWxsKGFyZykgJiYgIV8uaXNVbmRlZmluZWQoYXJnLkVMRU1FTlQpKSB7XG4gICAgICAgIHdkRWxlbWVudCA9IHRoaXMucGFyc2VFbGVtZW50UmVzcG9uc2UoYXJnKTtcbiAgICAgICAgaWYgKHdkRWxlbWVudCA9PT0gbnVsbCkge1xuICAgICAgICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKGBFcnJvciBjb252ZXJ0aW5nIGVsZW1lbnQgSUQgYXRvbSBmb3IgdXNpbmcgaW4gV0Q6ICR7YXJnLkVMRU1FTlR9YCk7XG4gICAgICAgIH1cbiAgICAgICAgYXJncy5wdXNoKHdkRWxlbWVudCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhcmdzLnB1c2goYXJnKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmVzID0gYXJncztcbiAgfVxuICByZXR1cm4gcmVzO1xufTtcblxuaGVscGVycy5wYXJzZUVsZW1lbnRSZXNwb25zZSA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gIGxldCBvYmpJZCA9IGVsZW1lbnQuRUxFTUVOVDtcbiAgbGV0IGNsaWVudElkID0gKEVMRU1FTlRfT0ZGU0VUICsgdGhpcy53ZWJFbGVtZW50SWRzLmxlbmd0aCkudG9TdHJpbmcoKTtcbiAgdGhpcy53ZWJFbGVtZW50SWRzLnB1c2gob2JqSWQpO1xuICByZXR1cm4ge0VMRU1FTlQ6IGNsaWVudElkfTtcbn07XG5cblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _teen_process = require('teen_process');

var _admZip = require('adm-zip');

var _admZip2 = _interopRequireDefault(_admZip);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var commands = {},
    helpers = {},
    extensions = {};

// TODO: more explicit error message for all the file-movement commands

/*
 *  Get the full path to an iOS simulator file.
 *  Calls cb(err, fullFilePath)
 *  /Some/Path                           fetches a file relative to the root of the device's filesystem.
 *  /Applications/AppName.app/Some/Path  fetches a file relative to the root of that Application's .app directory, adding in the GUID.
 *  So it looks something like: /Applications/GUID-GUID-GUID-GUID/Some/Path
 */
helpers.getSimFileFullPath = function callee$0$0(remotePath) {
  var basePath, appName, appNameRegex, appNameMatches, findPath, _ref, stdout, appRoot, subPath;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        basePath = this.sim.getDir();
        appName = null;

        if (this.opts.app) {
          appNameRegex = new RegExp('\\' + _path2['default'].sep + '([\\w-]+\\.app)');
          appNameMatches = appNameRegex.exec(this.opts.app);

          if (appNameMatches) {
            appName = appNameMatches[1];
          }
        }
        // de-absolutize the path
        if (_appiumSupport.system.isWindows()) {
          if (remotePath.indexof("://") === 1) {
            remotePath = remotePath.slice(4);
          }
        } else {
          if (remotePath.indexOf("/") === 0) {
            remotePath = remotePath.slice(1);
          }
        }

        if (!(remotePath.indexOf(appName) === 0)) {
          context$1$0.next = 18;
          break;
        }

        _logger2['default'].debug("We want an app-relative file");

        findPath = basePath;

        if (this.opts.platformVersion >= 8) {
          // the .app file appears in /Containers/Data and /Containers/Bundle both. We only want /Bundle
          findPath = _path2['default'].resolve(basePath, "Containers", "Bundle");
        }
        findPath = findPath.replace(/\s/g, '\\ ');

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('find', [findPath, '-name', appName]));

      case 11:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        appRoot = stdout.replace(/\n$/, '');
        subPath = remotePath.substring(appName.length + 1);
        return context$1$0.abrupt('return', _path2['default'].resolve(appRoot, subPath));

      case 18:
        _logger2['default'].debug("We want a sim-relative file");
        return context$1$0.abrupt('return', _path2['default'].resolve(basePath, remotePath));

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pushFile = function callee$0$0(remotePath, base64Data) {
  var fullPath, content;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Pushing ' + remotePath + ' to iOS simulator');

        if (!this.isRealDevice()) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].debug("Unsupported: cannot write files to physical device");
        throw new _appiumBaseDriver.errors.NotYetImplementedError();

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.getSimFileFullPath(remotePath));

      case 6:
        fullPath = context$1$0.sent;

        _logger2['default'].debug('Attempting to write ' + fullPath + '...');
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(fullPath));

      case 10:
        if (!context$1$0.sent) {
          context$1$0.next = 14;
          break;
        }

        _logger2['default'].debug(fullPath + ' already exists, deleting...');
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(fullPath));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(_path2['default'].dirname(fullPath)));

      case 16:
        content = new Buffer(base64Data, 'base64');
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(fullPath, content));

      case 19:
        _logger2['default'].debug('Wrote ' + content.length + ' bytes to ' + fullPath);

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pullFile = function callee$0$0(remotePath) {
  var fullPath, data;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Pulling ' + remotePath + ' from sim');

        if (!this.isRealDevice()) {
          context$1$0.next = 3;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError();

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getSimFileFullPath(remotePath));

      case 5:
        fullPath = context$1$0.sent;

        _logger2['default'].debug('Attempting to read ' + fullPath);
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(fullPath, { encoding: 'base64' }));

      case 9:
        data = context$1$0.sent;
        return context$1$0.abrupt('return', data);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pullFolder = function callee$0$0(remotePath) {
  var fullPath, zip, buffer, data;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Pulling ' + remotePath + ' from sim');

        if (!this.isRealDevice()) {
          context$1$0.next = 3;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError();

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getSimFileFullPath(remotePath));

      case 5:
        fullPath = context$1$0.sent;

        _logger2['default'].debug('Adding ' + fullPath + ' to an in-memory zip archive');
        zip = new _admZip2['default']();

        zip.addLocalFolder(fullPath);
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
          zip.toBuffer(resolve, reject);
        }));

      case 11:
        buffer = context$1$0.sent;

        _logger2['default'].debug("Converting in-memory zip file to base64 encoded string");
        data = buffer.toString('base64');

        _logger2['default'].debug("Returning in-memory zip file as base54 encoded string");
        return context$1$0.abrupt('return', data);

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBdUIsb0JBQW9COzs2QkFDUixnQkFBZ0I7O3NCQUNoQyxXQUFXOzs7O29CQUNiLE1BQU07Ozs7NEJBQ0YsY0FBYzs7c0JBQ2hCLFNBQVM7Ozs7d0JBQ2QsVUFBVTs7OztBQUV4QixJQUFJLFFBQVEsR0FBRyxFQUFFO0lBQUUsT0FBTyxHQUFHLEVBQUU7SUFBRSxVQUFVLEdBQUcsRUFBRSxDQUFDOzs7Ozs7Ozs7OztBQVdqRCxPQUFPLENBQUMsa0JBQWtCLEdBQUcsb0JBQWdCLFVBQVU7TUFDakQsUUFBUSxFQUNSLE9BQU8sRUFHTCxZQUFZLEVBQ1osY0FBYyxFQW1CZCxRQUFRLFFBT04sTUFBTSxFQUNSLE9BQU8sRUFDUCxPQUFPOzs7OztBQWpDVCxnQkFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFO0FBQzVCLGVBQU8sR0FBRyxJQUFJOztBQUVsQixZQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO0FBQ2Isc0JBQVksR0FBRyxJQUFJLE1BQU0sUUFBTSxrQkFBSyxHQUFHLHFCQUFrQjtBQUN6RCx3QkFBYyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7O0FBQ3JELGNBQUksY0FBYyxFQUFFO0FBQ2xCLG1CQUFPLEdBQUcsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO1dBQzdCO1NBQ0Y7O0FBRUQsWUFBSSxzQkFBTyxTQUFTLEVBQUUsRUFBRTtBQUN0QixjQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFO0FBQ25DLHNCQUFVLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztXQUNsQztTQUNGLE1BQU07QUFDTCxjQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUss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LElBQUk7Ozs7QUFoQlIsNEJBQU8sS0FBSyxjQUFZLFVBQVUsZUFBWSxDQUFDOzthQUUzQyxJQUFJLENBQUMsWUFBWSxFQUFFOzs7OztjQUNmLElBQUkseUJBQU8sc0JBQXNCLEVBQUU7Ozs7eUNBR3RCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUM7OztBQUFwRCxnQkFBUTs7QUFFWiw0QkFBTyxLQUFLLGFBQVcsUUFBUSxrQ0FBK0IsQ0FBQztBQUMzRCxXQUFHLEdBQUcseUJBQVk7O0FBQ3RCLFdBQUcsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7O3lDQUNWLDBCQUFNLFVBQUMsT0FBTyxFQUFFLE1BQU0sRUFBSztBQUM1QyxhQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztTQUMvQixDQUFDOzs7QUFGRSxjQUFNOztBQUlWLDRCQUFPLEtBQUssQ0FBQyx3REFBd0QsQ0FBQyxDQUFDO0FBQ25FLFlBQUksR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQzs7QUFDcEMsNEJBQU8sS0FBSyxDQUFDLHVEQUF1RCxDQUFDLENBQUM7NENBQy9ELElBQUk7Ozs7Ozs7Q0FDWixDQUFDOztBQUVGLGVBQWMsVUFBVSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNwQyxRQUFRLEdBQVIsUUFBUTtRQUFFLE9BQU8sR0FBUCxPQUFPO3FCQUNYLFVBQVUiLCJmaWxlIjoibGliL2NvbW1hbmRzL2ZpbGUtbW92ZW1lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgZnMsIHN5c3RlbSwgbWtkaXJwIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBBZG1aaXAgZnJvbSAnYWRtLXppcCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuLy8gVE9ETzogbW9yZSBleHBsaWNpdCBlcnJvciBtZXNzYWdlIGZvciBhbGwgdGhlIGZpbGUtbW92ZW1lbnQgY29tbWFuZHNcblxuLypcbiAqICBHZXQgdGhlIGZ1bGwgcGF0aCB0byBhbiBpT1Mgc2ltdWxhdG9yIGZpbGUuXG4gKiAgQ2FsbHMgY2IoZXJyLCBmdWxsRmlsZVBhdGgpXG4gKiAgL1NvbWUvUGF0aCAgICAgICAgICAgICAgICAgICAgICAgICAgIGZldGNoZXMgYSBmaWxlIHJlbGF0aXZlIHRvIHRoZSByb290IG9mIHRoZSBkZXZpY2UncyBmaWxlc3lzdGVtLlxuICogIC9BcHBsaWNhdGlvbnMvQXBwTmFtZS5hcHAvU29tZS9QYXRoICBmZXRjaGVzIGEgZmlsZSByZWxhdGl2ZSB0byB0aGUgcm9vdCBvZiB0aGF0IEFwcGxpY2F0aW9uJ3MgLmFwcCBkaXJlY3RvcnksIGFkZGluZyBpbiB0aGUgR1VJRC5cbiAqICBTbyBpdCBsb29rcyBzb21ldGhpbmcgbGlrZTogL0FwcGxpY2F0aW9ucy9HVUlELUdVSUQtR1VJRC1HVUlEL1NvbWUvUGF0aFxuICovXG5oZWxwZXJzLmdldFNpbUZpbGVGdWxsUGF0aCA9IGFzeW5jIGZ1bmN0aW9uIChyZW1vdGVQYXRoKSB7XG4gIGxldCBiYXNlUGF0aCA9IHRoaXMuc2ltLmdldERpcigpO1xuICBsZXQgYXBwTmFtZSA9IG51bGw7XG5cbiAgaWYgKHRoaXMub3B0cy5hcHApIHtcbiAgICBsZXQgYXBwTmFtZVJlZ2V4ID0gbmV3IFJlZ0V4cChgXFxcXCR7cGF0aC5zZXB9KFtcXFxcdy1dK1xcXFwuYXBwKWApO1xuICAgIGxldCBhcHBOYW1lTWF0Y2hlcyA9IGFwcE5hbWVSZWdleC5leGVjKHRoaXMub3B0cy5hcHApO1xuICAgIGlmIChhcHBOYW1lTWF0Y2hlcykge1xuICAgICAgYXBwTmFtZSA9IGFwcE5hbWVNYXRjaGVzWzFdO1xuICAgIH1cbiAgfVxuICAvLyBkZS1hYnNvbHV0aXplIHRoZSBwYXRoXG4gIGlmIChzeXN0ZW0uaXNXaW5kb3dzKCkpIHtcbiAgICBpZiAocmVtb3RlUGF0aC5pbmRleG9mKFwiOi8vXCIpID09PSAxKSB7XG4gICAgICByZW1vdGVQYXRoID0gcmVtb3RlUGF0aC5zbGljZSg0KTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYgKHJlbW90ZVBhdGguaW5kZXhPZihcIi9cIikgPT09IDApIHtcbiAgICAgIHJlbW90ZVBhdGggPSByZW1vdGVQYXRoLnNsaWNlKDEpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChyZW1vdGVQYXRoLmluZGV4T2YoYXBwTmFtZSkgPT09IDApIHtcbiAgICBsb2dnZXIuZGVidWcoXCJXZSB3YW50IGFuIGFwcC1yZWxhdGl2ZSBmaWxlXCIpO1xuXG4gICAgbGV0IGZpbmRQYXRoID0gYmFzZVBhdGg7XG4gICAgaWYgKHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24gPj0gOCkge1xuICAgICAgLy8gdGhlIC5hcHAgZmlsZSBhcHBlYXJzIGluIC9Db250YWluZXJzL0RhdGEgYW5kIC9Db250YWluZXJzL0J1bmRsZSBib3RoLiBXZSBvbmx5IHdhbnQgL0J1bmRsZVxuICAgICAgZmluZFBhdGggPSBwYXRoLnJlc29sdmUoYmFzZVBhdGgsIFwiQ29udGFpbmVyc1wiLCBcIkJ1bmRsZVwiKTtcbiAgICB9XG4gICAgZmluZFBhdGggPSAgZmluZFBhdGgucmVwbGFjZSgvXFxzL2csICdcXFxcICcpO1xuXG4gICAgbGV0IHsgc3Rkb3V0IH0gPSBhd2FpdCBleGVjKCdmaW5kJywgW2ZpbmRQYXRoLCAnLW5hbWUnLCBhcHBOYW1lXSk7XG4gICAgbGV0IGFwcFJvb3QgPSBzdGRvdXQucmVwbGFjZSgvXFxuJC8sICcnKTtcbiAgICBsZXQgc3ViUGF0aCA9IHJlbW90ZVBhdGguc3Vic3RyaW5nKGFwcE5hbWUubGVuZ3RoICsgMSk7XG4gICAgcmV0dXJuIHBhdGgucmVzb2x2ZShhcHBSb290LCBzdWJQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIuZGVidWcoXCJXZSB3YW50IGEgc2ltLXJlbGF0aXZlIGZpbGVcIik7XG4gICAgcmV0dXJuIHBhdGgucmVzb2x2ZShiYXNlUGF0aCwgcmVtb3RlUGF0aCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnB1c2hGaWxlID0gYXN5bmMgZnVuY3Rpb24gKHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpIHtcbiAgbG9nZ2VyLmRlYnVnKGBQdXNoaW5nICR7cmVtb3RlUGF0aH0gdG8gaU9TIHNpbXVsYXRvcmApO1xuXG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiVW5zdXBwb3J0ZWQ6IGNhbm5vdCB3cml0ZSBmaWxlcyB0byBwaHlzaWNhbCBkZXZpY2VcIik7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBsZXQgZnVsbFBhdGggPSBhd2FpdCB0aGlzLmdldFNpbUZpbGVGdWxsUGF0aChyZW1vdGVQYXRoKTtcblxuICBsb2dnZXIuZGVidWcoYEF0dGVtcHRpbmcgdG8gd3JpdGUgJHtmdWxsUGF0aH0uLi5gKTtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhmdWxsUGF0aCkpIHtcbiAgICBsb2dnZXIuZGVidWcoYCR7ZnVsbFBhdGh9IGFscmVhZHkgZXhpc3RzLCBkZWxldGluZy4uLmApO1xuICAgIGF3YWl0IGZzLnVubGluayhmdWxsUGF0aCk7XG4gIH1cbiAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShmdWxsUGF0aCkpO1xuICBsZXQgY29udGVudCA9IG5ldyBCdWZmZXIoYmFzZTY0RGF0YSwgJ2Jhc2U2NCcpO1xuICBhd2FpdCBmcy53cml0ZUZpbGUoZnVsbFBhdGgsIGNvbnRlbnQpO1xuICBsb2dnZXIuZGVidWcoYFdyb3RlICR7Y29udGVudC5sZW5ndGh9IGJ5dGVzIHRvICR7ZnVsbFBhdGh9YCk7XG59O1xuXG5jb21tYW5kcy5wdWxsRmlsZSA9IGFzeW5jIGZ1bmN0aW9uIChyZW1vdGVQYXRoKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgUHVsbGluZyAke3JlbW90ZVBhdGh9IGZyb20gc2ltYCk7XG5cbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuICBsZXQgZnVsbFBhdGggPSBhd2FpdCB0aGlzLmdldFNpbUZpbGVGdWxsUGF0aChyZW1vdGVQYXRoKTtcblxuICBsb2dnZXIuZGVidWcoYEF0dGVtcHRpbmcgdG8gcmVhZCAke2Z1bGxQYXRofWApO1xuICBsZXQgZGF0YSA9IGF3YWl0IGZzLnJlYWRGaWxlKGZ1bGxQYXRoLCB7ZW5jb2Rpbmc6ICdiYXNlNjQnfSk7XG4gIHJldHVybiBkYXRhO1xufTtcblxuY29tbWFuZHMucHVsbEZvbGRlciA9IGFzeW5jIGZ1bmN0aW9uIChyZW1vdGVQYXRoKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgUHVsbGluZyAke3JlbW90ZVBhdGh9IGZyb20gc2ltYCk7XG5cbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuXG4gIGxldCBmdWxsUGF0aCA9IGF3YWl0IHRoaXMuZ2V0U2ltRmlsZUZ1bGxQYXRoKHJlbW90ZVBhdGgpO1xuXG4gIGxvZ2dlci5kZWJ1ZyhgQWRkaW5nICR7ZnVsbFBhdGh9IHRvIGFuIGluLW1lbW9yeSB6aXAgYXJjaGl2ZWApO1xuICBsZXQgemlwID0gbmV3IEFkbVppcCgpO1xuICB6aXAuYWRkTG9jYWxGb2xkZXIoZnVsbFBhdGgpO1xuICBsZXQgYnVmZmVyID0gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHppcC50b0J1ZmZlcihyZXNvbHZlLCByZWplY3QpO1xuICB9KTtcblxuICBsb2dnZXIuZGVidWcoXCJDb252ZXJ0aW5nIGluLW1lbW9yeSB6aXAgZmlsZSB0byBiYXNlNjQgZW5jb2RlZCBzdHJpbmdcIik7XG4gIGxldCBkYXRhID0gYnVmZmVyLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgbG9nZ2VyLmRlYnVnKFwiUmV0dXJuaW5nIGluLW1lbW9yeSB6aXAgZmlsZSBhcyBiYXNlNTQgZW5jb2RlZCBzdHJpbmdcIik7XG4gIHJldHVybiBkYXRhO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
